!function($){function expired(entry){var timeSince=(new Date).getTime()-entry.date.getTime();return timeSince>=1e3*60*10}R.Component.create("App",{dependencies:["App.Loading"],initialize:function(){var self=this;_.bindAll(this,"onResized","_showRefreshDialog","_checkTOS","onContentReady");R.Components.App.callSuper(this,"initialize");_.defaults(this.options,{shouldCheckTOS:false});this.history=[];this.listen(R.router,"contentChanged",this.onContentChanged);this.listen(this,"componentChanged",this.onComponentChanged);this.listen(this,"invalidate",this.onInvalidated);this.refresh=_.once(this.refresh);if(this.options.shouldCheckTOS&&!R.currentUser.isAnonymous()){R.currentUser.trackField(this.acceptedTosProperty);this.listen(this,"contentReady",this._checkTOS);this.listen(R.currentUser,"change:"+this.acceptedTosProperty,this._checkTOS)}this._setIsFirstVisit();this.listen(this,"contentReady",this.trackPageView);if(R.Api){this.listen(R.Api,"error",function(code){if(code===403){self._showRefreshDialog()}})}},trackPageView:function(){var self=this;R.Services.ready("Omniture",function(){R.Services.Omniture.onContentReady(self.isFirstVisit)});if(window.COMSCORE&&window.COMSCORE.beacon){if(this._hasRecordedPageView){window.COMSCORE.beacon({c1:"2",c2:"17393296"})}this._hasRecordedPageView=true}},hasVisitedProperty:"hasVisited",acceptedTosProperty:"acceptedTOS",termsDialogClass:"TermsDialog",_checkTOS:function(){this.stopListening(this,"contentReady",this._checkTOS);var self=this;R.Api.request({method:"getTOSVersion",success:function(response){var tosDate=response.result;R.currentUser.fetch({config:{extras:["-*",self.acceptedTosProperty]},success:function(){if(R.currentUser.has(self.acceptedTosProperty)){if(R.currentUser.get(self.acceptedTosProperty)===tosDate){self._closeTermsDialogs("TermsChangedDialog");self._closeTermsDialogs(self.termsDialogClass)}else{self._displayTermsDialog("TermsChangedDialog",tosDate)}}else if(!R.currentUser.isAnonymous()){self._displayTermsDialog(self.termsDialogClass,tosDate)}}})}});clearTimeout(this._checkTOSTimeoutId);this._checkTOSTimeoutId=_.delay(this._checkTOS,864e5)},_closeTermsDialogs:function(termsDialogClass){var TermsDialog=R.Component.getObject(termsDialogClass);if(!TermsDialog){return}var termsDialogs=_.filter(this.children,function(child){return child instanceof TermsDialog});_.each(termsDialogs,function(termsDialog){termsDialog.close()})},_displayTermsDialog:function(termsDialogClass,tosDate){var self=this;R.loader.load(termsDialogClass,function(){self._closeTermsDialogs(termsDialogClass);var TermsDialog=R.Component.getObject(termsDialogClass);self.addChild(new TermsDialog({tosDate:tosDate})).open()})},handleSessionExpired:function(){R.router.redirectExternal()},_showRefreshDialog:function(){var self=this;if(this._showingRefreshDialog){return}this._showingRefreshDialog=true;R.Utils.messageDialog({title:t("Error"),message:t("Invalid request. Did you sign in or sign out in a different tab? Refreshing may fix this issue."),buttons:[new Backbone.Model({label:t("Refresh"),className:"blue",callback:function(){this.close();self.handleSessionExpired()}})],onClose:function(){self._showingRefreshDialog=false}})},_setIsFirstVisit:function(){if(R.currentUser.isAnonymous()){return false}this.isFirstVisit=!R.currentUser.get("prefs").get(this.hasVisitedProperty);if(this.isFirstVisit){R.currentUser.get("prefs").save(this.hasVisitedProperty,true)}},onDetached:function(){R.currentUser.untrackField(this.acceptedTosProperty);$(window).off("resize",this.onResized)},onDestroyed:function(){if(this.loading){this.loading.destroy()}this.history=null;this.currentContent=null},onInserted:function(){$(window).on("resize",this.onResized);this.onResized()},onResized:function(){this.sizeContent();this.trigger("resize")},createChildComponents:function(){this.loading=new R.Components.App.Loading},onRendered:function(){if(!this.$content){this.$content=$('<div class="app_content" />');this.$el.append(this.$content)}this.content=this.$content},_isContentInHistory:function(){return _.isObject(this.getHistoryObject(Backbone.history.getFragment()))},_insertContentFromHistory:function(){var historyObj=this.getHistoryObject(Backbone.history.getFragment());this.history=_.without(this.history,historyObj);this.saveHistory(this.currentContent);if(this.currentContent){this.currentContent.$el.hide();this.currentContent.detach()}this.currentContent=historyObj.component;this.updatePageInfo();this.currentContent.$el.show();this.currentContent.insert();this.sizeContent();this.content.scrollTop(historyObj.scrollPosition);this.updateContainersForCurrentContent();this.trigger("contentReady")},_addCurrentContentListeners:function(){this.listen(this.currentContent,"componentChanged",this.onComponentChanged);this.listen(this.currentContent,"contentUpdated",this.updatePageInfo)},_insertNewContent:function(){var self=this;self.currentContent.url=Backbone.history.getFragment();self.insertCurrentContentIntoDom();self.updateContainersForCurrentContent();self.content.scrollTop(0);self.trigger("newContent");self.updatePageInfo();if(self.currentContent.getReadyPromise){var promise=self.currentContent.getReadyPromise();promise.done(self.onContentReady)}else{self.listen(self.currentContent,"insert",self.onContentReady)}},onContentReady:function(){this.stopListening(this.currentContent,"insert");this.trigger("contentReady");if(R.isPhantom){_.defer(function(){alert("contentReady")},100)}},insertCurrentContentIntoDom:function(){this.$content.append(this.currentContent.el)},updateContainersForCurrentContent:R.doNothing,onContentChanged:function(newComponent,urlMatches,componentOptions){if(this._willBeDestroyed){return}var self=this;var loadingUrl;console.log("using component:",newComponent);this._hideLoading();if(self._isContentInHistory()){self._insertContentFromHistory();return}self.trigger("contentChanged");if(self.currentContent){self.saveHistory(self.currentContent);self.currentContent.$el.hide();self.currentContent.detach()}loadingUrl=Backbone.history.getFragment();self._showLoading();R.loader.load([newComponent],function(){var constructor=R.Component.getObject(newComponent);var queryStringParams=R.Utils.getQueryStringParams(window.location);componentOptions=_.extend(componentOptions||{},{urlMatches:urlMatches,queryStringParams:queryStringParams});self.currentContent=new constructor(componentOptions);var contentTimer=R.stats.createTimer(["renderPage",newComponent]);self.trigger("pageTimer",contentTimer);if(!self.currentContent.handleFetchError){self.listen(self.currentContent,"fetchError",self.onContentFetchError)}self.currentContent.ensureModel(function(){if(Backbone.history.getFragment()===loadingUrl){self.currentContent.render(function(){contentTimer.stop();self.currentContent=self.addChild(self.currentContent);self._addCurrentContentListeners();self._hideLoading();self._insertNewContent()})}})})},_showLoading:function(){var self=this;var done=function(){self.loading.start();self.loading.$el.show()};if(self.loading.isRendered()){done()}else{self.loading.render(function(){self.$content.append(self.loading.el);done()})}},_hideLoading:function(){this.loading.stop();this.loading.$el.hide()},updatePageInfo:function(){this._setTitle();this._applyAdditionalHeadTags()},sizeContent:R.doNothing,getBoundaryEl:function(){return this.$content&&this.$content.length?this.$content:this.$el},contentBoundingBox:function(){var $boundary=this.getBoundaryEl();var offset=$boundary.offset();var height=$boundary.height();var width=$boundary.width();_.extend(offset,{bottom:offset.top+height,right:offset.left+width,height:height,width:width});return offset},viewportHeight:function(){return $(window).height()},$content:null,extraHeadTags:null,title:function(){var newTitle=R.serverInfo.get("product_name");if(this.currentContent&&this.currentContent.pageTitle){newTitle=this.currentContent.pageTitle+" â€“ "+newTitle}return newTitle},_setTitle:function(){document.title=this.title()},_getCurrentUrl:function(){var loc=window.location;return loc.protocol+"//"+loc.host+loc.pathname},_applyAdditionalHeadTags:function(){$("head meta[property]").remove();$("head link[rel=canonical]").remove();$("head meta[name^=msapplication]").remove();var metaTags=[{"twitter:site":R.serverInfo.get("twitterName")},{"twitter:app:id:iphone":R.serverInfo.get("iosAppId")},{"twitter:app:id:ipad":R.serverInfo.get("iosAppId")},{"twitter:app:id:googleplay":R.serverInfo.get("androidAppId")},{"fb:app_id":R.serverInfo.get("fbid")},{"og:site_name":R.serverInfo.get("product_name")}];if(this.currentContent.getMetaTags){metaTags=metaTags.concat(this.currentContent.getMetaTags())}var tagsHtml=[];_.each(metaTags,function(tag){_.each(tag,function(value,key){value=String(value);tagsHtml.push('<meta property="'+key+'" content="'+value+'" />')})});var escapedCurrentUrl=Bujagali.Utils.escape(this._getCurrentUrl());tagsHtml.push('<link rel="canonical" href="'+escapedCurrentUrl+'" />');var extraHeadTags=R.Utils.value(this.extraHeadTags);if(extraHeadTags){tagsHtml=tagsHtml.concat(extraHeadTags)}var metadata=tagsHtml.join("\n");$("head").prepend(metadata)},saveHistory:function(component){if(!component||!component.cache||component.invalidated){return}var historyObj=this.getHistoryObject(component.url);if(historyObj){var idx=_.indexOf(this.history,historyObj);this.history.splice(idx,1)}else{historyObj={url:component.url,component:component,date:new Date}}historyObj.scrollPosition=this.content.scrollTop();this.history.unshift(historyObj);this._pruneHistory()},_pruneHistory:function(){for(var i=0;i<this.history.length;i++){if(expired(this.history[i])){this.history[i].component.destroy();this.history.splice(i,1);i--}}if(this.history.length>5){var deadHistory=this.history.pop();deadHistory.component.destroy()}},getAppEl:function(){return this.el},getContainer:function(){if(!this.content){throw new Error("getContainer called on App before onRendered.")}return this.content},getHistoryObject:function(url){return _.find(this.history,function(h){if(h.url===url&&!expired(h)){return true}})},onComponentChanged:function(e){var self=this;if(e.component===this){R.Utils.stopEvent(e);R.reload();return}_.each(this.history,function(entry,i){if(e.currentComponent===entry.component){self.history.splice(i,1);entry.component.destroy()}});this.refresh();R.Utils.stopEvent(e)},refresh:function(){try{R.app=new this.constructor;this.trigger("refresh",R.app);R.Services.trigger("appCreated",R.app);this.destroy();var loadTimer=_.delay(function(){R.reload()},2e3);R.app.render(function(){if(!R.Services.TESTING){Backbone.history.loadUrl()}$("body").append(R.app.el);clearTimeout(loadTimer)})}catch(e){R.Utils.logException("Could not refresh app",e);R.reload()}},onContentFetchError:function(model,response){var onFetchError=this.currentContent.onFetchError;if(response&&response.code!==404){if(response.statusText==="abort"){return}onFetchError="NotFound.Error"}R.router.routeNotFound(onFetchError)},onInvalidated:function(e){var self=this;_.each(this.history,function(h,i){if(h.component.cid===e.targetComponent.cid){self.history.splice(i,1);h.component.destroy()}});R.Utils.stopEvent(e)}})}(R.$);
//# sourceMappingURL=/media/client/orig/Components/App.faa48b7db1632d6713d4a8f7381a305e.js.map