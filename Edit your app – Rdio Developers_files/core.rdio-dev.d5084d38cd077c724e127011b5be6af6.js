!function(serverInfo){var root=this;var loadTime=(new Date).getTime();if(typeof R=="undefined"){R={}}$.extend(R,{truncate:function(str,len){if(!str){return""}if(str.length<=len){return str}return str.substring(0,len)+"..."},isDesktop:/com.rdio.desktop/.test(navigator.userAgent.toLowerCase()),isMacDesktop:/com.rdio.desktop.mac/.test(navigator.userAgent.toLowerCase()),isWinDesktop:/com.rdio.desktop.win/.test(navigator.userAgent.toLowerCase()),usesNewHeader:/com.rdio.desktop.new_header/.test(navigator.userAgent.toLowerCase()),doNothing:function(){},injectScript:function(src,root,onLoad,onError){if(!src){throw"Trying to inject an empty script into the page"}var headEl=document.getElementsByTagName("head")[0];var script=document.createElement("script");var basePath=src;if(src.indexOf("//")===-1){basePath="//"+R.getCDNForResource(src)+src}script.type="text/javascript";script.src=basePath;script.async=true;if(onLoad){script.onload=script.onreadystatechange=function(){if(script.readyState&&script.readyState!="complete"&&script.readyState!="loaded"){return}script.onload=script.onreadystatechange=null;onLoad(src)}}if(onError){script.onerror=onError}if(root){root.appendChild(script)}else{headEl.appendChild(script)}return script},fbInit:function(enableMusic,callback){var channelUrl="https://"+document.location.host+"/fb_channel.html",locale,src;window.fbAsyncInit=function(){FB.init({appId:serverInfo().fbid,status:true,cookie:true,xfbml:true,music:!!enableMusic,channelUrl:channelUrl});if(callback&&typeof callback=="function"){callback()}};src="https://connect.facebook.net/"+serverInfo().fbLocale+"/all/vb.js";this.injectScript(src,$("#fb-root")[0])},enableLogging:function(){serverInfo().debug=true;if(typeof getPlayer!="undefined"&&getPlayer()){getPlayer()._enableLogging()}},templateViews:{},isStation:function(obj){if(!obj){return false}var stationTypes=R.serverInfo.get("stationTypes");var type;if(_.isString(obj)){type=obj}if(obj.type){type=obj.type}else if(obj.has&&obj.has("type")){type=obj.get("type")}if(!type){return false}return _.contains(stationTypes,type)},isEpisodeBonusContent:function(obj){if(!obj){return false}if(obj instanceof Backbone.Model){obj=obj.attributes}return obj.type==="ver"&&!!obj.isBonusContent},changeLocale:function(newLocale){R.Api.request({method:"changeLocale",content:{locale:newLocale},success:function(){document.location.reload()}})},reload:typeof _!="undefined"?_.once(function(){var now=new Date;console.log("Reloading!");if(R.Services.TESTING){console.log("Just Kidding. Disregard the above");if(R.isPhantomTest){window.alert("stdout \nCancelled reload\n")}return}if(loadTime+6e4>now.getTime()){_.delay(function(){window.location.reload()},3e3)}else{window.location.reload()}}):window.location.reload,Components:{},Models:{},Mixins:{},isMaster:false,serverInfo:new Backbone.Model(Env.serverInfo),VERSION:Env.VERSION,$:Backbone.$});if(!String.prototype.trim){String.prototype.trim=function(){return $.trim(this)}}if(!Date.now){Date.now=function(){return+new Date}}}(function(){return R.serverInfo?R.serverInfo.attributes:server_info});!function(){var _verbosity="all";R.logger={_originalLog:_.isUndefined(window.console)?R.doNothing:console.log,_originalWarn:_.isUndefined(window.console)?R.doNothing:console.warn,_originalError:_.isUndefined(window.console)?R.doNothing:console.error,logQueue:[],_log:function(args,method,sendToConsole){args[0]="["+Date()+"] "+args[0];this.logQueue.unshift(args.join(" "));if(this.logQueue.length>=10){this.logQueue.pop()}if(!sendToConsole){return}try{if(jQuery.browser.msie){method(args[0])}else{method.apply(console,args)}}catch(e){}},log:function(){this._log(_.toArray(arguments),this._originalLog,_verbosity==="all")},warn:function(){this._log(_.toArray(arguments),this._originalWarn,_verbosity!=="none"&&_verbosity!=="errors")},error:function(){this._log(_.toArray(arguments),this._originalError,_verbosity!=="none")},verbosity:function(level){if(_.isUndefined(level)){return _verbosity}else{if(level==="all"||level==="warnings"||level==="errors"||level==="none"){_verbosity=level}else{this._originalError("Invalid argument passed to R.logger.verbosity()")}}},ensureConsole:function(){var boundLog=_.bind(R.logger.log,R.logger);var boundWarn=_.bind(R.logger.warn,R.logger);var boundError=_.bind(R.logger.error,R.logger);if(_.isUndefined(window.console)){window.console={}}_.defaults(console,{log:boundLog,info:boundLog,warn:boundWarn,error:boundError,exception:boundError,assert:function(condition,message){if(!condition){this.error("Assertion failed: "+message)}},dir:R.doNothing,time:R.doNothing,timeEnd:R.doNothing,trace:R.doNothing});if(R.serverInfo.get("prod")){_.extend(window.console,{log:boundLog,info:boundLog,warn:boundWarn,error:boundError,exception:boundError})}}};R.logger.ensureConsole()}();!function(root){function Validator(){this.initialize.apply(this,arguments)}_.extend(Validator.prototype,{options:{},messages:{},initialize:function(options){this.options=_.extend({},this.options,options);if(this.options.messages){this.messages=_.extend({},this.messages,this.options.messages);delete this.options.messages}var notDefined=[];_.each(this.messages,function(message,key){if(message===null){notDefined.push(key)}});if(notDefined.length){var keys=notDefined.join(", ");throw new TypeError("Missing validation messages for keys: "+keys)}},check:function(value){return this.resolve()},error:function(value,type){var message=this.messages[type];if(_.isFunction(message)){message=message(value,this.options)}return{type:type,message:message,value:value}},reject:function(value,type){return $.Deferred().reject(this.error(value,type)).promise()},resolve:function(){return $.Deferred().resolve().promise()}});Validator.create=function(props){props=props||{};var ctor=function(){Validator.apply(this,arguments)};_.extend(ctor.prototype,Validator.prototype);if(props.options){_.extend(ctor.prototype.options,props.options);delete props.options}_.extend(ctor.prototype,props);return ctor};Validator.extend=function(base,props){var ctor=function(){this.initialize.apply(this,arguments)};_.extend(ctor.prototype,base.prototype,props);return ctor};var Validators={};Validators.NotEmpty=Validator.create({messages:{empty:null},check:function(value){if(_.isNumber(value)){return this.resolve()}else{return _.isEmpty(value)?this.reject(value,"empty"):this.resolve()}}});Validators.RegExp=Validator.create({options:{pattern:/.*/},check:function(str){if(this.options.pattern.test(str)){return this.resolve()}else{return this.reject(str,"invalid")}}});Validators.Email=Validator.extend(Validators.RegExp,{options:{pattern:/.+@.+\..+/},messages:{invalid:null}});Validators.Length=Validator.create({options:{min:0,max:Infinity},messages:{min:null,max:null},check:function(value){var length=_.size(value);if(length<this.options.min){return this.reject(value,"min")}if(length>this.options.max){return this.reject(value,"max")}return this.resolve()}});Validators.StringLength=Validator.extend(Validators.Length,{messages:{min:null,max:null}});Validators.Equals=Validator.create({messages:{notEqual:null},initialize:function(cmp,options){options=options||{};options.cmp=cmp;Validator.prototype.initialize.call(this,options)},check:function(value){if(_.isEqual(value,this.options.cmp)){return this.resolve()}return this.reject(value,"notEqual")}});_.extend(R,{Validator:Validator,Validators:Validators})}(this);!function(){var root=this;function logLessError(err){console.error("Could not parse ",err.filename+":",err.message,err)}R.StyleManager={_inProgressCss:{},loadComponentLess:function(component,lessText){var env={filename:component+".less"};if(!root.less){throw new Error("Less.js is not loaded, cannot parse Less!")}try{new less.Parser(env).parse(lessText,function(err,tree){if(err){logLessError(err);return}R.StyleManager.loadComponentCss(component,tree.toCSS())})}catch(exc){logLessError(exc)}},commitCss:function(components){var self=this;var css=_.reduce(components,function(css,component){var componentCss=self._inProgressCss[component];if(componentCss&&_.isString(componentCss)){css.push(componentCss);self._inProgressCss[component]=true}return css},[]);if(!css.length){return}var cssText=css.join("\n");if(document.createStyleSheet){return R.StyleManager._ieLoadCss(cssText)}var textNode;var id=_.uniqueId("component_css");var styleEl=R.StyleManager._createStyleEl(id);textNode=document.createTextNode(cssText);styleEl.appendChild(textNode);return id},loadComponentCss:function(component,cssText){if(cssText&&!this._inProgressCss[component]){this._inProgressCss[component]=cssText}},_createStyleEl:function(id){var styleEl=document.createElement("style");styleEl.type="text/css";styleEl.media="screen";styleEl.id=id;document.getElementsByTagName("head")[0].appendChild(styleEl);return styleEl},_ieLoadCss:function(cssText){var id="css_for_components";var styleEl=document.getElementById(id);if(!styleEl){styleEl=R.StyleManager._createStyleEl(id)}styleEl.styleSheet.cssText+=cssText;return id},reset:function(){this._inProgressCss={}}}}();!function($){var bgProto=Bujagali.View.prototype;var externalRe=/^(http[s]?:)?\/\//;R.Component=Bujagali.View.extend({dependencies:[],libraries:[],requiredFields:[],cache:true,onFetchError:"NotFound",handleFetchError:false,getReadyPromise:null,constructor:function(options){options=options||{};if(this.options){options=_.extend({},R.Utils.value(this.options),options)}this.options=options;return Bujagali.View.apply(this,arguments)},initialize:function(options){if(options&&options.extraClassName){$(this.el).addClass(options.extraClassName)}this._eventHandlers=[];this._addedRequiredFields=false;if(this.initialState&&!this.states||!this.initialState&&this.states){throw new Error("[Component] Both initialState and states required for state machine")}if(this.initialState){this._setupStateMachine()}this.listen(R.loader,"loaded:"+this._name,this._componentChanged);var superClass=this.superClass&&R.Component.getObject(this.superClass);while(superClass){this.listen(R.loader,"loaded:"+superClass._name,this._componentChanged);superClass=superClass.superClass&&R.Component.getObject(superClass.superClass)}bgProto.initialize.apply(this,arguments);if(this.model){this._onModelCreated()}},mixin:function(mixin,options){var self=this;if(!mixin){throw new Error("Mixin not defined")}_.each(mixin,function(method,methodName){if(!self[methodName]){self[methodName]=method}else{var originalCall=self[methodName];var newCall=method;self[methodName]=function(){originalCall.apply(this,arguments);newCall.apply(this,arguments)}}});if(mixin.className){$(this.el).addClass(mixin.className)}if(mixin.onMixin){mixin.onMixin.call(this,options||{})}},listen:function(object,eventName,eventHandler){if(!object||!object.bind||!this._eventHandlers){return}this._eventHandlers.push([object,eventName,eventHandler]);object.bind(eventName,eventHandler,this)},stopListening:function(object,eventName,eventHandler){var self=this;_.each(self._eventHandlers,function(handler,i){if(object==handler[0]){if(eventName&&eventName==handler[1]){if(eventHandler&&eventHandler==handler[2]){self._removeEventHandler(handler)}else if(!eventHandler){self._removeEventHandler(handler)}}else if(!eventName){self._removeEventHandler(handler)}}})},callback:function(method){var args=_.tail(arguments);var self=this;return function(){if(self.isDestroyed()){return}args=args.concat(_.toArray(arguments));return method.apply(self,args)}},bubbleEvent:function(eventName,event){var component=this;var args=_.toArray(arguments);if(_.isUndefined(event)){event=$.Event();args[1]=event}event.targetComponent=this;while(component&&!event.isPropagationStopped()){event.currentComponent=component;component.trigger.apply(component,args);component=component.parent()}return!event.isDefaultPrevented()},_removeEventHandler:function(handler,i){handler[0].unbind(handler[1],handler[2],this);delete this._eventHandlers[i]},_componentChanged:function(){var e=$.Event();e.component=this;if(this.bubbleEvent("componentChanged",e)){this.destroy()}},ensureModel:function(k){var self=this;var hadMissingFields;var shouldFetch;k=k||R.doNothing;if(self.model||!(self.modelClass||self.modelFactory)){self._verifyModelType();if(self.model&&self._addModelFields()&&self._shouldFetch()){self._fetchModel(k)}else{k()}return}var modelFactory=self.modelFactory,modelClass=self.modelClass;if(modelFactory){self.model=modelFactory.call(self)}else if(modelClass&&_.isFunction(modelClass)){self.model=new modelClass}self._verifyModelType();hadMissingFields=self._addModelFields();shouldFetch=self._shouldFetch();if(hadMissingFields&&!shouldFetch){console.warn("Warning: component had missing fields, but not fetching")}if(shouldFetch){self._fetchModel(function(){self._onModelCreated();k()})}else{self._onModelCreated();k()}},_shouldFetch:function(){var isShouldFetchDefined=!_.isUndefined(this.model.shouldFetch);var shouldFetch=R.Utils.value.call(this.model,this.model.shouldFetch);return isShouldFetchDefined&&shouldFetch||!isShouldFetchDefined&&this.model.method},_onModelCreated:function(){if(_.isFunction(this.model.reference)){this.model.reference()}this.onModelCreated()},_addModelFields:function(){if(this.requiredFields.length>0&&!this._addedRequiredFields){var hadMissingFields=_.difference(this.requiredFields,this.model.getAllFields()).length>0;this.model.addFieldRefs(this.requiredFields);this._addedRequiredFields=true;return hadMissingFields}return false},_fetchModel:function(k){var self=this;self.pendingFetch=self.model.fetch({success:function(model,response){self.pendingFetch=null;k()},error:function(model,response){self.pendingFetch=null;self.trigger("fetchError",model,response);if(response&&response.statusText){console.error("Request failed: "+response.statusText)}else{console.error("Request failed")}if(self.handleFetchError){k()}},silent:true})},isType:function(obj,type){return obj instanceof type},_verifyModelType:function(){var self=this,modelClass=self.modelClass,model=self.model;if(modelClass&&model){if(_.isFunction(modelClass)&&!self.isType(model,modelClass)){throw new TypeError("Model is not correct type")}else if(_.isArray(modelClass)){var ok=_.any(modelClass,function(klass){return self.isType(model,klass)});if(!ok){throw new TypeError("Model is not correct type")}}}},render:function(k,isSubtree){if(this._willBeDestroyed){return k?k():null}if(this.ensureModel){this.ensureModel(_.bind(this._readyToRender,this,k,isSubtree))}else{this._readyToRender(k,isSubtree)}return this},_readyToRender:function(k,isSubtree){var self=this;if(this._renderLock){throw new Error("Render called while rendering!")}this._renderLock=true;_.each(this.children,function(child){child.destroy()});this.children=[];if(this.createChildComponents){this.createChildComponents()}this._executeTemplate().then(function(){return self._renderAllChildren()}).then(function(){return self._ensureTemplateStateUpdated()}).done(function(){var nameForErrorReport=self._name;if(self.onRendered){R.Utils.reportErrors(function(){self.onRendered(this.model)},nameForErrorReport)()}if(k){R.Utils.reportErrors(k,nameForErrorReport)()}self.trigger("render",this.model);if(!isSubtree){if(self.isRendered()||self._inserted){_.each(self.children,function(child){child.insert()})}else if(!self.parent()||self.parent().isInserted()){self.insert()}}self._rendered=true;self._renderLock=false})},_executeTemplate:function(){var templateExecuted=$.Deferred();bgProto.render.call(this,{data:this.model||new Backbone.Model},function(){templateExecuted.resolve()});return templateExecuted},_renderAllChildren:function(){var self=this;return $.when.apply($,_.map(this.children,function(child){var childRendered=$.Deferred();child.render(function(){self._insertChildEl(child);childRendered.resolve()},true);return childRendered}))},_ensureTemplateStateUpdated:function(){if(this._stateMachine&&this.monad){return this._updateTemplate(this.currentState())}else{return $.Deferred().resolve()}},_insertChildEl:function(child){var containerId=child.containerId;var el;if(containerId){el=this.$("#"+containerId);if(el){el.replaceWith(child.el)}}},addChildFromTemplate:function(containerId,child,options){if(!child){console.error("tried to add a null component in "+this.monad.name)}child.containerId=containerId;if(!_.contains(this.children,child)){this.addChild(child)}if(options&&options.inStateSection){if(!this._stateSpecificChildren){this._stateSpecificChildren=[]}this._stateSpecificChildren.push(child)}},addChild:function(child){child._parent=this;if(this.children){this.children.push(child)}else{console.warn("adding child to destroyed component")}return child},removeChild:function(child){this.children=_.without(this.children,child);child._parent=null;return child},parent:function(){return this._parent},renderNewChild:function(child,selector,k,options){if(!child){throw new TypeError("Cannot render a null child")}var self=this;k=k||R.doNothing;self.addChild(child);child.render(function(){var method=options&&options.where?options.where:"append";var $el=self.$el;if(selector&&selector!==self.$el){$el=self.$(selector)}$el[method](child.el);self.trigger("childRender",child);k()});return child},insert:function(){if(this._inserted){return this}this._inserted=true;_.each(this.children,function(child){child.insert()});if(this.onInserted){this.onInserted()}this.trigger("insert",this);return this},remove:function(){if(this._parent){this._parent.removeChild(this)}bgProto.remove.apply(this,arguments);if(this.isInserted()){this.onDetached()}},detach:function(){if(!this._inserted){return}this._inserted=false;_.each(this.children,function(child){child.detach()});if(this.onDetached){this.onDetached()}this.trigger("detach",this);return this},destroy:function(parentDying){var self=this;if(!this._willBeDestroyed){this._willBeDestroyed=true;if(!parentDying){this.detach();this.remove()}_.each(this.children,function(child){child.destroy(true)});this.children=null;this._parent=null;if(this.monad){this.monad.view=null;this.monad=null}this.trigger("destroy",this);_.defer(function(){if(self._destroyed){return}self._destroyed=true;_.each(self._eventHandlers,function(args){args[0].unbind(args[1],args[2],self)});self._eventHandlers=null;self.onDestroyed();self.unbind();$(self.el).unbind();if(self.options){self.options=null}if(self.model){if(self._addedRequiredFields){self.model.removeFields(self.requiredFields)}if(_.isFunction(self.model.release)){self.model.release()}self.model=null}if(self.pendingFetch){self.pendingFetch.abort();self.pendingFetch=null}self._destroyComplete=true})}},isRendered:function(){return!!this._rendered},isInserted:function(){return!!this._inserted},isDestroyed:function(){return this._destroyed},isDestroyComplete:function(){return this._destroyComplete},invalidate:function(){var event=$.Event();this.invalidated=true;this.bubbleEvent("invalidate",event)},findChild:function(filterFunc){return _.find(this.children,filterFunc)},findChildWithModel:function(model){return this.findChild(function(child){return child.model===model})},eachDescendant:function(f){var queue=_.clone(this.children);var found=[];var child;while(!_.isEmpty(queue)){child=queue.shift();if(_.isObject(child)){f(child)}if(_.isArray(child.children)){queue=queue.concat(child.children)}}},findAllChildren:function(filterFunc){var found=[];this.eachDescendant(function(descendant){if(filterFunc(descendant)){found.push(descendant)}});return found},invokeChildren:function(childClass,method){var args=_.rest(arguments,2);if(_.isString(childClass)){childClass=R.Component.getObject(childClass)}var children=_.each(this.children,function(ch){if(ch instanceof childClass){ch[method].apply(ch,args)}})},transition:function(newState){if(!this._stateMachine){throw new Error("[Component] Can't transition, component has no state machine.")}if(this._stateMachine.currentState==="transitioning"){console.error("[Component] Can't transition, transition in progress");return $.Deferred().reject().promise()}var finishTransition=this._stateMachine.transitionAsync(newState);if(this.monad&&this.isRendered()){this._updateTemplate(newState).done(function(){finishTransition.resolve()})}else{finishTransition.resolve()}return finishTransition.promise()},currentState:function(){if(!this._stateMachine){throw new Error("[Component] No state machine exists, can't get current state")}return this._stateMachine.currentState},inState:function(sectionId,stateNames,sectionFunc){if(!this._stateSections){this._stateSections={}}if(!this._stateSections[stateNames]){this._stateSections[stateNames]={}}this._stateSections[stateNames][sectionId]=sectionFunc},_setupStateMachine:function(){var stateNames=_.map(this.states,function(state){return _.isObject(state)?state.name:state});this._stateMachine=new R.StateMachine({initialState:this.initialState,states:stateNames});var stateObjects=_.filter(this.states,_.isObject);var initialStateObject=_.find(stateObjects,function(state){return state.name===this.initialState},this);if(initialStateObject){_.each(["onEntering","onEntered"],function(delegateName){var methodName=initialStateObject[delegateName];if(methodName){this[methodName]()}},this)}var getDelegateEventMappings=function(stateName){return[{delegateName:"onEntering",evt:"before:->"+stateName},{delegateName:"onEntered",evt:"after:->"+stateName},{delegateName:"onLeaving",evt:"before:"+stateName+"->"},{delegateName:"onLeft",evt:"after:"+stateName+"->"}]};_.each(stateObjects,function(stateObj){_.each(getDelegateEventMappings(stateObj.name),function(mapping){var methodName=stateObj[mapping.delegateName];if(methodName){this.listen(this._stateMachine,mapping.evt,this[methodName])}},this)},this)},_updateTemplate:function(newState){_.each(this._stateSpecificChildren,function(child){this.removeChild(child);child.$el.remove()},this);delete this._stateSpecificChildren;this._updateStateSections(newState);var self=this;var deferredChildRenders=_.map(this._stateSpecificChildren,function(child){var childRendered=$.Deferred();var finishChild=function(){self._insertChildEl(child);child.delegateEvents();child.eachDescendant(function(descendant){descendant.delegateEvents()});childRendered.resolve()};if(!child.isRendered()){child.render(finishChild)}else{finishChild()}return childRendered});return $.when.apply($,deferredChildRenders).promise()},_updateStateSections:function(targetState){_.each(this._stateSections,function(templateSections,stateNames){_.each(templateSections,function(compiledSectionFunc,containerId){var content="";var emitForSection=function(more){content+=more.join("").trim()};if(_.contains(stateNames.split(" "),targetState)){compiledSectionFunc(this.monad,this.model,this.options,emitForSection)}this.$("#"+containerId).html(content)},this)},this)},onModelCreated:R.doNothing,createChildComponents:R.doNothing,onRendered:R.doNothing,onInserted:R.doNothing,onDetached:R.doNothing,onModelRemoved:R.doNothing,onDestroyed:R.doNothing},{create:function(fullName,properties,classProperties){var deps=properties.dependencies;var libs=R.Utils.value(properties.libraries);var path=fullName.split(".");var name=_.last(path);var templateName=["client/Components/",path.join("/"),"/",name,".bg.html"].join("");var hasTemplate=Bujagali.fxns[templateName]?true:false;var className=path.join("_");properties=_.extend({template:hasTemplate?templateName:null,_name:fullName,superClass:R.Component},properties);var loadingExternalScripts=R.loader.loadExternalScripts(libs);var loadingDeps=R.loader.load(deps,function(){var superClass=properties.superClass;if(_.isString(superClass)){properties.superClass=R.Component.getObject(superClass);superClass=properties.superClass}var ctor=superClass;while(ctor!=R.Component){className=ctor.prototype.className+" "+className;ctor=ctor.prototype.superClass}properties.className=properties.className?className+" "+properties.className:className;var namespace=R.Component.getObject(_.initial(path),true);var componentClass=superClass.extend(properties,classProperties);if(namespace[name]){_.extend(componentClass,namespace[name])}namespace[name]=componentClass},false,fullName);$.when(loadingExternalScripts,loadingDeps).done(function(){R.loader.loaded(fullName)})},getObject:function(path,createAsResolved){var i,sub,pointer=R.Components;if(_.isString(path)){path=path.split(".")}for(i=0;i<path.length;i++){sub=path[i];if(createAsResolved&&!pointer[sub]){pointer[sub]={}}pointer=pointer[sub];if(!pointer){return null}}return pointer},callSuper:function callSuper(self,method){var args;if(arguments.length>=3){args=_.toArray(arguments).slice(2)}else{args=(callSuper.caller||arguments.callee.caller).arguments}return this.prototype.superClass.prototype[method].apply(self,args)}})}(R.$);!function(){var root=this;if(!_.isObject(root.R)){root.R={}}var R=root.R;if(!R.doNothing){R.doNothing=function(){}}var BaseService=function(options){this.options=options||{};this._readyState=R.Services.STATE_NOT_READY;this.initialize();this.trigger("initialized")};BaseService.extend=Backbone.View.extend;_.extend(BaseService.prototype,Backbone.Events,{isGlobal:false,initialize:function(){this.onInitialized()},onInitialized:R.doNothing,isReady:function(){return this._readyState==R.Services.STATE_READY},onStarted:function(k){k()},onStopping:R.doNothing,onStopped:R.doNothing,isUsable:function(){return true},getCaps:R.doNothing,_setReadyState:function(newState){if(this._readyState===newState){return}switch(newState){case R.Services.STATE_READY:var self=this;var k=function(){self._readyState=newState;if(self.isReady()){console.log("[Services] "+self._name+" is ready");self.trigger("ready");R.Services.trigger(self._name+":ready")}};this.onStarted(k);break;case R.Services.STATE_STOPPED:this.onStopped();this._readyState=newState;break;case R.Services.STATE_STOPPING:this.onStopping();this._readyState=newState;break;default:console.error("Unable to handle new ready state: ",newState);break}}});R.Services={};_.extend(R.Services,Backbone.Events,{_serviceKlasses:{},_activeServices:{},register:function(name,props,options){var klass=BaseService.extend(props);R.recordEvent("service:"+name,+"registered");options=options||{};_.defaults(options,{priority:this._serviceKlasses[name]?this._serviceKlasses[name].length+1:1,id:_.uniqueId()});klass.prototype._name=name;klass.prototype.__options=options;if(this._serviceKlasses[name]&&this._serviceKlasses[name].length){if(klass.prototype.isGlobal!==this._serviceKlasses[name][0].prototype.isGlobal){throw new Error("[Services] all implementations of "+name+" must agree on isGlobal")}this._serviceKlasses[name].push(klass)}else{this._serviceKlasses[name]=[klass]}},unregister:function(name){R.recordEvent("service:"+name,"unregistered");this.stop(name);delete this._serviceKlasses[name]},start:function(names,optionsMap){optionsMap=optionsMap||{};names=names?R.Utils.array(names):_.keys(this._serviceKlasses);var servicesToStart=_.map(names,function(name){if(this._activeServices[name]){console.log("Service named "+name+" already started")}else{if(!this._serviceKlasses[name]){console.log("No service named ",name);return}this._createService(name,optionsMap[name]);return name}},this);var deferreds=[];_.each(servicesToStart,function(serviceName){if(serviceName&&this._activeServices[serviceName].isUsable()){R.recordEvent("service:"+serviceName,"ready");this._activeServices[serviceName]._setReadyState(this.STATE_READY);deferreds.push(this.ready(serviceName))}},this);return $.when.apply($,deferreds)},stop:function(name){var self=this;var servicesToStop=name?[name]:_.keys(this._serviceKlasses);var servicesStopping=[];_.each(servicesToStop,function(name){if(self._activeServices[name]&&self._activeServices[name].isReady()){R.recordEvent("service:"+name,"stopping");self._activeServices[name]._setReadyState(self.STATE_STOPPING);servicesStopping.push(name)}});_.each(servicesStopping,function(name){R.recordEvent("service:"+name,"stopped");self._activeServices[name]._setReadyState(self.STATE_STOPPED)});_.each(servicesToStop,function(name){self._deleteReferences(name)})},ready:function(name,k){var deferred=$.Deferred();if(this._activeServices[name]&&this._activeServices[name].isReady()){deferred.resolve()}else{this.once(name+":ready",function(){deferred.resolve()})}return deferred.done(k||R.doNothing).promise()},getCaps:function(){var self=this;function combine(a,b){_.each(b,function(v,k){if(k in a){if(_.isObject(v)&&_.isObject(a[k])){combine(a[k],v)}else{throw new Error("[Services] getCaps collision on "+k+" combining "+v+" and "+a[k])}}else{a[k]=v}})}var caps={};_.each(this._serviceKlasses,function(klass,name){if(self._activeServices[name]&&self._activeServices[name].isUsable()){var serviceCaps=self._activeServices[name].getCaps();if(serviceCaps){combine(caps,serviceCaps)}}});return caps},_createService:function(name,options){var klasses=_.sortBy(this._serviceKlasses[name],function(k){return R.Utils.value(k.prototype.__options.priority)});var impl=null;for(var i=0;i<klasses.length;i++){impl=new klasses[i](options);if(impl.isUsable()){break}}if(impl===null){console.error("Unable to find a usable implementation for service: "+name);return}R.recordEvent("service:"+name,"created");var self=this;impl.on("remove",function(){console.log("[Services] A service implementation of type "+name+" failed and asked to be removed, doing so now");self._serviceKlasses[name]=_.reject(self._serviceKlasses[name],function(klass){return klass.prototype.__options.id==impl.__options.id});self.stop(name);self.start(name)});this._activeServices[name]=impl;if(impl.isGlobal){var globalName=R.Utils.lowerCaseInitial(name);if(globalName in R){console.error("[Services] global slot should be empty for "+globalName)}R[globalName]=impl}else{if(name in this){console.error("[Services] local slot should be empty for "+name)}this[name]=impl}},_deleteReferences:function(name){if(this._activeServices[name]){if(this._activeServices[name].isGlobal){delete R[R.Utils.lowerCaseInitial(name)]}else{delete this[name]}delete this._activeServices[name]}}},{STATE_NOT_READY:0,STATE_READY:1,STATE_STOPPED:2,STATE_STOPPING:3})}.call(this);!function($){var currentlyLoadingScripts={};var currentlyLoadingComponents={};var preloaded={};var requestCountTable={};var DependencyModel,dependencyModel,dependencyXhr;R.Services.register("Loader",{isGlobal:true,onInitialized:function(){_.bindAll(this,"_successLoading","_errorLoading");this.pathBuilder=this.options.pathBuilder||this._buildComponentResourcePath;DependencyModel=DependencyModel||R.Model.extend({method:"getTargetDependencies",content:function(){return{app:Env.loadedTarget}}});dependencyModel=dependencyModel||new DependencyModel;dependencyXhr=dependencyXhr||dependencyModel.fetch()},onStarted:function(k){currentlyLoadingScripts={};currentlyLoadingComponents={};this._currentlyLoading=currentlyLoadingComponents;k()},_buildComponentResourcePath:function(component){var dir=this.options.componentRoot||"/Components/";var path=dir+component+".js";return path},onStopped:function(){this._currentlyLoading=currentlyLoadingScripts=currentlyLoadingComponents=null},recordEventualComponents:function(components,tag){if(!tag){return}var eventualComponents=_.chain(components).sortBy(function(component){return component}).filter(function(component){return _.isFunction(R.Component.getObject(component))||currentlyLoadingComponents[component]}).value();if(!eventualComponents.length){return}eventualComponents=[tag].concat(eventualComponents);var componentVersions=R.Services.Updater.model.get("components");var hashComponents=_.map(eventualComponents,function(component){return[component,componentVersions.get(component)].join(":")});var hash=murmurhash3_32_gc(hashComponents.join()).toString(16);if(!hash){return}R.Services.ready("Stats",function(){var sample=R.stats.createSample("racoon","eventual_components");sample.addString("hash",hash);sample.flush()})},load:function(components,k,reload,tag){var self=this;k=k||R.doNothing;if(!components||!components.length){k();return $.Deferred().resolve()}components=R.Utils.array(components);
if(R.currentUser.get("features").record_eventual_components){this.recordEventualComponents(components,tag)}var componentDeferreds=[];var deferred=$.when.apply($,_.map(components,function(component){var pending=currentlyLoadingComponents[component];var loadedComponent=R.Component.getObject(component);var src=self.pathBuilder(component);var componentDeferred,scriptDeferred;if(_.isFunction(loadedComponent)&&!reload){componentDeferred=$.Deferred().resolve();self._createSnorkelSample(component,"alreadyLoaded")}else if(pending){componentDeferred=pending;self._createSnorkelSample(component,"pending")}else{var loadStartTime=(new Date).getTime();componentDeferred=self.queueLoad(component);scriptDeferred=self._loadSource(src,component);scriptDeferred.fail(function(){componentDeferred.reject();self._createSnorkelSample(component,"error",loadStartTime)});scriptDeferred.done(function(){self._createSnorkelSample(component,"success",loadStartTime)});var features=R.currentUser.get("features");if(features.preload_deps&&dependencyModel.get(component)&&!preloaded[component]){if(!preloaded[component]){preloaded[component]=true;R.loader.load(dependencyModel.get(component))}}}return componentDeferred}));return deferred.always(function(){R.StyleManager.commitCss(components)}).done(k).promise()},batchLoadComponents:function(components,k){components=_.filter(components,function(component){return!_.isFunction(R.Component.getObject(component))});if(!components.length){k();return}var self=this;var src="/client/batch_load_components";src+="?components="+JSON.stringify(components);_.each(components,function(component){self.queueLoad(component)});R.injectScript(src,null,function(){k()},function(){console.error("Failed to batch load",components)})},loadExternalScripts:function(scripts,k){var self=this;k=k||R.doNothing;if(!scripts||!scripts.length){k();return $.Deferred().resolve()}var deferred=$.when.apply($,_.map(scripts,function(script){var pending=currentlyLoadingScripts[script];if(!pending){pending=self._loadSource(script,"external")}return pending}));return deferred.done(k).promise()},_loadSource:function(src,component){var self=this;var deferred=$.Deferred();deferred.attempts=1;currentlyLoadingScripts[src]=deferred;this.trigger("requested",src,component);deferred.done(function(){self.trigger("downloaded",src)});R.injectScript(src,null,this._successLoading,this._errorLoading);return deferred.promise()},_successLoading:function(src){if(currentlyLoadingScripts){var currentlyLoadingScript=currentlyLoadingScripts[src];if(currentlyLoadingScript){currentlyLoadingScript.resolve();delete currentlyLoadingScripts[src]}}},_errorLoading:function(e){var self=this;var $failedScript=$(e.target);var src=$failedScript.attr("src");var currentlyLoadingScript=currentlyLoadingScripts[src];if(!currentlyLoadingScript){return}var numTries=currentlyLoadingScript.attempts;if(numTries<=3){_.defer(function(){R.injectScript(src,null,self._successLoading,self._errorLoading);var currentlyLoadingScript=currentlyLoadingScripts[src];if(currentlyLoadingScript){currentlyLoadingScript.attempts++}},100)}else{var currentlyLoadingScript=currentlyLoadingScripts[src];if(currentlyLoadingScript){currentlyLoadingScript.reject()}}},queueLoad:function(component){if(!currentlyLoadingComponents[component]){var componentDeferred=$.Deferred();currentlyLoadingComponents[component]=componentDeferred}return currentlyLoadingComponents[component]},loaded:function(component){this.trigger("loaded:"+component);if(currentlyLoadingComponents){var pending=currentlyLoadingComponents[component];delete currentlyLoadingComponents[component];if(pending){pending.resolve()}}},_createSnorkelSample:function(component,state,loadStartTime){R.Services.ready("Stats",function(){var sample=R.stats.createSample("racoon","loader");sample.setSamplingRule("racoon_loader");if(requestCountTable[component]){requestCountTable[component]+=1}else{requestCountTable[component]=1}sample.addString("component",component);sample.addInteger("requestCount",requestCountTable[component]);if(loadStartTime){sample.addInteger("loadTime",(new Date).getTime()-loadStartTime)}sample.addString("state",state);sample.addString("page",R.Utils.getWindowLocation().pathname);sample.addString("user",R.currentUser.get("key"));sample.flush()})}},Backbone.Events)}(R.$);!function($){"use strict";function parseClientHeader(xhr){return xhr.getResponseHeader("X-Client-Version")}function checkClientVersion(e,xhr,clientOptions){var version=parseClientHeader(xhr);if(version&&R.VERSION.version&&version!==R.VERSION.version&&R.Services.Updater&&R.Services.Updater.isReady()){R.Services.Updater.update()}}$(document).ajaxSuccess(checkClientVersion);var VersionsModel,versionsModel,versionsFetch;var loadedComponentVersions={};var ONE_HOUR=60*60*1e3;R.Services.register("Updater",{onInitialized:function(options){_.bindAll(this,"update","_updateToVersion");VersionsModel=VersionsModel||R.Model.extend({overrides:{components:Backbone.Model,app:Backbone.Model,models:Backbone.Model}});versionsModel=versionsModel||new VersionsModel;this.model=versionsModel;versionsFetch=versionsFetch||this._fetchVersions();_.defaults(this.options,{timeFrame:ONE_HOUR});this._updateBlockers=[]},onStarted:function(k){var self=this;versionsFetch.done(function(){self.model.get("components").bind("change",self.onVersionChanged,self);self.model.get("app").bind("change",self._requestReload,self);self.model.get("models").bind("change",self._requestReload,self);k()});R.Services.ready("OfflineMonitor",function(){R.offlineMonitor.on("change",self.onOfflineStatusChanged,self)})},onStopped:function(){this.model.get("components").unbind("change",this.onVersionChanged,this);this.model.get("app").unbind("change",this._requestReload,this);this.model.get("models").unbind("change",this._requestReload,this);if(R.offlineMonitor){R.offlineMonitor.off("change",this.onOfflineStatusChanged,this)}if(this._pendingUpdate&&this._pendingUpdate.reject){this._pendingUpdate.reject()}if(this._pendingUpdate&&this._pendingUpdate.abort){this._pendingUpdate.abort()}this._pendingUpdate=null},onOfflineStatusChanged:function(online){if(online){this._checkClientVersion().done(this.update)}},_requestReload:function(){R.reload()},update:function(){var self=this;var forceUpdate=this._newVersion&&this._newVersion.force;this._pendingUpdate=this._whenAppropriate(forceUpdate).then(function(){if(self._newVersion&&self._newVersion.version){return $.Deferred().resolve().promise()}return self._checkClientVersion()}).done(this._updateToVersion).fail(function(){console.log("[Updater] Did not update.")}).then().always(function(){self._newVersion=null});return this._pendingUpdate.promise()},_checkClientVersion:function(){if(this._checkingVersion){console.log("[Updater] Aborting previous call to getClientVersion");this._checkingVersion.abort()}var self=this;this._checkingVersion=R.Api.request({method:"getClientVersion",content:{currentVersion:R.VERSION.version}});return this._checkingVersion.fail(function(){console.error("[Updater] Failed to get server version")}).then(function(response){var result=response.result;if(result.version===R.VERSION.version){console.log("[Updater] Version did not change");return $.Deferred().reject()}self._newVersion=result;return response}).always(function(){self._checkingVersion=null})},_whenAppropriate:function(force){var self=this;var deferred=$.Deferred();if(force){console.log("[Updater] Update forced!");if(this._waitingToUpdate){console.log("[Updater] Cancelling previously scheduled update");this._waitingToUpdate.reject()}return deferred.resolve()}if(this._waitingToUpdate){console.log("[Updater] Update already scheduled, not rescheduling");return deferred.reject()}var delay=Math.random()*this.options.timeFrame;_.delay(_.bind(deferred.resolve,deferred),delay);console.log("[Updater] Updating in "+delay/60/1e3+" minutes");var promise=deferred.then(function waitForBlockers(){return $.when.apply($,self._updateBlockers).then(function(){if(self._updateBlockers.length){return waitForBlockers()}})}).always(function(){self._waitingToUpdate=null});var masterDeferred=this._waitingToUpdate=$.Deferred();promise.done(_.bind(masterDeferred.resolve,masterDeferred));promise.fail(_.bind(masterDeferred.reject,masterDeferred));return masterDeferred},_fetchVersions:function(){var deferred=$.Deferred();var versionsPath="/media/client/versions/"+R.VERSION.version+"/"+Env.loadedTarget+".js";_.defer(function(){R.injectScript(versionsPath,null,function(){deferred.resolve()},function(){deferred.reject()})});return deferred},_updateToVersion:function(){var self=this;var version=this._newVersion.version;console.log("[Updater] Updating to client version",version);return this._fetchVersions().done(function(model,response){console.log("[Updater] Successfully updated to",version);R.VERSION.version=version})},blockUpdates:function(){var self=this;var deferred=$.Deferred();self._updateBlockers.push(deferred);return{clear:function(){self._updateBlockers=_.without(self._updateBlockers,deferred);deferred.resolve()}}},onVersionChanged:function(model,options){var componentsToReload=[];var self=this;_.each(model.changedAttributes(),function(version,component){if(!version){return}if(_.isFunction(R.Component.getObject(component))){console.log("[Updater] Refreshing",component,version,model.previous(component));componentsToReload.push(component)}});R.loader.load(componentsToReload,R.doNothing,true).fail(R.reload)}})}.call(this,R.$);!function(self){if(!("R"in self)){self.R={}}R.Work={};R.Work.blur=function(data){var w=data.w;var h=data.h;var r=data.r;var res={w:w,h:h};var time=Date.now();if("buf"in data){var buf=data.buf;var end=data.end;if(typeof typedStackBlurRGB!=="undefined"){typedStackBlurRGB(new Uint8ClampedArray(buf),0,0,w,h,r,end)}res.buf=buf;res.time=Date.now()-time;return[res,[buf]]}else if("pix"in data){var pix=data.pix;if(typeof stackBlurRGB!=="undefined"){stackBlurRGB(pix,0,0,w,h,r)}res.pix=pix;res.time=Date.now()-time;return[res]}else{res.err="Did not receive a buffer or pixels";return[res]}}}(typeof window==="undefined"?self:window);!function($){function Api(){this.url="/api/1/"}var API_VERSION=20140227;var outstandingRequests=0;Api.prototype.ERROR={INVALID_PASSWORD:498,ACCOUNT_NOT_FOUND:495,UNSUPPORTED_COUNTRY:494,ALREADY_LOGGED_IN:493,SUBSCRIBER_ONLY:492,REQUIRES_LOGIN:491,EMAIL_ALREADY_REGISTERED:488,TOO_MANY_CHARACTERS:486,NOT_ENOUGH_ADS:484,NOT_FOUND:404,HAS_OUTSTANDING_PURCHASE:399,FAILED_TO_BILL:398,IS_SUBSCRIBED:397};Api.prototype.setJsonReviver=function(reviver){this._reviver=reviver};Api.prototype.getNumOutstandingRequests=function(){return outstandingRequests};Api.prototype._formatExtras=function(extras){var self=this;extras=extras||[];extras.unshift("*.WEB");var hasObjectExtras=_.any(extras,_.isObject);if(hasObjectExtras){extras=_.map(extras,function(extra){if(_.isString(extra)){extra={field:extra}}if(!extra.exclude&&extra.field.charAt(0)!=="*"){extra.extras=self._formatExtras(extra.extras)}return extra})}extras._hasObjects=hasObjectExtras;return extras};Api.prototype.request=function(config){var self=this;var args=arguments;var reviver;config.content=config.content||{};reviver=config.reviver?config.reviver:this._reviver;var extras=this._formatExtras(_.clone(config.content.extras));config.content.extras=extras._hasObjects?JSON.stringify(extras):extras;if(!config.method){R.logger.log('API ERROR: missing option "method"');return}config.content.method=config.method;var dataType=reviver?"text":"json";var opts={type:"POST",url:this.url+config.method,data:config.content||{},dataType:dataType,cache:config.cache||false};opts.data._authorization_key=R.currentUser.get("authorizationKey");opts.data.v=R.serverInfo?API_VERSION:0;_.extend(opts,config);if(R.settings){var clientId=R.settings.get("apiClientId");if(clientId){opts.headers=_.extend(opts.headers||{},{"X-Rdio-Client-Id":clientId})}}if(R.isChromecastLaunchedByMobile){opts.headers=_.extend(opts.headers||{},{"X-Rdio-Chromecast-Launched-From-Mobile":true})}var callbackNames=["success","error","complete"];var callbacks={};_.each(callbackNames,function(c){callbacks[c]=opts[c];opts[c]=null});var jqXhr=$.ajax(opts);jqXhr.then(function(data){if(reviver){try{data=JSON.parse(data,reviver)}catch(exc){console.error("Error in API response JSON.",JSON.stringify(config.content),data);throw exc}}if(data.status=="ok"){return data}else{console.error("Error in API call:",config,data);return $.Deferred().reject(data)}}).promise(jqXhr);jqXhr.success=jqXhr.done;jqXhr.error=jqXhr.fail;jqXhr.complete=jqXhr.always;outstandingRequests++;jqXhr.always(function(){outstandingRequests--;if(outstandingRequests===0&&R.isPhantom){window.alert("zeroRequestsOutstanding")}});jqXhr.fail(function(xhr){console.warn("API call failed:",JSON.stringify(config.content));self.trigger("error",xhr.status)});_.each(callbackNames,function(c){jqXhr[c](callbacks[c])});return jqXhr};_.extend(Api.prototype,Backbone.Events);R.ApiRequestQueue=function(options){this._queue=[];this._lock=false;options=_.isObject(options)?options:{};_.defaults(options,{callAllSuccessCallbacks:false});this._callAllSuccessCallbacks=options.callAllSuccessCallbacks};_.extend(R.ApiRequestQueue.prototype,{push:function(args){this._queue.push(args);if(!this.isLocked()){this.lock();this._processQueue()}},_processQueue:function(){if(!this.isEmpty()){var args=this._queue.shift();var _success=args.success?args.success:R.doNothing;var _error=args.error?args.error:R.doNothing;var self=this;args.success=function(response){if(self._callAllSuccessCallbacks||self.isEmpty()){_success(response)}if(self.isEmpty()){self.unlock()}self._processQueue()};args.error=function(response){_error(response);if(!self.isEmpty()){console.error("Error encountered while processing queued commands. Remaining commands will not be processed.");self._queue=[]}self.unlock()};R.Api.request(args)}},lock:function(){this._lock=true},unlock:function(){this._lock=false},isLocked:function(){return this._lock},isEmpty:function(){return this._queue.length===0}});R.Api=new Api}(jQuery);R.Date=function(){var keys={shortDays:[t("Sun"),t("Mon"),t("Tue"),t("Wed"),t("Thu"),t("Fri"),t("Sat")],longDays:[t("Sunday"),t("Monday"),t("Tuesday"),t("Wednesday"),t("Thursday"),t("Friday"),t("Saturday")],shortMonths:[t("Jan"),t("Feb"),t("Mar"),t("Apr"),t("May"),t("Jun"),t("Jul"),t("Aug"),t("Sep"),t("Oct"),t("Nov"),t("Dec")],longMonths:[t("January"),t("February"),t("March"),t("April"),t("May"),t("June"),t("July"),t("August"),t("September"),t("October"),t("November"),t("December")]};var paddingOperatorMap={"-":"",_:" ",0:"0"};function pad(num,padWith){if(padWith==null){padWith=paddingOperatorMap["0"]}if(num<10){return padWith+num}else{return num}}function nth(d){switch(d%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}var tzFinder=/[A-Z]{3}/g;var formats={a:function(date){return keys.shortDays[date.getDay()]},A:function(date){return keys.longDays[date.getDay()]},b:function(date){return keys.shortMonths[date.getMonth()]},B:function(date){return keys.longMonths[date.getMonth()]},c:function(date){return date.toString()},d:function(date,padWith){return pad(date.getDate(),padWith)},e:function(date,padWith){if(padWith==null){padWith=paddingOperatorMap["_"]}return pad(date.getDate(),padWith)},D:function(date){var d=date.getDate();return d+nth(d)},H:function(date,padWith){return pad(date.getHours(),padWith)},I:function(date){if(date.getHours()%12===0){return 12}return date.getHours()%12},m:function(date,padWith){return pad(date.getMonth()+1,padWith)},M:function(date,padWith){return pad(date.getMinutes(),padWith)},p:function(date){var hour=date.getHours();if(hour>=12){return"PM"}return"AM"},S:function(date,padWith){return pad(date.getSeconds(),padWith)},x:function(date){return R.Date.strftime(date,Locale.shortDate||"%m/%d/%y")},X:function(date){return Locale.timeFormat?R.Date.strftime(date,Locale.timeFormat):date.toLocaleTimeString()},y:function(date){return date.getFullYear().toString().slice(2)},Y:function(date){return date.getFullYear()},Z:function(date){var tz=date.toString().match(tzFinder);if(tz&&tz.length){return tz.pop()}else{return""}},"%":function(){return"%"}};var parser=/%([\-_0]?[A-z%])/g;var durations={ms:1,s:1e3,m:1e3*60,h:1e3*60*60,d:1e3*60*60*24,w:1e3*60*60*24*7,mo:1e3*60*60*24*30,y:1e3*60*60*24*365};var duration_regex=/^(-?)([0-9]+)\s*(.*)$/;var granularities={minutes:0,hours:1,days:2,weeks:3,months:4,years:5};var relativeFutureMap={years:function(diff){return t(["in [num] year","in [num] years"],{num:Math.round(diff/D("-1y"))})},months:function(diff){return t(["in [num] month","in [num] months"],{num:Math.round(diff/D("-1mo"))})},weeks:function(diff){return t(["in [num] week","in [num] weeks"],{num:Math.round(diff/D("-1w"))})},days:function(diff){return t(["in [num] day","in [num] days"],{num:Math.round(diff/D("-1d"))})},hours:function(diff){return t(["in one hour","in [num] hours"],{num:Math.round(diff/D("-1h"))})},minutes:function(diff){return t(["in a minute","in [num] minutes"],{num:Math.round(diff/D("-1m"))})}};var relativePastMap={years:function(diff){return t(["[num] year ago","[num] years ago"],{num:Math.round(diff/D("1y"))})},months:function(diff){return t(["[num] month ago","[num] months ago"],{num:Math.round(diff/D("1mo"))})},weeks:function(diff){return t(["[num] week ago","[num] weeks ago"],{num:Math.round(diff/D("1w"))})},days:function(diff){return t(["[num] day ago","[num] days ago"],{num:Math.round(diff/D("1d"))})},hours:function(diff){return t(["[num] hour ago","[num] hours ago"],{num:Math.round(diff/D("1h"))})},minutes:function(diff){return t(["[num] minute ago","[num] minutes ago"],{num:Math.round(diff/D("1m"))})}};function D(s){var m=s.match(duration_regex);return parseInt(""+m[1]+parseInt(m[2],10)*durations[m[3]],10)}function isLeapYear(year){return year%4===0&&year%100!==0||year%400===0}function getDaysInMonth(year,month){return[31,isLeapYear(year)?29:28,31,30,31,30,31,31,30,31,30,31][month]}return{strftime:function(date,format){if(!date){return""}var matches=format.match(parser);if(!matches){return format}var len=matches.length;var padWith;var match;var identifier;for(var i=0;i<len;i++){match=matches[i];identifier=match.charAt(1);padWith=paddingOperatorMap[identifier];if(typeof padWith!=="undefined"){identifier=match.charAt(2)}format=format.replace(match,formats[identifier](date,padWith))}return format},addMonths:function(date,value){var day=date.getDate();date.setDate(1);date.setMonth(date.getMonth()+value*1);var daysInMonth=getDaysInMonth(date.getFullYear(),date.getMonth());date.setDate(Math.min(day,daysInMonth));return date},formatCreditCardDate:function(date){if(_.isString(date)){date=Bujagali.Utils.date(date,true)}return this.strftime(date,"%m/%Y")},formatShortDate:function(date,includeTimezone){if(_.isString(date)){date=Bujagali.Utils.date(date,!includeTimezone)}return this.strftime(date,Locale.shortDate)},formatLongDate:function(date,includeTimezone){if(_.isString(date)){date=Bujagali.Utils.date(date,!includeTimezone)}return this.strftime(date,Locale.longDate)},relativeTime:function(date,minGranularity){var now=(new Date).getTime();var diff=now-date;var d;try{var unit;if(diff<0){if(diff<D("-1y")){unit="years"}else if(diff<D("-6w")){unit="months"}else if(diff<D("-2w")){unit="weeks"}else if(diff<D("-1d")){unit="days"}else if(diff<D("-1h")){unit="hours"}else if(diff<D("-1m")){unit="minutes"}else{return t("in a moment")}if(minGranularity&&granularities[unit]>granularities[minGranularity]){unit=minGranularity}return relativeFutureMap[unit](diff)}else{if(diff<D("1m")){return t("a moment ago")}else if(diff<D("1h")){unit="minutes"}else if(diff<D("1d")){unit="hours"}else if(diff<D("1w")){unit="days"}else if(diff<D("8w")){unit="weeks"}else if(diff<D("1y")){unit="months"}else{unit="years"}if(minGranularity&&granularities[unit]>granularities[minGranularity]){unit=minGranularity}return relativePastMap[unit](diff)}}catch(exc){console.log("Could not translate relative times: ",t,exc);throw exc}},duration:D}}();Bujagali.mixin(R.Date);!function($){var COMPONENT_BASE=R.serverInfo.get("media_address")+"client/Components/";var html5Tags=["abbr","article","aside","audio","canvas","datalist","details","figcaption","figure","footer","header","hgroup","mark","meter","nav","output","progress","section","subline","summary","time","video"];var objectClassNames=["Album","Artist","Track","Contributor","Movie","Series","Genre","Distributor"];var typeMap={a:"Album",al:"Album",rl:"Artist",r:"Artist",t:"Track",p:"Playlist",l:"Label",s:"Person",ct:"Contributor",mr:"Movie",vr:"Series",vsr:"Season",ver:"Episode",g:"Genre",mg:"MusicGenre",ne:"Distributor",bn:"Distributor",st:"Distributor",pz:"Distributor",cs:"Set",fr:"Franchise",ec:"EditorialCollection",bcr:"MovieBonusContent"};var httpRe=/^http:/;var edgecastCdnRe=/cdn2-rdio.com/;_.extend(R.Utils,{ensureHtml5Elements:function(){if($.browser.msie&&parseInt($.browser.version,10)<9){_.each(html5Tags,function(el){document.createElement(el)})}},stopEvent:function(e){e.preventDefault();e.stopPropagation()},convertToModel:function(o){if(!o){return null}o=R.Models.ListItem.unwrap(o);if(o instanceof R.Model){return o}if(o instanceof Backbone.Model){o=o.attributes}if(R.isStation(o)){return new R.Models.Station(o)}if(R.isEpisodeBonusContent(o)){return new R.Models.EpisodeBonusContent(o)}var modelTypes={a:R.Models.Album,al:R.Models.Album,p:R.Models.Playlist,l:R.Models.Label,s:R.Models.User,r:R.Models.Artist,rl:R.Models.Artist,t:R.Models.Track,mr:R.Models.Movie,ct:R.Models.Contributor,ver:R.Models.Episode,vsr:R.Models.Season,vr:R.Models.Series,g:R.Models.Genre,mg:R.Models.MusicGenre,ne:R.Models.Network,bn:R.Models.Network,st:R.Models.Studio,pz:R.Models.Studio,cs:R.Models.Set,fr:R.Models.Franchise,ec:R.Models.EditorialCollection,bcr:R.Models.MovieBonusContent,sc:R.Models.Comment};var ModelClass=modelTypes[o.type];if(!ModelClass){ModelClass=R.Model}return new ModelClass(o)},addFloodlightTag:function(src_stub,successCallback,errorCallback){if(src_stub){var axel=Math.random()+"";var a=axel*1e13;var iframe_src=src_stub+a+"?";var iframe=$("<iframe />").attr("class","floodlight").attr("src",iframe_src).attr("width",1).attr("height",1).attr("frameborder",0).attr("style","display:none");if(successCallback||errorCallback){iframe.on("load",successCallback).on("error",errorCallback)}$(document.body).append(iframe)}},addPixelTracking:function(url,successCallback,errorCallback){if(url){var img=$("<img />").attr("class","conversion_pixels").attr("src",url).attr("style","display: none");if(successCallback||errorCallback){img.on("load",successCallback).on("error",errorCallback)}$(document.body).append(img)}},addPixelScript:function(script){if(script){R.injectScript(script)}},clamp:function(x,min,max){return Math.max(Math.min(x,max),min)},clamp01:function(x){return R.Utils.clamp(x,0,1)},lerp:function(start,end,percent){percent=R.Utils.clamp01(percent);var diff=end-start;diff*=percent;return start+diff},easeInOutSine:function(t){t=R.Utils.clamp01(t);return-.5*(Math.cos(Math.PI*t)-1)},sign:function(x){return x>=0?1:-1},exponentialMovingAverage:function(St,Yt,t,N){if(t>1){var a=2/(N+1);return a*Yt+(1-a)*St}return Yt},bindAll:function(obj){console.warn("R.Utils.bindAll is discouraged for future Underscore.js compatibility.\nYou should use `_.bindAll(this, *methodNames)` instead.");_.bindAll.apply(_,[obj].concat(_.functions(obj)));return obj},secureFixup:function(url){if(!url||!R.Utils.isSecure()||url.indexOf("http:")!==0){return url}if(R.isIE8||edgecastCdnRe.test(url)){return url.replace(httpRe,"https:")}return url},getMobileDownloadUrl:function(){var urls=R.serverInfo.get("appDownloadUrls");var ua=R.Utils.getUserAgent().toLowerCase();if(/android/.test(ua)){return urls.android}else if(/iphone|ipad|ipod/.test(ua)){return urls.ios}else if(/windows phone/.test(ua)){return urls.windows_phone}else{return null}},getWebStoreUrl:function(){var urls=R.serverInfo.get("appDownloadUrls");var ua=R.Utils.getUserAgent().toLowerCase();if(/android/.test(ua)){return urls.android}else if(/iphone|ipad|ipod/.test(ua)){return urls.ios}else if(/windows phone/.test(ua)){return urls.windows_phone}else{return null}},getUserAgent:function(){return navigator.userAgent},addStudentDiscountFloodlightTag:function(field,successCallback,errorCallback){var tracking=R.serverInfo.get("pixelTracking");if(tracking&&tracking.studentDiscount){var pixels=tracking.studentDiscount[field];var url=R.isMobile?pixels.mobile:pixels.desktop;if(url){if(R.isMobile){R.Utils.addPixelTracking(url,successCallback,errorCallback)}else{R.Utils.addFloodlightTag(url,successCallback,errorCallback)}}}},addPartnerPromotionFloodlightTag:function(partner,field,successCallback,errorCallback){var tracking=R.serverInfo.get("pixelTracking");if(tracking&&tracking.partnerPromotion){var urls=tracking.partnerPromotion[partner];if(urls){R.Utils.addFloodlightTag(urls[field],successCallback,errorCallback)}}},addCacheBustingParameter:function(url,param){if(!param){param="cb"}url+=url.indexOf("?")!=-1?"&":"?";url+=param+"="+Math.random()*1e3;return url},convertToModels:function(list){return _.map(list,function(o){return R.Utils.convertToModel(o)})},getComponentClassForModel:function(model){var klass=model.componentClass||null;if(!klass){var type=model.get("type");if(R.isEpisodeBonusContent(model)){return"EpisodeBonusContent"}else if(type in typeMap){return typeMap[type]}else if(R.isStation(model)){return"Station"}}return klass},getComponentForModel:function(model,defaultComponent){if(!model){return null}var component;var componentClass=this.getComponentClassForModel(model);if(componentClass){component=R.Component.getObject(componentClass)}else if(R.isStation(model)){component=R.Components.Station}else if(defaultComponent){component=defaultComponent}if(model.get("type")&&!component){console.error("Component not loaded. Type was: "+model.get("type"))}else{return component}return null},factory:function(c){c=c||this;return function(data,options){return new c(data,options)}},copyArrayBuffer:function(dst,src){var dstUint8arr=new Uint8Array(dst);var srcUint8arr=new Uint8Array(src,0,Math.min(dst.byteLength,src.byteLength));dstUint8arr.set(srcUint8arr)},resizeImage:function(image,width,height){var canvasA=document.createElement("canvas");var canvasB=document.createElement("canvas");var ctxA=canvasA.getContext("2d");var ctxB=canvasB.getContext("2d");var tmp;var scaledW=0;var scaledH=0;while(image.width>width||image.height>height){scaledW=image.width>>1;scaledH=image.height>>1;canvasA.width=scaledW>width?scaledW:width;canvasA.height=scaledH>height?scaledH:height;ctxA.drawImage(image,0,0,canvasA.width,canvasA.height);image=canvasA;canvasA=canvasB;canvasB=image;tmp=ctxA;ctxA=ctxB;ctxB=tmp}return image},isLittleEndian:function(){var buffer=new ArrayBuffer(4);var uint32arr=new Uint32Array(buffer);var uint8arr=new Uint8Array(buffer);uint32arr[0]=168496141;if(uint8arr[3]===10&&uint8arr[2]===11&&uint8arr[1]===12&&uint8arr[0]===13){return true}return false},reportErrors:function(f,name){return function(){try{f.apply(this,arguments)}catch(exc){var functionName=name||f.name||"anonymousFunction";var message="Exception occurred in "+functionName;R.Utils.logException(message,exc);R.Services.ErrorReporter.reportError(functionName+":"+message,location.host,"","",exc)}}},logException:function(message,exc){if(!exc){exc={message:"No Exception provided",stack:""}}message+=": "+exc.message;if(console.group){console.group(message)}else{console.log(message)}if(console.exception&&console.exception!==console.error){console.exception(exc)}else if(exc.stack){console.error(exc.stack)}else{console.error(message)}if(console.groupEnd){console.groupEnd()}},eachKey:function(obj,iterator,context){if(!obj){return}for(var key in obj){if(_.has(obj,key)){iterator.call(context,obj[key],key,obj)}}},transitionEndEvent:_.memoize(function(){var transitions={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",transition:"transitionend"};return transitions[Modernizr.prefixed("transition")]}),animationEndEvent:_.memoize(function(){var events=[["OAnimation","oAnimationEnd"],["MozAnimation","animationend"],["WebkitAnimation","webkitAnimationEnd"],["animation","animationEnd"]];return this.findPrefixedEvent(events)}),findPrefixedEvent:function(events){var el=document.createElement("fakeelement");var eventName;for(var i=0;i<events.length;i++){if(el.style[events[i][0]]!==undefined){eventName=events[i][1];break}}return R.isIE10?eventName.toLowerCase():eventName},getUserEnvironment:_.memoize(function(nav){var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"Unknown Browser";this.version=this.searchVersion(nav.userAgent)||this.searchVersion(nav.appVersion)||999;this.OS=this.searchString(this.dataOS)||"Unknown OS";this.isMobile=this.OS.search(/^(iOS|Android|Windows Phone)$/)!=-1;this.isIpadPlayer=nav.userAgent.search(/vdioipadplayer/)!=-1;this.isIpad=nav.userAgent.search(/iPad/)!=-1||this.isIpadPlayer;this.isIos5=nav.userAgent.search(/CPU OS 5.+like Mac OS X/)!=-1;this.isIos5WebView=nav.userAgent.search(/^(?!.*Safari.*).*iPhone OS 5/)!=-1;this.isTv=this.OS==="Google TV";this.isAndroid=this.OS==="Android";this.isIosSDK=nav.userAgent.search(/rdio-ios-sdk/)!=-1},searchString:function(data){for(var i=0;i<data.length;i++){var dataString=data[i].string;var dataProp=data[i].prop;this.versionSearchString=data[i].versionSearch||data[i].identity;if(dataString){if(dataString.indexOf(data[i].subString)!=-1){return data[i].identity}}else if(dataProp){return data[i].identity}}},searchVersion:function(dataString){var index=dataString.indexOf(this.versionSearchString);if(index==-1){return}return parseFloat(dataString.substring(index+this.versionSearchString.length+1))},dataBrowser:[{string:nav.userAgent,subString:"PhantomJS",versionSearch:"PhantomJS/",identity:"Phantom"},{string:nav.userAgent,subString:"facebook",identity:"Facebook"},{string:nav.userAgent,subString:"CriOS",identity:"Chrome"},{string:nav.userAgent,subString:"Chrome",identity:"Chrome"},{string:nav.userAgent,subString:"IEMobile",versionSearch:"IEMobile",identity:"IE Mobile"},{string:nav.userAgent,subString:"Firefox",identity:"Firefox"},{string:nav.userAgent,subString:"Mobile",versionSearch:"Version",identity:"Mobile WebKit"},{string:nav.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:nav.appVersion,subString:"Google Web Preview",versionSearch:"Mozilla",identity:"Safari"},{string:nav.vendor,subString:"Apple",versionSearch:"Version",identity:"Safari"},{prop:window.opera,versionSearch:"Version",identity:"Opera"},{string:nav.vendor,subString:"iCab",identity:"iCab"},{string:nav.vendor,subString:"KDE",identity:"Konqueror"},{string:nav.vendor,subString:"Camino",identity:"Camino"},{string:nav.userAgent,subString:"Netscape",identity:"Netscape"},{string:nav.userAgent,subString:"MSIE",versionSearch:"MSIE",identity:"Internet Explorer"},{string:nav.userAgent,subString:"Trident/7.0",versionSearch:"rv",identity:"Internet Explorer"},{string:nav.userAgent,subString:"Gecko",versionSearch:"rv",identity:"Mozilla"},{string:nav.userAgent,subString:"Mozilla",versionSearch:"Mozilla",identity:"Netscape"},{string:nav.userAgent,subString:"com.rdio.desktop.win/",versionSearch:"com.rdio.desktop.win",identity:"Rdio Windows App"}],dataOS:[{string:nav.userAgent,subString:"iPhone",identity:"iOS"},{string:nav.userAgent,subString:"iPad",identity:"iOS"},{string:nav.userAgent,subString:"iPod",identity:"iOS"},{string:nav.userAgent,subString:"GoogleTV",identity:"Google TV"},{string:nav.userAgent,subString:"Android",identity:"Android"},{string:nav.userAgent,subString:"Windows Phone",identity:"Windows Phone"},{string:nav.platform,subString:"Win",identity:"Windows"},{string:nav.userAgent,subString:"CrOS",identity:"Chrome OS"},{string:nav.platform,subString:"Linux",identity:"Linux"},{string:nav.platform,subString:"Mac",identity:"Mac"}]};BrowserDetect.init();return{browser:BrowserDetect.browser,browserVersion:BrowserDetect.version,operatingSystem:BrowserDetect.OS,isMobile:BrowserDetect.isMobile,isTv:BrowserDetect.isTv,isIpadPlayer:BrowserDetect.isIpadPlayer,isIpad:BrowserDetect.isIpad,isIos5:BrowserDetect.isIos5,isAndroid:BrowserDetect.isAndroid,isIosSDK:BrowserDetect.isIosSDK}
},function(nav){return nav.userAgent+"::"+nav.appVersion+"::"+nav.vendor+"::"+nav.platform}),modelReviver:function(prop,value){if(value&&value.type==="list"&&prop!=="result"){return new(R.Models.ModelFieldCollection.factory())(value,{parentProperty:prop})}return value},loadCORSImage:function(src,callback){if(!Modernizr.cors){throw new Error("Tried to load an image without CORS")}var img=new Image;img.onload=callback;img.crossOrigin="";img.src=src;return img},loadImageAsync:function(src,options){var img=new Image;var deferred=$.Deferred();options=options||{};if(options.isAnonymous){if(!Modernizr.cors){throw new Error("Tried to anonymously load an image without CORS")}img.crossOrigin="anonymous"}img.onload=function(){deferred.resolve(img)};img.src=src;return deferred.promise()},shareDialog:function(options){options=options||{};if(!options.model){throw new Error("Model required when calling shareDialog")}var parent;if(options.parent){parent=options.parent;delete options.parent}R.loader.load(["ShareDialog",this.getComponentClassForModel(options.model)],function(){var dialog=new R.Components.ShareDialog(options);if(parent){parent.addChild(dialog)}R.app.openSingularDialog(dialog)})},messageDialog:function(options){var message=R.Utils.value(options.message);if(!message){throw new Error("Valid message required when calling messageDialog")}var title=R.Utils.value(options.title);if(!title){throw new Error("Valid title required when calling messageDialog")}var parent=options.parent||R.app;R.loader.load(["Dialog.MessageDialog"],function(){var dialog=new R.Components.Dialog.MessageDialog({model:new Backbone.Model({message:message}),title:title,buttons:new Backbone.Collection(options.buttons),closeButton:options.closeButton,closeOnNavigate:options.closeOnNavigate,extraClassName:options.extraClassName});parent.addChild(dialog);dialog.open();if(options.onClose){parent.listen(dialog,"close",options.onClose)}})},openBackgroundTab:function(url,playsAudio){var env=R.Utils.getUserEnvironment(navigator);if(playsAudio&&_.contains(["Safari"],env.browser)){window.open(url,"_blank");return}if(!_.contains(["Chrome","Safari"],env.browser)){var tab=window.open(url,"_blank");tab.blur();window.focus();return}var a=document.createElement("a");a.href=url;var e=document.createEvent("MouseEvents");e.initMouseEvent("click",true,true,window,0,0,0,0,0,true,false,false,true,0,null);a.dispatchEvent(e)},popup:function(options){if(options.width){options.left=Math.round(screen.width/2-options.width/2)}if(options.height){options.top=Math.round(screen.height/2-options.height/2)}var windowOptions=_.chain(options).omit("url","name").map(function(val,key){if(_.isBoolean(val)){val=val?"yes":"no"}return[key,val].join("=")},"").value().join(",");return window.open(options.url,options.name,windowOptions)},createAndOpenSecureDialog:function(options){var isSecure=R.Utils.isSecure();options=options||{};var dialog;if(!(options&&options.componentName)){throw new Error("createAndOpenSecureDialog requires a componentName option.")}var componentName=options.componentName;if(isSecure){delete options.popupHeight;delete options.popupWidth;R.loader.load([componentName],function(){dialog=new(R.Component.getObject(componentName))(options.componentOptions);dialog.open();if(options.callback&&_.isFunction(options.callback)){options.callback(dialog)}})}else{var url=this.fullUrl(R.serverInfo.get("urls").secureDialog,true);var componentOptions=_.extend({componentName:options.componentName},options.componentOptions);var urlParams=_.reduce(componentOptions,function(arr,value,key){if(typeof value==="string"){value='"'+value.replace(/"/g,'\\"')+'"'}arr.push(encodeURIComponent(key)+"="+encodeURIComponent(value));return arr},[]).join("&");if(urlParams){url+="?"+urlParams}var height=options.popupHeight||630;var width=options.popupWidth||650;var windowTop=window.screenY||window.screenTop;var windowLeft=window.screenX||window.screenLeft;var top=Math.floor(windowTop+document.body.clientHeight/2-height/2);var left=Math.floor(windowLeft+document.body.clientWidth/2-width/2);var dialogOptions="height="+height+",width="+width+",top="+top+",left="+left+"dialog=yes,titlebar=no,close=no";dialog=window.open(url,"secure_dialog",dialogOptions);if(dialog){dialog.focus()}if(options.callback&&_.isFunction(options.callback)){options.callback(dialog)}}},notifyDialogClosed:function(dialog,callback,interval){if(!interval){interval=200}var checkFn=function(){if(dialog.closed){callback()}else{setTimeout(checkFn,interval)}};setTimeout(checkFn,interval)},getWindowLocation:function(){return window.location},getWindowWidth:function(){return $(window).width()},isSecure:function(){return R.Utils.getWindowLocation().protocol==="https:"},redirectToSignup:function(next){window.location.href=R.Utils.getSignUpUrl(next)},subNameForSubType:function(subType){switch(subType){case 1:return"web";case 2:return"unlimited";case 3:return"family"}return null},renderChildAtIndex:function(component,child,index,defaultInsertionEl){if(!(component.model instanceof Backbone.Collection||component.model instanceof R.Models.SparseCollection)){throw new TypeError("Component model must be a collection to render child at index")}component.addChild(child);child.render(function(){var length=0;if(component.model.length){length=R.Utils.value.call(component.model,component.model.length)}var modelBefore=index>0?component.model.at(index-1):null;var componentBefore=modelBefore?component.findChildWithModel(modelBefore):null;var modelAfter=index+1<length?component.model.at(index+1):null;var componentAfter=modelAfter?component.findChildWithModel(modelAfter):null;if(componentAfter&&componentAfter.isRendered()){componentAfter.$el.before(child.$el)}else if(componentBefore&&componentBefore.isRendered()){componentBefore.$el.after(child.$el)}else{if(defaultInsertionEl){$(defaultInsertionEl).append(child.$el)}else{throw new Error("A $defaultInsertionEl wasn't specified while adding a child to an empty model view.")}}})},isValidEmail:function(toTest){return toTest.match(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i)},parseUrl:function(url){var a=document.createElement("a");a.href=url;a.href=a.href;var urlParts=_.pick(a,"href","protocol","host","port","pathname","search","hash");if(urlParts.pathname&&urlParts.pathname.indexOf("/")!==0){urlParts.pathname="/"+urlParts.pathname}return urlParts},fullUrl:function(url,forceSecure){var isFullUrl=/^https?:\/\//.test(url);var isRelativePath=url.indexOf("/")!==0;if(!isFullUrl&&isRelativePath){console.warn("R.Utils.fullUrl is not designed for relative URLs.");url="/"+url}var urlParts=R.Utils.parseUrl(url);var fullUrl=urlParts.href;if(forceSecure&&R.serverInfo.get("prod")){fullUrl=fullUrl.replace(urlParts.protocol,"https:")}return fullUrl},mobileUrl:function(url){var fullUrl=this.fullUrl(url);var mobileUrl=fullUrl.replace(/https?/,"rdio");return mobileUrl},openGraphUrl:function(url){url=this.fullUrl(url);var params=this.getQueryStringParams();var artistProgramUrl=params.ap||params.ap_url;if(artistProgramUrl){url=decodeURIComponent(artistProgramUrl)+"?ap_url="+encodeURIComponent(url)}return url},emailOrUrlLink:function(emailOrUrl){if(_.isString(emailOrUrl)&&this.isValidEmail(emailOrUrl)&&!/^mailto:/i.test(emailOrUrl)){return"mailto:"+emailOrUrl}if(!emailOrUrl){return""}return""+emailOrUrl},getHashUrlMatches:function(urlMatches,keys){keys=keys.slice();var matches={};var start=-1;var end=-1;var i;var j;var urlMatch;var key;for(i=0;i<urlMatches.length;i++){urlMatch=urlMatches[i];for(j=0;j<keys.length;j++){key=keys[j];if(key===urlMatch){matches[key]=urlMatches[i+1];keys.splice(j,1);break}}}return matches},camelToSnake:function(val){return val.replace(/^([A-Z])/,function($0,$1){return $1.toLowerCase()}).replace(/([A-Z])/g,function($0,$1){return"_"+$1.toLowerCase()})},snakeToCamel:function(val){return val.replace(/_(\w)/g,function($0,$1){return $1.toUpperCase()})},stripHtml:function(val){return $("<div></div>").html(val).text()},bool:function(val){return!!val},ensureBodyClasses:function(navigator){var $body=$("body");if(R.isDesktop){$body.addClass("desktop")}if(R.isMacDesktop){$body.addClass("mac_desktop")}else if(R.isWinDesktop){$body.addClass("win_desktop")}if(R.usesNewHeader){$body.addClass("new_desktop_header")}if(R.currentUser.isAnonymous()){$body.addClass("anonymous")}if(R.isMobile){$body.addClass("mobile")}if(R.isIpadPlayer){$body.addClass("vdio_ipad_player")}var env=R.Utils.getUserEnvironment(navigator||window.navigator);if(env.browser==="Phantom"){$body.addClass("robot")}if(!R.isMacDesktop&&_.contains(["Chrome","Safari"],env.browser)){$body.addClass("webkit")}if(env.browser==="Firefox"){$body.addClass("moz")}if(!R.isMacDesktop){$body.addClass("gpu")}if(R.isIE&&env.browserVersion<=9){$body.addClass("no_media_queries")}else{$body.addClass("media_queries")}if(R.isIE8){$body.addClass("ie8")}},scrollbarSize:_.memoize(function(){var size;var div=$('<div style="width:50px;height:50px;overflow:hidden;'+'position:absolute;top:-200px;left:-200px;"><div style="height:100px;">'+"</div>");$("body").append(div);var w1=$("div",div).innerWidth();div.css("overflow-y","scroll");var w2=$("div",div).innerWidth();if(w1==w2){w2=div.get(0).clientWidth}$(div).remove();size=w1-w2;return size}),getHelpUrl:function(id){var baseHelpUrl=R.serverInfo.get("helpBaseUrl");if(id){return baseHelpUrl+=id}else if(!R.currentUser.get("isAnonymous")){return R.serverInfo.get("helpUrl")}return baseHelpUrl},getSignInUrl:function(next){var url="/account/signin/";if(next&&next!=="/"){url+="?next="+encodeURIComponent(next)}return url},getSignUpUrl:function(next){var url="/account/signup/";if(next&&next!=="/"){url+="?next="+encodeURIComponent(next)}return url},getValidRedirectUrl:function(url){var defer=$.Deferred();var self=this;R.Api.request({method:"getValidRedirectUrl",content:{url:url},success:function(response){if(response.result){defer.resolve(response.result).promise()}else{defer.resolve("/").promise()}},error:function(){defer.reject().promise()}});return defer},linkSortControls:function(collectionComponent,sortControls,notFound){collectionComponent.listen(sortControls,"found",function(){collectionComponent.$el.show();notFound.$el.hide()});collectionComponent.listen(sortControls,"notFound",function(){collectionComponent.$el.hide();notFound.render();notFound.$el.show()})},nameForType:function(type){switch(type){case"a":return t("Album");case"r":return t("Artist");case"p":return t("Playlist");case"t":return t("Song");case"s":return t("Profile")}},setCursor:function(el,position){var $el=$(el);if(!$el.length){throw new Error("Must provide an element to setCursor on")}el=$el[0];if(!_.isUndefined(el.selectionStart)){el.selectionStart=el.selectionEnd=position}else if(el.createTextRange){var range=el.createTextRange();range.move("character",position);range.select()}return $el},parseTimeString:function(timeString){var milliseconds=0;var timeStringIn=timeString;if(/\./.test(timeStringIn)){var splitResult=timeStringIn.split(".");if(splitResult.length===2){timeStringIn=splitResult[0];if(_.isNaN(parseInt(splitResult[1],10))){return null}milliseconds=parseFloat("0."+splitResult[1],10)}else{return null}}var totalSeconds;var hours,minutes,seconds;var splitResult;if(/:/.test(timeStringIn)){splitResult=timeStringIn.split(":");if(splitResult.length===3){hours=parseInt(splitResult[0],10);minutes=parseInt(splitResult[1],10);seconds=parseInt(splitResult[2],10)}else if(splitResult.length===2){hours=0;minutes=parseInt(splitResult[0],10);seconds=parseInt(splitResult[1],10)}else{return null}if(_.isNaN(hours)||_.isNaN(minutes)||_.isNaN(seconds)){return null}if(minutes>=60||seconds>=60){return null}totalSeconds=3600*hours+60*minutes+seconds}else{totalSeconds=parseInt(timeString,10);if(_.isNaN(totalSeconds)){return null}}return totalSeconds+milliseconds},toTimeString:function(seconds,trimHours){var withLeadingZeros=function(n){if(n<10){return"00"+n}else if(n<100){return"0"+n}else{return""+n}};var withLeadingZero=function(n){if(n<10){return"0"+n}else{return""+n}};var hours;var minutes;var sec=seconds;var resultString;hours=Math.floor(sec/3600);sec=sec-hours*3600;minutes=Math.floor(sec/60);sec=Math.floor(sec-minutes*60);var hoursString=trimHours?hours>=1?hours+":":"":withLeadingZero(hours)+":";resultString=hoursString+withLeadingZero(minutes)+":"+withLeadingZero(sec);if(seconds%1>0){var milliseconds=Math.round(seconds%1*1e3);resultString+="."+withLeadingZeros(milliseconds)}return resultString},chunk:function(array,chunkLength){return _.values(_.groupBy(array,function(item,i){return Math.floor(i/chunkLength)}))},isExtraExclusion:function(extra){var isExclusion=false;var field=extra;if(_.isObject(extra)){isExclusion=extra.exclude;field=extra.field}return isExclusion||field.charAt(0)==="-"},initCanvas:function(canvas){if(!Modernizr.canvas&&!_.isUndefined(window.G_vmlCanvasManager)){canvas=window.G_vmlCanvasManager.initElement(canvas)}return canvas},getVersionedFlashUrl:function(flashFile){var base=R.serverInfo.get("flashMediaUrl");var url=base+"flash/"+flashFile;var versions=R.serverInfo.get("resourceVersions");var version=versions?versions[flashFile]:null;if(version){url+="?"+version}return url},getWorkerUrl:function(){return _.chain(Env.target.worker).map(function(group){return _.map(group[1],function(name){return group[0]+name})}).flatten().uniq().first().value()},whenAll:function(promises){var deferreds=[];var successes=[];var failures=[];_.each(promises,function(promise){var deferred=$.Deferred();deferreds.push(deferred);promise.done(function(){successes.push(promise)}).fail(function(){failures.push(promise)}).always(deferred.resolve)});return $.when.apply($,deferreds).pipe(function(){var final=$.Deferred();var method=failures.length?"reject":"resolve";final[method]([successes,failures]);return final.promise()})},remapObjectKeys:function(obj,map){var result={};_.each(obj,function(val,key){key=_.has(map,key)?map[key]:key;result[key]=val});return result},getQueryStringParams:function(rawQueryString){if(_.isUndefined(rawQueryString)&&window){rawQueryString=R.Utils.getWindowLocation().href}var queryString=rawQueryString+"";if(!queryString.length){return{}}var qi=queryString.indexOf("?");if(qi===-1){return{}}queryString=queryString.substring(qi+1);return _.reduce(queryString.split("&"),function(params,paramStr){var paramPair=paramStr.split("=");params[paramPair[0]]=decodeURIComponent(paramPair[1]);return params},{})},makeQueryString:function(paramsObj){var params=_.keys(paramsObj);return _.reduce(params,function(queryString,key,i){queryString+=key+"="+encodeURIComponent(paramsObj[key]);if(i<params.length-1){queryString+="&"}return queryString},"?")},convertToModelOverride:function(prop){var _prop="__"+prop;return{get:function(){if(!this[_prop]){this[_prop]=R.Utils.convertToModel(this.attributes[prop])}return this[_prop]},set:function(newValue){if(this[_prop]&&newValue&&(!newValue.type||newValue.type===this[_prop].get("type"))){this[_prop].set.apply(this[_prop],arguments)}else{this[_prop]=R.Utils.convertToModel(newValue)}}}},invokeIpadAppSelector:function(selector,args){_.defer(function(){var methodData={selector:selector,args:args};document.location="ipad://?"+JSON.stringify(methodData)})},getComponentResourcePath:function(component){var base=COMPONENT_BASE+component;var version=R.Services.Updater.model.get("components").get(component);return base+"."+version+".js"},_desktopVersionRegExp:/.*?com\.rdio\.desktop\.(\w+).*?\/([\d\.]+).*?$/,getDesktopAppVersion:function(navigator){var groups=this._desktopVersionRegExp.exec(navigator.userAgent);if(groups&&groups.length===3){var subVersions=_.map(groups[2].split("."),function(v){return parseInt(v,10)});return{major:subVersions[0],minor:subVersions[1]}}else{return null}},isPositiveNumber:function(v){return _.isNumber(v)&&!_.isNaN(v)&&v>0},checkPagingIndex:function(paging){var result=paging||{start:0,count:10};if(result.start<0){result.count+=result.start;result.start=0}return result},canUseScrollable:function(){if(R.isMobile||R.isMacDesktop){return false}var env=R.Utils.getUserEnvironment(navigator);if(env.operatingSystem==="Mac"&&env.browser==="Firefox"&&env.browserVersion>=24){return false}return true},isInstanceOf:function(object){return _.any(_.tail(arguments),function(constructor){return _.isFunction(constructor)&&object instanceof constructor})},getDevicePixelRatio:function(){return window.devicePixelRatio||1},getCanvasContextBackingStorePixelRatio:function(ctx){return ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1},getCanvasContextScalingRatio:function(ctx){return R.Utils.getDevicePixelRatio()/this.getCanvasContextBackingStorePixelRatio(ctx)},isRetina:function(){return R.Utils.getDevicePixelRatio()>1},redirectAnonPlayToSignup:function(e){R.Utils.stopEvent(e);var tc=e.targetComponent;var source=tc&&tc.options&&R.Utils.convertToModel(tc.options.source);var url;var qsParams;if(source&&source.get){url=_.isString(source.get("url"))?source.get("url"):"/";qsParams=R.Services.AutoPlay.paramsForModel(source,tc.options.index);url+=R.Utils.makeQueryString(qsParams)}R.Utils.redirectToSignup(url)}});R.Utils.ensureHtml5Elements()}(R.$);!function($){R.ImageUtils={getThorImageserverUrl:function(layers,width,height,quality){var layerString;if(_.isArray(layers)){layerString=_.map(layers,function(layer){if(_.isArray(layer)){return layer.join(":")}else if(_.isString(layer)){return layer}else{return""}}).join(";")}else if(_.isString(layers)){layerString=layers}else{layerString=""}var params={};if(layerString){_.extend(params,{l:layerString})}if(width||height){_.extend(params,{w:width||height,h:height||width})}if(quality){_.extend(params,{c:quality})}var queryString=R.Utils.makeQueryString(params);var url=R.ImageUtils._buildFullThorUrl(queryString);return R.Utils.secureFixup(url)},getGridLayers:function(keys,gridItemSize){var layers=[];var grid=[];_.each(keys,function(key,i){layers.push(R.ImageUtils._getSquareImagePath(gridItemSize,key.id,key.version));grid.push("$"+i)});grid="grid("+grid.join(",")+")";return layers.concat([grid])},_getSquareImagePath:function(size,id,version){if(version>0){return"album/"+R.ImageUtils._getIdHash(id)+"/"+version+"/square-"+size+".jpg"}return"album/"+R.ImageUtils._getIdHash(id)+"/square-"+size+".jpg"},getPlaylistAlbumIdsAndVersions:function(icon){var m=new RegExp(/.*aid=([\d\-,]*)/g).exec(icon);if(m&&m.length==2&&m[1]){var parts=m[1].split(",");var keys=[];for(var i=0;i<parts.length;++i){var key=parts[i].split("-");keys.push({id:parseInt(key[0]),version:parseInt(key[1])})}return keys}else{return null}},_getIdHash:function(id){id=id.toString(16);var pad="0000000000000000";id=pad.substring(0,pad.length-id.length)+id;var p1=id.charAt(id.length-1);var p2=id.charAt(id.length-2);var p3=id.charAt(id.length-3);return[p1,p2,p3,id].join("/")},_buildFullThorUrl:function(queryString){var safeQueryString=queryString.replace(/\(/g,"%28").replace(/\)/g,"%29");var unsafeQueryString=decodeURIComponent(safeQueryString);var letter_sum=0;for(var i=0;i<unsafeQueryString.length;i++){letter_sum+=unsafeQueryString.charCodeAt(i)}var availableUrls=R.serverInfo.get("thorImageserverUrls");return availableUrls[letter_sum%availableUrls.length]+safeQueryString},getPredominantColorSrc:function(filename,opacity){var params={m:filename,color:parseInt(opacity*255)};var queryString=R.Utils.makeQueryString(params);var url=R.ImageUtils._buildFullThorUrl(queryString);return R.Utils.secureFixup(url)},createLayers:function(base,layers){var baseArray=R.Utils.array(base);if(!_.isArray(layers)){console.error("The layers needs to be an array");return baseArray}return baseArray.concat(layers)},default_layers:{BACKGROUND_BLUR_200:["zoom(30%)","boxblur(10px, 10px)","colorize(rgba(0, 0, 0, 0.2))"],BACKGROUND_BLUR_400:["zoom(30%)","boxblur(20px, 20px)","colorize(rgba(0, 0, 0, 0.2))"]}}}(R.$);!function(){Modernizr.addTest("typedarrays","ArrayBuffer"in window);Modernizr.addTest("history",window.history&&window.history.pushState&&!navigator.userAgent.match(/Android 2.[23]/));!function(){if(R.isIE11||!(Modernizr.canvas&&Modernizr.cors)){Modernizr.addTest("corsimagedata",false);return}var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");var img=R.Utils.loadCORSImage("//rdio-a.akamaihd.net/media/images/2/tiny.gif",function(){canvas.width=img.width;canvas.height=img.height;ctx.drawImage(img,0,0);try{ctx.getImageData(0,0,canvas.width,canvas.height);Modernizr.addTest("corsimagedata",true)}catch(err){Modernizr.addTest("corsimagedata",false)}})}();!function(){var buffer,worker;try{if(Modernizr.webworkers&&Modernizr.typedarrays){var workerUrl=R.Utils.getWorkerUrl();if(workerUrl){buffer=new ArrayBuffer(1);worker=new Worker(workerUrl);worker.postMessage({data:buffer},[buffer]);worker.terminate();if(buffer.byteLength===0){Modernizr.addTest("transferableobjects",true);return}}}Modernizr.addTest("transferableobjects",false)}catch(e){Modernizr.addTest("transferableobjects",false)}finally{if(worker&&worker.terminate){try{worker.terminate()}catch(e){}}buffer=worker=null}}();Modernizr.addTest("webintents",function(){return!!navigator.startActivity})}.call(this);!function(serverInfo){var utils;function format(word,value){return value+" "+word+utils.pluralize(value)}var types={t:"song",a:"album",p:"playlist",r:"artist",s:"user",al:"album",l:"label",sc:"review"};Bujagali.mixin({imageTag:function(config){config=_.extend({w:35,h:35},config);var m=config.m;var w="&w="+config.w;var h="&h="+config.h;var rc=config.rc?"&rc="+config.rc:"";var ov=config.ov?"&ov="+config.ov:"";var classes=config.className?' class="'+config.className+'"':"";var alt=config.alt?' alt="'+config.alt+'"':"";var id=config.id?' id="'+config.id+'"':"";if(!m){if(typeof onerror!="undefined"){onerror("undefined image in "+(this.name||arguments.caller),"","");return""}}return['<img src="',serverInfo().is_address,"?m=",m,w,h,ov,rc,'"',classes,alt,id,' width="',config.w,'" height="',config.h,'" />'].join("")},image:function(config){config=_.extend({w:35,h:35},config);return['<img src="',config.u,'"',' width="',config.w,'" height="',config.h,'" />'].join("")},dateDisplay:function(date){if(date instanceof Date){date=Bujagali.Utils.toISOString(date)}return'<span class="relative_date" title="'+date+'">'+date+"</span>"},dateRange:function(d1,d2){if(!d1||!d2){return""}d1=d1.valueOf()/1e3;d2=d2.valueOf()/1e3;var range=d2-d1;var seconds=range%60;var minutes=Math.floor(range/60)%60;var hours=Math.floor(range/3600)%24;var days=Math.floor(range/86400);var months=Math.floor(range/2592e3);var years=Math.floor(range/31536e3);if(years){return I18n.translate(["[num] year","[num] years"],{num:years})}if(months){return I18n.translate(["[num] month","[num] months"],{num:months})}if(days){return I18n.translate(["[num] day","[num] days"],{num:days})}if(hours){return I18n.translate(["[num] hour","[num] hours"],{num:hours})}if(minutes){return I18n.translate(["[num] minute","[num] minutes"],{num:minutes})}if(seconds){return I18n.translate(["[num] second","[num] seconds"],{num:seconds})}},shortName:function(user,unescaped){if(user.attributes){user=user.attributes}var name=user.firstName||user.lastName||user.email||"";name=name.trim();if(unescaped){return name}return utils.escape(name)},userForm:function(user,notYou){var isSelf;if(R.currentUser){isSelf=user.isSelf&&_.isBoolean(user.isSelf)||user.key==R.currentUser.get("key")||user.get&&user.get("key")==R.currentUser.get("key")}else{isSelf=user.isSelf||user.id==clientManager.current_user.id}return isSelf&&!notYou?"y":user.gender?user.gender.toLowerCase():user.get("gender").toLowerCase()},possessivePronoun:function(user){switch(user.gender){case"m":case"M":return"his";case"f":case"F":return"her";default:return"their"}},possessiveName:function(name){if(name.match("s$")===null){name=name+"'s"}else{name=name+"'"}return utils.escape(name)},possessiveUserName:function(user){if(user.isSelf||user.id===clientManager.current_user.id){return"Your"}else{return utils.possessiveName(utils.shortName(user,true))}},resizedImage:function(image_url,w,h,rc,ov){var rv=serverInfo().is_address+"?m="+encodeURIComponent(image_url);if(w){rv+="&w="+w}if(h){rv+="&h="+h}if(rc){rv+="&rc="+rc}if(ov){rv+="&ov="+ov}return rv},prettyType:function(t){if(t){return types[t]||"station"}},pluralize:function(num,suffix){if(num>1||num===0){return suffix||"s"}else{return""}},zeroPad:function(num){if(num<10){return"0"+num}else{return num}},_secondsToTime:function(s){return{seconds:s%60,minutes:Math.floor(s/60)%60,hours:Math.floor(s/3600)}},formatSeconds:function(s){var time=this._secondsToTime(s);return(time.hours>=1?time.hours+":":"")+(time.hours>=1?this.zeroPad(time.minutes)+":":time.minutes>=1?time.minutes+":":"0:")+this.zeroPad(time.seconds)},formatSecondsWithAbbr:function(s){var time=this._secondsToTime(s);if(time.hours==1){if(time.minutes==1){return t("[ hours ] hr [ minutes ] min",time)}else{return t("[ hours ] hr [ minutes ] mins",time)}}else if(time.hours>1){if(time.minutes==1){return t("[ hours ] hrs [ minutes ] min",time)}else{return t("[ hours ] hrs [ minutes ] mins",time)}}else{if(time.minutes==1){return t("[ minutes ] min",time)}else{return t("[ minutes ] mins",time)}}},formatPlayCount:function(c){var isMillions=false;if(c>=1e6){c=Number((c/1e6).toFixed(1));isMillions=true}return I18n.number(c)+(isMillions?"M":"")},getGenderForm:function(collection,genderAccessor){var form="m";var length=R.Utils.value.call(collection,collection.length);if(length>1){var genders=_.compact(_.uniq(collection.map(genderAccessor)));if(genders.length>1){form="v"}else if(genders[0]){form="v"+genders[0]}}else{form=genderAccessor(collection.last())}return form},url:function(object,suburl){if(arguments.length==1){suburl=""}if(object=="management-subscriptions"){return"/management/subscriptions/"}if(suburl===""){return object.url}if(object.type=="s"){if(suburl=="collection"){return object.url+"collection/"}}return""}});utils=Bujagali.Utils}(function(){return R.serverInfo?R.serverInfo.attributes:server_info});!function(){R.CollectionUtils={model:R.Models.ObjectModel,addField:function(field){var modelsToUpdate=this.reject(function(model){return model.has(field)||!model.addField});var deferreds=_.map(modelsToUpdate,function(model){return model.addField(field)});return $.when(deferreds)},addFields:function(fields){var modelsToUpdate=this.reject(function(model){if(!model.addFields){return true}return _.all(fields,function(field){return model.has(field)})});var deferreds=_.map(modelsToUpdate,function(model){return model.addFields(fields)});return $.when(deferreds)}}}();!function(){var wrapError=function(onError,model,options){return function(resp){model.loading--;if(onError){onError(model,resp,options)}else{model.trigger("error",model,resp,options)}}};var overlaps=function(r1,r2){return r1.start>=r2.start&&r1.start<=r2.end||r2.start>=r1.start&&r2.start<=r1.end};var contains=function(r1,r2){return r1.start<=r2.start&&r1.end>=r2.end};function getItems(data){if(!data){return[]}if(_.isArray(data)){return data}else if(data.models){return data.models}else if(data.apps){return data.apps}else{return data.items}}R.Models.SparseCollection=function(models,options){this.options=options||{};_.defaults(this.options,{fetch:true,limit:null});this.limit(this.options.limit);if(this.options.model){this.model=this.options.model}this.reset(models,{silent:true});this._pendingFetches=[];this.loading=0;this.initialize.apply(this,arguments)};_.extend(R.Models.SparseCollection,{extend:Backbone.Collection.extend,factory:function(c){c=c||this;return function(data,options){var limit=data?data.total:null;var items=getItems(data);options=_.extend({limit:limit},options);return new c(items,options)}}});_.extend(R.Models.SparseCollection.prototype,R.CollectionUtils,Backbone.Events,{length:function(){if(!this.models){return 0}return this.models.length},initialize:function(){_.bindAll(this,"length")},reviver:null,at:function(index){return this.get({start:index,count:1})[0]},_markSparseAborted:function(range){for(var i=range.start;i<range.start+range.count;i++){if(this.models[i]){this.models[i]._sparseAborted=true}}},_createNewModelAt:function(i){var model;if(this.model){model=new this.model}else{model=new R.Model}this.add(model,{at:i,replace:true});return model},_prepareFetchParams:function(options){var result=[];var fetchStart=options.start;var fetchEnd=options.start+options.count-1;var needsFetch=false;var model;var i;function shouldFetch(i){if(!needsFetch){fetchStart=i}else{fetchEnd=i}needsFetch=true}this._startManipulating();if(!this.appendOnly){for(i=options.start;i<options.start+options.count;i++){model=this.models[i];if(!model){model=this._createNewModelAt(i);shouldFetch(i)}else if(model._sparseAborted){model._sparseAborted=false;shouldFetch(i)}result.push(model)}}else{fetchStart=this.length();needsFetch=true}this._stopManipulating();return{result:result,needsFetch:needsFetch,fetchStart:fetchStart,fetchEnd:fetchEnd}},_filterPendingFetches:function(options,fetchStart,fetchEnd){var needsFetch=true;var getRange={start:options.start,end:options.start+options.count-1};this._pendingFetches=_.filter(this._pendingFetches,function(xhr){if(!xhr){return false}if(!needsFetch){return true}if(!xhr._startedByGet){return true}var range=xhr._sparseRange;if(!range){return true}var newFetchRange={start:fetchStart,end:fetchEnd};var pendingRange={start:range.start,end:range.start+range.count-1};var shouldKeepPending=true;if(!overlaps(pendingRange,getRange)){this._markSparseAborted(range);xhr.abort();shouldKeepPending=false}else if(contains(pendingRange,newFetchRange)){this._markSparseAborted({start:fetchStart,count:fetchEnd-fetchStart+1});needsFetch=false}else if(contains(newFetchRange,pendingRange)){this._markSparseAborted(range);xhr.abort();shouldKeepPending=false}else if(pendingRange.start<=newFetchRange.start&&newFetchRange.start<pendingRange.end){this._markSparseAborted({start:fetchStart,count:pendingRange.end-fetchStart});fetchStart=pendingRange.end+1;needsFetch=fetchStart<fetchEnd}else if(newFetchRange.start<=pendingRange.start&&newFetchRange.end>pendingRange.start){fetchEnd=Math.max(0,pendingRange.end-1);needsFetch=fetchStart<fetchEnd}return shouldKeepPending},this);return{needsFetch:needsFetch,fetchStart:fetchStart,fetchEnd:fetchEnd}},_get:function(options){var fetchParams=this._prepareFetchParams(options);var result=fetchParams.result;var needsFetch=fetchParams.needsFetch;var fetchStart=fetchParams.fetchStart;var fetchEnd=fetchParams.fetchEnd;var filterResult;var request;if(needsFetch){filterResult=this._filterPendingFetches(options,fetchStart,fetchEnd);needsFetch=filterResult.needsFetch;fetchStart=filterResult.fetchStart;fetchEnd=filterResult.fetchEnd;if(needsFetch){if(this.appendOnly){request=this.fetch({config:options.config,at:fetchStart,success:options.success})}else{request=this._chunkFetch({start:fetchStart,count:fetchEnd-fetchStart+1,chunk:options.chunk,at:fetchStart,config:options.config},options.success)}if(request){request._startedByGet=true}}}return result},get:function(options){if(!this.options.fetch){return[]}options=R.Utils.checkPagingIndex(options);if(options.count<1){return[]}if(this.appendOnly){if(this.hasFetchedToEnd()){return[]}if(options.start&&options.count){return this.models.slice(options.start,options.start+options.count)}}else if(!_.isNull(this._limit)){if(options.start>=this._limit){return[]}if(options.start+options.count>this._limit){options.count=this._limit-options.start}}return this._get(options)},_getModelsExistRange:function(){var modelsExistRange=_.reduce(this._pendingFetches,function(rangeObj,xhr){if(xhr._sparseRange){for(var i=xhr._sparseRange.start;i<xhr._sparseRange.start+xhr._sparseRange.count;i++){rangeObj[i]=true}}return rangeObj},{});_.each(this.models,function(model,i){if(_.size(model.attributes)){modelsExistRange[i]=true}});return modelsExistRange},_chunkFetch:function(config,success){var self=this;var limit=this.limit();var fetchStart;
var fetchEnd;var existingRange;var request;var nextStart;var nextCount;var nextChunk;if(!_.isNumber(config.chunk)){request=this.fetch({config:config,at:config.at,success:success})}else if(config.chunk>=config.count){fetchStart=config.start;fetchEnd=config.start+config.count-1;existingRange=this._getModelsExistRange();this._startManipulating();while(limit&&fetchEnd<limit-1&&!existingRange[fetchEnd+1]&&fetchEnd-fetchStart+1<config.chunk){fetchEnd+=1;if(!this.models[fetchEnd]){this._createNewModelAt(fetchEnd)}}while(fetchStart>0&&!existingRange[fetchStart-1]&&fetchEnd-fetchStart+1<config.chunk){fetchStart-=1;if(!this.models[fetchStart]){this._createNewModelAt(fetchStart)}}this._stopManipulating();config.start=fetchStart;config.count=fetchEnd-fetchStart+1;request=this.fetch({config:config,at:config.start,success:success})}else{nextStart=config.start+config.chunk;nextCount=config.count-config.chunk;nextChunk=config.chunk;config.count=config.chunk;this._markSparseAborted({start:nextStart,count:nextCount});request=this.fetch({config:config,at:config.start,success:function(){self.get({start:nextStart,count:nextCount,chunk:nextChunk,success:success})}})}if(request){request._sparseRange={start:config.start,count:config.count}}return request},hasFetchedToEnd:R.doNothing,fetch:function(options){options=options||{};var self=this;var success=options.success;var request;options.config=_.omit(options.config,"at","chunk");options.success=function(resp,status,xhr){self._pendingFetches=_.without(self._pendingFetches,request);var newModels=self.set(self.parse(resp),options);self.trigger("loaded",resp,newModels);self.loading--;if(success){success(self,resp,newModels)}};options.error=wrapError(options.error,this,options);request=Backbone.sync.call(this,"read",this,options);if(request){this._pendingFetches.push(request);this.trigger("load");this.loading++}return request},parse:function(data){if(data&&_.isNumber(data.total)){this.limit(data.total)}return getItems(data)},set:function(models,options){var i,model,newModel,resultModels=[];options=_.extend({at:0},options);models=R.Utils.array(models);this._startManipulating();for(i=0;i<models.length;i++){model=this.models[options.at+i];if(!model){newModel=this.prepModel(models[i]);this.add(newModel,_.extend({},options,{at:options.at+i,replace:true}))}else{newModel=this.prepModel(models[i]);if(newModel.constructor==model.constructor&&!(newModel instanceof R.Models.SparseCollection)){model.set(models[i])}else{this.remove(model,{at:options.at+i});this.add(newModel,{at:options.at+i})}}resultModels.push(newModel)}if(options.config&&options.config.count&&models.length<options.config.count){console.log("[SparseCollection] got a partial result, EOF");var newLength=options.at+models.length;while(this.size()>newLength){if(this.models[newLength]&&_.isEmpty(this.models[newLength].attributes)){this.remove(this.models[newLength],{at:newLength})}else{++newLength}}this.limit(options.at+models.length);this.models.splice(options.at+models.length,this.models.length)}this._stopManipulating();return resultModels},reset:function(models,opts){opts=_.extend({at:0,silent:false},opts);if(models&&models.meta){this.meta=models.meta}models=getItems(models);_.each(this._pendingFetches,function(xhr){if(xhr){xhr.abort()}});this._pendingFetches=[];this.models=[];if(models){this.add(models,{at:opts.at,silent:true})}if(!this.options.fetch){this._limit=this.models.length}if(!opts.silent){this.trigger("reset")}return true},limit:function(limit,opts){if(!_.isUndefined(limit)&&limit!==this._limit){this._limit=limit;if(limit<this.length()){var extraModels=this.length()-limit;var start=limit-1;for(var i=extraModels;i>0;i--){this.remove(this.models[start+i])}}opts=opts||{};if(!opts.silent){this.trigger("limit",limit)}}return this._limit},getModelClass:function(){return this.model},prepModel:function(maybeAttributes){var model=this.getModelClass();if(model){if(maybeAttributes instanceof model){return maybeAttributes}return new model(maybeAttributes)}return R.Utils.convertToModel(maybeAttributes)},content:function(config){return config},getByCid:function(cid){return this.find(function(model){return model.cid==cid},this)},_collectionChanged:function(type,model,options){var manipulating=this._manipulating;if(!manipulating){this._startManipulating()}if(type=="add"){this._addsToFire.push([model,options])}else if(type=="remove"){this._removesToFire.push([model,options])}if(!manipulating){this._stopManipulating()}},_startManipulating:function(){this._manipulating=true;this._addsToFire=[];this._removesToFire=[];this.trigger("manipulating")},_stopManipulating:function(){var self=this;this._manipulating=false;_.each(self._addsToFire,function(args){var model=args[0];var options=args[1];model.trigger("add",model,self,options)});_.each(self._removesToFire,function(args){var model=args[0];var options=args[1];model.trigger("remove",model,self,options)});this._addsToFire=null;this._removesToFire=null;this.trigger("stopManipulating")},add:function(models,options){options=_.extend({at:this.length()},options);models=R.Utils.array(models);var index=options.at;var self=this;var limit=this.limit();_.each(models,function(model){if(!(model instanceof R.Model)){model=self.prepModel(model)}if(self.length()<index){self.models[index]=model}else{self.models.splice(index,options.replace?1:0,model)}model.collection=self;model.bind("all",self._onModelEvent,self);if(!options.silent){options.index=index;self._collectionChanged("add",model,options)}index++});if(limit!==null&&limit<this.length()){this.limit(this.length(),{silent:true})}},remove:function(models,options){models=R.Utils.array(models);options=options||{};var self=this;var index=options.at||_.indexOf(this.models,models[0]);var limit=this.limit();var shouldUpdateLimitAfterRemoval=limit===this.length();_.each(models,function(model){model.collection=null;self.models.splice(index,1);if(!options.silent){options.index=index;self._collectionChanged("remove",model,options)}model.unbind("all",self._onModelEvent,self)});if(shouldUpdateLimitAfterRemoval){this.limit(limit-models.length,{silent:true})}},hasGaps:function(){for(var i=0;i<this.models.length;i++){if(!this.models[i]){return true}}return false},loadedSize:function(){return this.filter(function(m){return m&&_.size(m.attributes)}).length},_onModelEvent:function(ev,model,collection,options){if(ev=="load"||ev=="loaded"){return}if((ev=="add"||ev=="remove")&&collection!=this){return}if(ev=="destroy"){this.remove(model,options)}this.trigger.apply(this,arguments)},pluck:function(attr){return this.map(function(model){return model.get(attr)})}});var methods=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty","groupBy"];_.each(methods,function(method){R.Models.SparseCollection.prototype[method]=function(){return _[method].apply(_,[this.models].concat(_.toArray(arguments)))}});R.Models.FilterableCollection=R.Models.SparseCollection.extend({initialize:function(){R.Models.SparseCollection.prototype.initialize.apply(this,arguments);this._sort=this.options.sort;this._query=this.options.filter},content:function(config){return _.extend({sort:this._sort||this.defaultSort,query:this._query},config)},setFilter:function(filter){if(filter===this._query){return}this._query=filter;this.reset()},getFilter:function(){return this._query},setSort:function(newSort){if(newSort===this._sort){return}this._sort=newSort},getSort:function(){return this._sort}});R.Models.MusicCollection=R.Models.FilterableCollection.extend({defaultSort:"playCount",sortOptions:[{value:"",label:t("Most Popular")},{value:"name",label:t("Name")},{value:"releaseDate",label:t("Release Date")}]});R.Models.CursorBasedSparseCollection=R.Models.SparseCollection.extend({collectionFactoryClass:R.Models.CursorBasedSparseCollection,loadMethod:null,pagingMethod:null,extraMetaFields:null,initialize:function(models,options){R.Models.SparseCollection.prototype.initialize.apply(this,arguments);_.bindAll(this,"reviver");if(this.options.meta){this.meta=this.options.meta}},method:function(){if(this.pagingMethod&&this.length()>0){return this.pagingMethod}return this.loadMethod},get:function(options){options=options||{};if(this.meta&&this.meta.cursor){options.config={cursor:this.meta.cursor}}return R.Models.SparseCollection.prototype.get.call(this,options)},content:function(options){return{cursor:options.config?options.config.cursor:null}},parse:function(data){if(data&&_.isNumber(data.total)){this.limit(data.total)}this.meta=R.Models.CursorBasedSparseCollection.preserveMeta(data,this.extraMetaFields);return getItems(data)},limit:function(limit,opts){if(!limit&&this.meta){return this.meta.limit}else{R.Models.SparseCollection.prototype.limit.apply(this,arguments)}},reviver:function(prop,value){if(value&&value.type==="list"&&prop!=="result"){if(value.cursor){return new(R.Models.CursorBasedSparseCollection.factory(null,this.extraMetaFields))(value)}else{return new(R.Models.ModelFieldCollection.factory())(value,{parentProperty:prop})}}return value}},{factory:function(c,extraMetaFields){c=c||this;return function(data,options){var items=getItems(data);options=options||{};options.meta=R.Models.CursorBasedSparseCollection.preserveMeta(data,extraMetaFields);return new c(items,options)}},preserveMeta:function(data,extraMetaFields){var metaKeys=["total","cursor"];if(extraMetaFields){metaKeys=_.union(metaKeys,extraMetaFields)}var metaData={};if(data){_.each(metaKeys,function(key){if(data[key]){metaData[key]=data[key]}});if(metaData.total){metaData.limit=metaData.total;delete metaData.total}}return metaData}})}();!function(){var mProto=Backbone.Model.prototype;R.Model=Backbone.Model.extend({overrides:{},_refCount:0,constructor:function(attrs,options){var args=_.toArray(arguments);if(attrs instanceof Backbone.Model){args[0]=attrs=attrs.attributes;console.warn("Backbone.Model no longer accepts another model as an argument - use attributes instead.")}return Backbone.Model.apply(this,args)},initialize:function(attrs,options){var self=this;this.options=options||{};this._extras=_.clone(R.Utils.value(this.extras))||[];if(this.options.extras){this._extras=this._extras.concat(this.options.extras)}this.overrides=_.extend({},this.overrides);_.each(self.overrides,function(override,prop){if(_.isString(override)){self.overrides[prop]={get:self[override]}}else if(_.isFunction(override)){var privateProp="__"+prop;var getter=function(){var instance,options;if(!self[privateProp]){options={parentModel:self,parentProperty:prop};if(override.factory){instance=override.factory()(self.attributes[prop],options)}else{instance=new override(self.attributes[prop],options)}self[privateProp]=instance;delete self.attributes[prop]}return self[privateProp]};var setter=function(newVal,options){var prop=self[privateProp];if(prop){if(newVal&&newVal.models){if(prop.constructor==newVal.constructor){prop.reset(newVal.models,options)}else if(prop instanceof prop.constructor){prop.reset(newVal.models,options)}else{console.error("Tried to reset ",prop," with ",newVal);throw new Error("Collection constructors do not match.")}}else{if(prop.reset){prop.reset(newVal,options)}else if(prop.set){if(newVal){prop.set(newVal,options)}else{prop.clear()}}}}};self.overrides[prop]={get:getter,set:setter}}});mProto.initialize.apply(this,arguments)},isNew:function(){return!this.has("key")},get:function(prop){var override=this.overrides[prop];if(override){return override.get.call(this,prop)}else if(this.attributes[prop]instanceof R.Models.ModelFieldCollection){this.attributes[prop].parentModel(this)}return mProto.get.call(this,prop)},set:function(prop,value,options){var self=this;var attrs=prop;if(_.isString(attrs)){attrs={};attrs[prop]=value}else{options=value;if(attrs instanceof Backbone.Model){attrs=attrs.attributes}}for(prop in attrs){if(_.has(attrs,prop)){var attrValue=attrs[prop];var override=self.overrides[prop];if(override&&override.set){override.set.call(self,attrValue,options)}else if(self.attributes&&self.attributes[prop]instanceof R.Models.ModelFieldCollection&&!_.isNull(attrValue)&&!_.isUndefined(attrValue)){self.attributes[prop].reset(attrValue.models);self.attributes[prop].limit(attrValue.limit());delete attrs[prop]}}}return mProto.set.call(this,attrs,options)},unset:function(prop,options){var shadow="__"+prop;if(this[shadow]){this[shadow]=null}return mProto.unset.apply(this,arguments)},clear:function(){var self=this;_.each(this.overrides,function(value,prop){var shadow="__"+prop;if(self[shadow]){self[shadow]=null}});return mProto.clear.apply(this,arguments)},clone:function(){var newModel=Backbone.Model.prototype.clone.apply(this,arguments);_.each(this,function(v,k){if(this.hasOwnProperty(k)&&k.indexOf("__")===0){newModel[k]=v}},this);return newModel},reference:function(){this.onReferenced(++this._refCount);return this._refCount},release:function(){if(this._refCount){this._refCount--}else{console.warn("Model released when the reference count is already 0.")}this.onReleased(this._refCount);return this._refCount},onReferenced:R.doNothing,onReleased:R.doNothing},{factory:R.Utils.factory});Backbone.sync=function(crudMethod,model,options){if(!model.method){return}var config=options.config||{};var content;if(model.content){if(_.isFunction(model.content)){content=model.content.call(model,config)}else{content=model.content[crudMethod].call(model,config)}}content=_.isUndefined(content)?{}:content;var method=model.method;if(_.isObject(method)&&!_.isFunction(method)){method=model.method[crudMethod]}if(_.isFunction(method)){method=method.call(model)}var ajaxConfig=_.extend({method:method,content:content},options);if(model.reviver){ajaxConfig.reviver=model.reviver}ajaxConfig.success=function(result){if(result.result===true){return options.success()}else{return options.success(result.result)}};ajaxConfig.error=function(result){if(options.error){return options.error(result)}};return R.Api.request(ajaxConfig)};R.Models.ModelFieldCollection=R.Models.SparseCollection.extend({method:"get",content:function(config){var extras={field:this._parentProperty,start:config.start,count:config.count,sort:config.sort||this.sort};if(this.extras){extras.extras=this.extras}return{keys:this._parentModel.get("key"),extras:[{field:"*",exclude:true},extras]}},parse:function(data){var collection=data[this._parentModel.get("key")][this._parentProperty];this.limit(collection.limit());return collection.models},initialize:function(models,options){R.Models.SparseCollection.prototype.initialize.apply(this,arguments);this._parentProperty=options.parentProperty;this._parentModel=options.parentModel},parentModel:function(model){if(arguments.length){this._parentModel=model}return this._parentModel},toJSON:function(){return{type:"list",items:this.models,total:this.limit()}},setSort:function(sort){this.sort=sort;this.reset()}});R.Models.CompositeModel=Backbone.Model.extend({initialize:function(attrs,options){this._innerModelNames=options.innerModelNames},shouldFetch:true,fetch:function(options){var self=this;var outerSuccess=_.isFunction(options.success)?options.success:R.doNothing;var outerError=_.isFunction(options.error)?options.error:R.doNothing;var success=_.after(_.size(this._innerModelNames),function(){outerSuccess(self)});_.each(this._innerModelNames,function(modelAttr){self.get(modelAttr).fetch({success:success,error:outerError})})},getInnerModels:function(){var innerModelNames=this._innerModelNames;return _.filter(this.attributes,function(value,attrName){return _.include(innerModelNames,attrName)})}})}();!function(){R.Models.ObjectModel=R.Model.extend({initialize:function(attributes,options){R.Model.prototype.initialize.apply(this,arguments);_.bindAll(this,"onFieldsChanged","addFieldRefs","_referenceField","removeField");this._initExtras(options);this.trackedFields={};this._isClaimed=false;if(this.parse&&this.parse!==R.Models.ObjectModel.prototype.parse){this._originalParse=this.parse}},_initExtras:function(options){this._extras={};_.each(_.clone(R.Utils.value(this.extras)),function(field){this._extras[_.isObject(field)?field.field:field]=field},this);this._extraRefs={};if(options&&options.extras){_.each(options.extras,function(field){this._extras[_.isObject(field)?field.field:field]=field},this)}_.each(this._extras,function(field,fieldName){this._extraRefs[fieldName]=1},this)},fetch:function(options){if(!this.get("key")){this._updateMethods(this._urlMethods,false)}else{this._updateMethods(this._getMethods,true)}return R.Model.prototype.fetch.call(this,options)},shouldFetch:true,fetchPartialTracks:function(options){if(!this.hasPartialTracks()){return}var self=this;var count=options.count||10;var keys=this.getPartialTrackKeys().slice(0,count);R.Api.request({method:"get",content:{keys:keys},error:function(resp){console.error("Failed to get tracks:",resp.status)},success:function(resp){var tracks=[];_.each(keys,function(key,i){var track=resp.result[key];if(options.processLoadedTrack){track=options.processLoadedTrack(track,R.Utils.value(self.get("tracks").length)+i,self)}tracks.push(track)});self.get("tracks").add(tracks);if(options.success){options.success(tracks)}}})},hasPartialTracks:function(){return this.getPartialTrackKeys().length>0},getPartialTrackKeys:function(){var keys=[];if(this.get("trackKeys")){keys=this.get("trackKeys").slice(R.Utils.value(this.get("tracks").length))}return keys},_getMethods:{method:{read:"get"},content:{read:function(config){return _.extend({keys:[this.get("key")],extras:_.values(this._extras)},config)}},parse:function(resp,xhr){if(resp){return resp[this.get("key")]}}},_urlRegExp:/^([^?]+).*/,_urlMethods:{method:{read:"getObjectFromUrl"},content:{read:function(){var url=decodeURIComponent(this.get("url")||Backbone.history.getFragment());url=url.match(this._urlRegExp)[1];if(!_.size(this._extras)){this._extras={tracks:"tracks"}}return{url:url,extras:_.values(this._extras)}}},parse:function(resp,xhr){if(!this.get("key")){this._updateMethods(this._urlMethods,false)}else{this._updateMethods(this._getMethods,true)}return resp}},_updateMethods:function(methods,clobber){_.each(["method","content"],function(field){if(this[field]){if(clobber){this[field]=_.extend({},this[field],methods[field])}else if(!_.isFunction(this[field])&&!_.isString(this[field])){this[field]=_.extend({},methods[field],this[field])}}else{this[field]=methods[field]}},this);if(this._originalParse){this.parse=_.compose(this._originalParse,methods.parse)}else{this.parse=methods.parse}},addField:function(field){this._referenceField(field);var fieldName=_.isObject(field)?field.field:field;if(_.isString(field)&&this._extraRefs[fieldName]>1){return(new $.Deferred).resolve()}else{return R.Models.manager.getField(this,field)}},addFieldRefs:function(fieldRefs){var self=this;if(!this._isClaimed){this._isClaimed=true;_.each(fieldRefs,this._referenceField);return this}else{_.each(fieldRefs,function(field){if(!R.Utils.isExtraExclusion(field)){self._referenceField(field)}});_.each(_.keys(this._extraRefs),function(extra){if(R.Utils.isExtraExclusion(extra)&&!_.include(fieldRefs,extra)){delete self._extraRefs[extra]}})}},getAllFields:function(){return _.union(_.keys(this.attributes),_.keys(this._extraRefs))},_referenceField:function(field){var fieldName=_.isObject(field)?field.field:field;if(this._extraRefs[fieldName]){this._extraRefs[fieldName]++;if(_.isObject(field)){var existingField=this._extras[fieldName];if(_.isObject(existingField)){existingField.extras=_.union(existingField.extras,field.extras)}else{this._extras[fieldName]=field}}}else{this._extraRefs[fieldName]=1;this._extras[fieldName]=field}},_dereferenceField:function(field){var fieldName=_.isObject(field)?field.field:field;if(this._extraRefs[fieldName]){this._extraRefs[fieldName]--;if(this._extraRefs[fieldName]===0){delete this._extraRefs[fieldName];delete this._extras[fieldName]}else{var existingField=this._extras[fieldName];if(_.isObject(existingField)){existingField.extras=_.difference(existingField.extras,field.extras)}}}},addFields:function(fields){var self=this;var deferreds=_.map(fields,function(field){return self.addField(field)});return $.when(deferreds)},removeField:function(field){this._dereferenceField(field)},removeFields:function(fields){_.each(fields,this.removeField,this)},trackField:function(fields){fields=R.Utils.array(fields);this.addFields(fields);if(_.isEmpty(this.trackedFields)&&R.pubSub){R.pubSub.subscribe(this.get("key")+"/fields",this.onFieldsChanged)}var self=this;_.each(fields,function(field){var fieldName=_.isObject(field)?field.field:field;if(self.trackedFields[fieldName]){self.trackedFields[fieldName]++}else{self.trackedFields[fieldName]=1}})},untrackField:function(fields){fields=R.Utils.array(fields);this.removeFields(fields);var self=this;_.each(fields,function(field){var fieldName=_.isObject(field)?field.field:field;if(self.trackedFields[fieldName]){self.trackedFields[fieldName]--;if(self.trackedFields[fieldName]===0){delete self.trackedFields[fieldName]}}});if(_.isEmpty(this.trackedFields)&&R.pubSub){R.pubSub.unsubscribe(this.get("key")+"/fields",this.onFieldsChanged)}},trackCount:function(){if(this.get("trackKeys")){return this.get("trackKeys").length}else if(this.get("length")){return this.get("length")}else if(this.get("tracks")){return R.Utils.value.call(this.get("tracks"),this.get("tracks").length)}else{return 0}},onFieldsChanged:function(topic,data){var trackedFields=_.keys(this.trackedFields);_.each(data.fields,function(value,key){if(_.include(trackedFields,key)){if(this.fieldConverter&&this.fieldConverter[key]){this[this.fieldConverter[key]](key,value,data.fields);return}var o={};o[key]=value;this.set(o)}},this)},destroy:function(){if(!_.isEmpty(this.trackedFields)&&R.pubSub){R.pubSub.unsubscribe(this.get("key")+"/fields",this.onFieldsChanged)}return R.Model.prototype.destroy.apply(this,arguments)},getDefaultTweet:function(){var twitterName=R.serverInfo.get("twitterName");var tweet="";var nowPlayingHashtag=t("#NowPlaying");var shortUrl=this.get("shortUrl");if(_.contains(["a","al","r","rl","t","l","p"],this.get("type"))){var artist=this.get("artist")||this.get("owner")&&this.get("owner").getFullName(true);if(artist){tweet=t("[nowPlayingHashtag] [name] by [artist] on [twitterName]: [shortUrl]",{nowPlayingHashtag:nowPlayingHashtag,name:this.get("name"),artist:artist,twitterName:twitterName,shortUrl:shortUrl})}if(!artist||tweet.length>140){tweet=t("[nowPlayingHashtag] [name] on [twitterName]: [shortUrl]",{nowPlayingHashtag:nowPlayingHashtag,name:this.get("name"),twitterName:twitterName,shortUrl:shortUrl});if(tweet.length>140){tweet=t("[nowPlayingHashtag] [shortUrl] on [twitterName]",{nowPlayingHashtag:nowPlayingHashtag,shortUrl:shortUrl,twitterName:twitterName})}}}else if(this.get("type")==="cs"){tweet=t("[setName] by [setOwner] on [twitterName]: [shortUrl]",{setName:this.get("name"),setOwner:this.get("owner").getFullName(),twitterName:twitterName,shortUrl:shortUrl});if(tweet.length>140){tweet=t("[shortUrl] on [twitterName]",{shortUrl:shortUrl,twitterName:twitterName})}}else if(R.isStation(this)){tweet=t("[nowPlayingHashtag] [stationName] on [twitterName]: [shortUrl]",{nowPlayingHashtag:nowPlayingHashtag,stationName:this.getName(true),twitterName:twitterName,shortUrl:shortUrl});if(tweet.length>140){tweet=t("[nowPlayingHashtag] [shortUrl] on [twitterName]",{nowPlayingHashtag:nowPlayingHashtag,shortUrl:shortUrl,twitterName:twitterName})}}else{console.error("Could not construct a tweet for type "+this.get("type"))}return tweet},purchase:function(paymentId,options){R.Api.request({method:"purchaseItem",content:{paymentId:paymentId,item:this.get("key")},success:function(response){R.Payment.purchaseSuccess(response,options)},error:function(response){R.Payment.purchaseError(response,options)}})},canAddToPlaylist:function(){return false}});var ObjectModelManager=function(){this.initialize()};_.extend(ObjectModelManager.prototype,{initialize:function(){this.models={};this.fields={}},getField:function(model,field){var key=model.get("key");if(this.models[key]){this.models[key].push(model)}else{this.models[key]=[model]}var fieldName=_.isObject(field)?field.field:field;if(_.has(this.fields,fieldName)){var existingField=this.fields[fieldName];if(!_.contains(existingField.keys,key)){existingField.keys.push(key)}if(_.isObject(field)){existingField.extras=_.union(existingField.extras,field.extras)}}else{this.fields[fieldName]=_.extend({keys:[key],extras:[]},_.isObject(field)?field:null)}var deferred=$.Deferred();this.fetch({success:function(){deferred.resolve.apply(this,arguments)},error:function(){deferred.reject.apply(this,arguments)}});return deferred},_maxGetKeys:50,_maxSimultaneousRequests:5,_getExtras:function(keys){var extras={};_.each(keys,function(key){_.each(this.fields,function(field,fieldName){if(!_.contains(field.keys,key)){return}if(_.has(extras,fieldName)){extras[fieldName].keys.push(key)}else{extras[fieldName]={field:fieldName,extras:field.extras,keys:[key]}}})},this);return _.values(extras)},fetch:_.debounce(function(options){var self=this;var keyList=_.keys(this.models);var keyGroups=R.Utils.chunk(keyList,this._maxGetKeys);var requests=_.map(keyGroups,function(keyGroup){var requestOptions=_.extend({},options);var extras=self._getExtras(keyGroup);var requestParams={keys:keyGroup,extras:extras};var requestModels=_.reduce(keyGroup,function(keyGroupModels,key){keyGroupModels=keyGroupModels.concat(self.models[key]);return keyGroupModels},[]);requestParams.extras.unshift({field:"*",exclude:true});requestOptions.success=function(response){_.each(requestModels,function(model){model.set(response.result[model.get("key")])})};_.extend(requestOptions,{method:"get",content:requestParams});return requestOptions});this._doRequests(requests,options.success,options.error);this.initialize()},250),_doRequests:function(requests,success,error){var inFlight=[];var self=this;var process=function(){var promise;if(requests.length===0){success()}else if(inFlight.length<self._maxSimultaneousRequests){promise=R.Api.request(requests.shift());promise.done(function(){inFlight=_.without(inFlight,promise);process()});promise.fail(error);inFlight.push(promise);process()}};process()}});R.Models.manager=new ObjectModelManager}();!function(){function callOriginal(module,name,args){module.original[name].apply(module.original,args)}function callForPlayer(module,name,args){if(module.proxy.inRdio()&&!_.contains(module.proxy.permissions(),"shared_playstate")){console.error("[ApiProxy] calling "+name+" while In Rdio is not allowed without the shared_playstate permission")}else{callOriginal(module,name,args)}}var apiMap={_apiProxyObjects:"m",currentUser:"m",player:{MASTER_UNKNOWN:"c",MASTER_ME:"c",MASTER_ELSEWHERE:"c",PLAYSTATE_PAUSED:"c",PLAYSTATE_PLAYING:"c",PLAYSTATE_STOPPED:"c",PLAYSTATE_BUFFERING:"c",PLAYSTATE_OFFLINE:"c",REPEAT_NONE:"c",REPEAT_ONE:"c",REPEAT_ALL:"c",_model:{isMaster:"r",playingSource:"m",playingTrack:"m",playState:"r",position:"r",queue:"m",repeat:"r",shuffle:"r",sourcePosition:"r",volume:"r"},next:callForPlayer,nextSource:callForPlayer,pause:callForPlayer,play:function(module,name,args){var options=args[0];if(!_.isUndefined(options)){if(!_.isObject(options)){console.error("[ApiProxy] invalid argument for play(): "+options);return}else if(!_.isString(options.source)){console.error("[ApiProxy] bad source for play(): "+options.source);return}}callForPlayer(module,name,[options])},playingSource:callForPlayer,playingTrack:callForPlayer,playState:callForPlayer,position:callForPlayer,previous:callForPlayer,repeat:callForPlayer,shuffle:callForPlayer,sourcePosition:callForPlayer,startMasterTakeover:callForPlayer,togglePause:callForPlayer,volume:callForPlayer,queue:{add:callForPlayer,addPlayingSource:callForPlayer,clear:function(module,name,args){if(_.contains(module.proxy.permissions(),"shared_playstate")){console.error("[ApiProxy] R.player.queue.clear() is not permitted with shared_playstate");return}callForPlayer(module,name,args)},move:callForPlayer,play:callForPlayer,remove:callForPlayer}},logger:{verbosity:""}};var modelMap={a:{artist:"r",artistKey:"r",artistUrl:"r",canSample:"r",canStream:"r",canTether:"r",displayDate:"r",duration:"r",embedUrl:"r",icon:"r",icon400:"r",iframeUrl:"r",isClean:"r",isExplicit:"r",key:"r",length:"r",name:"r",price:"r",releaseDate:"r",shortUrl:"r",trackKeys:"r",tracks:"m",type:"r",url:"r"},al:{albumKey:"r",artist:"r",artistKey:"r",artistUrl:"r",canSample:"r",canStream:"r",canTether:"r",displayDate:"r",duration:"r",embedUrl:"r",icon:"r",icon400:"r",iframeUrl:"r",isClean:"r",isExplicit:"r",itemTrackKeys:"r",key:"r",length:"r",name:"r",price:"r",rawArtistKey:"r",releaseDate:"r",shortUrl:"r",trackKeys:"r",tracks:"m",type:"r",url:"r",userKey:"r",userName:"r"},p:{description:"ro",duration:"ro",embedUrl:"r",icon:"r",icon400:"r",iframeUrl:"r",key:"r",lastUpdated:"r",length:"r",name:"r",owner:"m",shortUrl:"r",tracks:"m",type:"r",url:"r"},s:{firstName:"r",icon:"r",isProtected:"ro",key:"r",lastName:"r",type:"r",url:"r"},t:{album:"r",albumArtist:"ro",albumArtistKey:"ro",albumKey:"r",albumUrl:"r",artist:"r",artistKey:"r",artistUrl:"r",canDownload:"r",canDownloadAlbumOnly:"r",canSample:"r",canStream:"r",canTether:"r",duration:"r",embedUrl:"r",icon:"r",iframeUrl:"r",isClean:"r",isExplicit:"r",key:"r",name:"r",price:"r",shortUrl:"r",trackNum:"r",type:"r",url:"r"}};var stationMap={icon:"ro",key:"r",name:"r",type:"r"};var currentUserMap={baseIcon:"rao",canStreamHere:"r",firstName:"rao",freeRemaining:"rao",gender:"rao",icon:"rao",isAnonymous:"r",rdioUnreadNotificationsCount:"rao",vdioUnreadNotificationsCount:"rao",isFree:"rao",isFreeExpired:"rao",isProtected:"rao",isTrial:"rao",key:"ra",lastName:"rao",libraryVersion:"rao",stations:"rao",subscriptionType:"rao",type:"ra",url:"rao",vanityName:"rao",trackFollowing:function(module,name,args){var k=args[0];if(!module.proxy.authenticated){console.error("[ApiProxy] Can't trackFollowing when not authenticated");return}var callback=function(){if(!module.getModule(["following"])){module.addLateAttribute({name:"following",map:"m"})}if(k){k()}};callOriginal(module,name,[callback]);module.proxy._trackFollowingCounter++},untrackFollowing:function(module,name,args){if(!module.proxy.authenticated){console.error("[ApiProxy] Can't untrackFollowing when not authenticated");return}if(module.proxy._trackFollowingCounter===0){console.error("[ApiProxy] Not tracking following, so cannot untrack.");return}callOriginal(module,name,args);module.proxy._trackFollowingCounter--}};var followingPersonMap={firstName:"r",icon:"r",isProtected:"ro",key:"r",lastName:"r",lastSongPlayed:"ro",lastSongPlayTime:"ro",lastSourcePlayed:"ro",online:"ro",trackPresence:function(module,name,args){if(module.original.get("isProtected")){console.error("[ApiProxy] tracking presence on protected users is not allowed.");return}callOriginal(module,name,args)},untrackField:"",untrackPresence:"",url:"r",trackField:function(module,name,args){if(module.original.get("isProtected")){console.error("[ApiProxy] tracking fields on protected users is not allowed.");return}var fields=R.Utils.array(args[0]);var whitelist=["lastSongPlayed","lastSourcePlayed","lastSongPlayTime"];var bad=_.difference(fields,whitelist);_.each(bad,function(v,i){console.error("[ApiProxy] invalid argument for trackField: "+v)});var cleanFields=_.without(fields,bad);if(cleanFields.length){callOriginal(module,name,[cleanFields])}}};function checkMapError(missing,map,module,name){if(missing&&!R.ApiProxy.NO_MAP_ERRORS&&!/o/.test(map)){console.error("[ApiProxy] expecting "+module._target()+"."+name+" to exist")}}function isCollection(value){return _.isObject(value)&&"models"in value&&"_onModelEvent"in value}function ApiProxyAttribute(config){var self=this;console.assert("name"in config,"config.name is required");console.assert("parent"in config,"config.parent is required");this.name=config.name;
this.parent=config.parent;this.map=config.map||"";this.module=null;if(_.isString(this.map)){this.canWrite=/w/.test(this.map),this.needsAuth=/a/.test(this.map),this.fake=/f/.test(this.map)}else{this.canWrite=this.needsAuth=this.fake=false}if(!this.fake){var original=this.parent.original.get(this.name);this.setValue(original);checkMapError(_.isUndefined(original),this.map,this.parent,this.name)}}ApiProxyAttribute.prototype={destroy:function(){if(this.module){this.module.destroy();this.module=null}this.parent=null},packagedValue:function(){if(this.module){return{__module:this.module.toJSON()}}return this._value},rawValue:function(){return this._value},setValue:function(value){if(value===this._value){return}if(this.module){this.module.destroy();this.module=null}this._value=value;if(value instanceof Backbone.Model||isCollection(value)){this.module=R.ApiProxyModule.create({original:value,name:this.name,map:this.map,proxy:this.parent.proxy,parent:this.parent})}},getModule:function(chain){if(this.module){return this.module.getModule(chain)}return null}};R.ApiProxyModule=function(config){this.initialize(config)};R.ApiProxyModule.prototype={initialize:function(config){var self=this;console.assert("original"in config,"config.original is required");console.assert("name"in config,"config.name is required");console.assert("proxy"in config,"config.proxy is required");_.defaults(this,config,{parent:null,map:null});this.children={};this.attributes={};this.constants={};this.commands=[];this.commandOverrides={};this.isModel=this.original instanceof Backbone.Model;var map=this.map;if(this.isModel){this.original.on("change",this._changeHandler,this);if(map==="m"){var type=this.original.get("type");if(!type){var key=this.original.get("key");if(key){type=key.replace(/\d*/g,"")}}if(type==="s"&&this.name==="currentUser"){map=currentUserMap}else if(type==="s"&&this.parent&&(this.parent.name==="following"||this.parent.name==="_apiProxyObjects")){map=followingPersonMap}else if(type&&type in modelMap){map=modelMap[type]}else if(_.contains(R.serverInfo.get("stationTypes"),type)){map=stationMap}else{console.error("[ApiProxy] unknown model type for "+this._target()+": "+type)}}}if(_.isObject(map)){R.Utils.eachKey(map,function(v,k){self._add({original:self.original[k],name:k,map:v})})}},destroy:function(){R.Utils.eachKey(this.children,function(v,k){v.destroy()});R.Utils.eachKey(this.attributes,function(v,k){v.destroy()});if(this.isModel){this.original.off("change",this._changeHandler,this)}this.parent=null},fakeSet:function(keyOrMap,value){var self=this;var changes;if(_.isObject(keyOrMap)){changes=keyOrMap}else{changes={};changes[keyOrMap]=value}var changesToSend={};R.Utils.eachKey(changes,function(v,k){var attribute=self.attributes[k];if(!attribute){console.error("[ApiProxy] trying to fakeSet non-existent attribute",k,v)}else if(!attribute.fake){console.error("[ApiProxy] trying to fakeSet non-fake attribute",k,v)}else if(v!==attribute.rawValue()){attribute.setValue(v);changesToSend[k]=attribute.packagedValue()}});this._sendChanges(changesToSend)},getModule:function(chain){if(!chain.length){return this}if(chain[0]in this.children){return this.children[chain[0]].getModule(_.rest(chain))}else if(chain[0]in this.attributes){return this.attributes[chain[0]].getModule(_.rest(chain))}return null},commandFromClient:function(command,args){var self=this;if(_.indexOf(this.commands,command)==-1){return}if(_.isArray(args)){var reg=/^__rdio_callback:/;args=_.map(args,function(v,i){if(_.isString(v)&&reg.test(v)){return function(){var id=v.replace(reg,"");self.proxy.sendMessage({type:"callback",callback:id,response:_.toArray(arguments)})}}return v})}if(this.commandOverrides[command]){this.commandOverrides[command](this,command,args)}else{this.original[command].apply(this.original,args)}},changeFromClient:function(requestedChanges){var self=this;var changes={};R.Utils.eachKey(requestedChanges,function(v,k){var attribute=self.attributes[k];if(attribute&&attribute.canWrite){attribute.setValue(v);if(!attribute.fake){changes[k]=v}}});if(!_.isEmpty(changes)){this.original.set(changes)}},toJSON:function(){var self=this;var result={children:{},constants:this.constants,commands:this.commands};if(!_.isEmpty(this.attributes)){result.attributes={};R.Utils.eachKey(this.attributes,function(v,k){if(self.proxy.authenticated||!v.needsAuth){result.attributes[k]=v.packagedValue()}})}R.Utils.eachKey(this.children,function(v,k){result.children[k]=v.toJSON()});return result},becameAuthenticated:function(){var self=this;if(!_.isEmpty(this.attributes)){var changes={};R.Utils.eachKey(this.attributes,function(v,k){if(v.needsAuth){changes[k]=v.packagedValue()}});this._sendChanges(changes)}R.Utils.eachKey(this.children,function(v,k){v.becameAuthenticated()})},addLateAttribute:function(config){this._add(config);var changes={};changes[config.name]=this.attributes[config.name].packagedValue();this._sendChanges(changes)},_add:function(config){console.assert("name"in config,"config.name is required");if(_.isString(config.map)&&/c/.test(config.map)){var value=this.constants[config.name]=this.original[config.name];checkMapError(_.isUndefined(value),config.map,this,config.name)}else if(_.isString(config.map)&&/(f|r|m)/.test(config.map)&&this.isModel){this.attributes[config.name]=new ApiProxyAttribute({name:config.name,parent:this,map:config.map})}else if(_.isObject(config.original)&&!_.isEmpty(config.original)){this.children[config.name]=R.ApiProxyModule.create({original:config.original,name:config.name,map:config.map,proxy:this.proxy,parent:this})}else if(_.isFunction(config.original)){this.commands.push(config.name);if(_.isFunction(config.map)){this.commandOverrides[config.name]=config.map}}else if(!/o/.test(config.map)&&!R.ApiProxy.TESTING){checkMapError(true,"",this,config.name)}},_changeHandler:function(){var self=this;var changes={};R.Utils.eachKey(this.original.changedAttributes(),function(v,k){var attribute=self.attributes[k];if(attribute){if(k==="type"&&v!==attribute.rawValue()){console.error("[ApiProxy] models changing type is not supported ("+attribute.rawValue()+" to "+v+")")}attribute.setValue(v);if(self.proxy.authenticated||!attribute.needsAuth){changes[k]=attribute.packagedValue()}}});this._sendChanges(changes)},_sendChanges:function(changes){if(_.isEmpty(changes)){return}this.proxy.sendMessage({type:"change",body:changes,target:this._target()})},_target:function(){if(this.parent){return this.parent._target()+"."+this.name}return this.name}};R.ApiProxyModule.extend=function(subclass){var constructor=function(){this.initialize.apply(this,arguments)};constructor.prototype=_.extend({_super:function(method){return R.ApiProxyModule.prototype[method].apply(this,_.rest(arguments))}},R.ApiProxyModule.prototype,subclass);return constructor};R.CollectionApiProxyModule=R.ApiProxyModule.extend({initialize:function(config){var self=this;this._super("initialize",_.extend({},config,{map:null}));this.modelMap=config.map;this.models=[];this.original.on("add",this._handleAdd,this);this.original.on("remove",this._handleRemove,this);this.original.on("reset",this._handleReset,this);this.original.each(function(v,i){var model=R.Models.ListItem.unwrap(v);self.models.push(R.ApiProxyModule.create({original:model,name:""+i,map:self.modelMap,proxy:self.proxy,parent:self}))})},destroy:function(){this.original.off("add",this._handleAdd,this);this.original.off("remove",this._handleRemove,this);this.original.off("reset",this._handleReset,this);_.each(this.models,function(v,i){v.destroy()});this._super("destroy")},getModule:function(chain){if(!chain.length){return this}var index=parseInt(chain[0],10);if(""+index===chain[0]&&index>=0&&index<this.models.length){return this.models[index].getModule(_.rest(chain))}return null},toJSON:function(){var result=this._super("toJSON");result.models=[];_.each(this.models,function(v,i){result.models.push(v.toJSON())});return result},_handleAdd:function(model,collection,info){var module=R.ApiProxyModule.create({original:R.Models.ListItem.unwrap(model),name:"temp",map:this.modelMap,proxy:this.proxy,parent:this});var index=collection.indexOf(model);if(index<0){console.error("Could not get index of model",model);return}this.models.splice(index,0,module);_.each(this.models,function(v,i){v.name=""+i});this.proxy.sendMessage({type:"add",body:{module:module.toJSON(),index:index},target:this._target()})},_handleRemove:function(model,collection,info){var module=this.models[info.index];this.models.splice(info.index,1);_.each(this.models,function(v,i){v.name=""+i});module.destroy();this.proxy.sendMessage({type:"remove",body:{module:module.toJSON(),index:info.index},target:this._target()})},_handleReset:function(collection,info){_.each(this.models,function(v,i){v.destroy()});this.models=[];this.proxy.sendMessage({type:"reset",target:this._target()})}});R.ApiProxyModule.create=function(config){if(isCollection(config.original)){return new R.CollectionApiProxyModule(config)}return new R.ApiProxyModule(config)};R.ApiProxy=function(config){var self=this;console.assert("XdmSocket"in window,"[ApiProxy] requires XdmSocket");config=config||{};this.root=null;this.authenticated=false;this.socket=null;this._requests={};this._permissions=[];this._inRdio=!_.isUndefined(config.remote);this._socketDeferred=$.Deferred();this._trackFollowingCounter=0;var playerDeferred=R.Services.ready("Player");var authDeferred=$.Deferred();$.when(playerDeferred,this._socketDeferred,authDeferred).done(_.bind(this.ready,this));console.assert(!R._apiProxyObjects,"R._apiProxyObjects should not exist; we support only one ApiProxy at a time");R._apiProxyObjects=new Backbone.Collection;this.on("authenticated",authDeferred.resolve,authDeferred);if(config.noSocket){this.ready()}else{this.socket=new XdmSocket({remote:config.remote,container:config.container,onMessage:function(message,origin){self._handleMessage(message)},onReady:function(){self._socketDeferred.resolve()}})}};R.ApiProxy.prototype=_.extend({ready:function(){this.root=R.ApiProxyModule.create({original:R,name:"R",proxy:this,map:apiMap});console.log("[ApiProxy] ready");this.sendMessage({type:"ready",config:this.toJSON()});if(!this._cookiesEnabled()){this.sendMessage({type:"cookieError"})}this.trigger("ready")},destroy:function(){if(this.socket){this.socket.destroy();this.socket=null}if(this.root){if(this._trackFollowingCounter>0){var module=this.root.getModule(["currentUser"]);if(module){_.times(this._trackFollowingCounter,function(){module.commandFromClient("untrackFollowing",[])})}}this.root.destroy();this.root=null}if(R._apiProxyObjects){R._apiProxyObjects=null}},sendMessage:function(message){if(!message.type){throw new Error("[ApiProxy] messages need types")}if(this.socket){this.socket.postMessage(message)}},sendAccessToken:function(token){this.sendMessage({type:"newAccessToken",accessToken:token})},command:function(message){if(!this.root){console.error("[ApiProxy] not ready");return}var chain=message.target.split(".");chain.shift();var module=this.root.getModule(chain);if(module){module.commandFromClient(message.command,message.args)}else{console.error("[ApiProxy] command "+message.command+": unable to locate "+message.target)}},change:function(message){if(!this.root){console.error("[ApiProxy] not ready");return}var chain=message.target.split(".");chain.shift();var module=this.root.getModule(chain);if(module){module.changeFromClient(message.change)}else{console.error("[ApiProxy] change "+_.keys(message.change).join(", ")+": unable to locate "+message.target)}},request:function(config){console.assert("method"in config,"config.method is required");console.assert("access_token"in config,"config.access_token is required");function handleError(data){if(config.error){config.error(data)}}var content=config.content?_.clone(config.content):{};_.extend(content,{method:config.method,access_token:config.access_token});var opts={url:"/api/1/"+config.method,type:"POST",data:content,dataType:"json",success:function(data){if(data&&data.status=="ok"){if(config.success){config.success(data)}}else{handleError(_.defaults(data||{},{status:"error",message:"unknown error"}))}},error:function(xhr){handleError({status:xhr.statusText=="abort"?"abort":"error",message:xhr.statusText||"unknown error",code:xhr.status})}};var clientId=R.settings.get("apiClientId");if(clientId){opts.headers={"X-Rdio-Client-Id":clientId}}return $.ajax(opts)},permissions:function(){return this._permissions},inRdio:function(){return this._inRdio},reportFlashError:function(){this.sendMessage({type:"flashError"})},_audioPrime:function(){var self=this;if(this._inRdio){console.error("[ApiProxy] _audioPrime() is not for use for in-Rdio apps.");return}var createComponent=function(){R.loader.load(["Platform.AudioPrime"],function(){var component=new R.Components.Platform.AudioPrime;var done=function(success){self.sendMessage({type:"audioPrime",success:success});component.destroy()};component.on("audioPrimed",function(){done(true)});component.on("audioPrimeCancelled",function(){done(false)});component.render(function(){$("body").append(component.el)})})};if(R.loader&&R.loader.isReady()){createComponent()}else{R.Services.start("Loader");R.Services.ready("Loader",function(){createComponent()})}},_handleMessage:function(message){var self=this;var xhr;if(!message.type){console.error("[ApiProxy] message sent without type",message);return}switch(message.type){case"command":this.command(message);break;case"change":this.change(message);break;case"request":function completion(data){delete self._requests[message.callback];self.sendMessage({type:"callback",callback:message.callback,response:data})}xhr=this.request({method:message.method,access_token:message.access_token,content:message.content,success:completion,error:completion});this._requests[message.callback]={xhr:xhr};break;case"abortRequest":if(message.id in this._requests&&this._requests[message.id].xhr){this._requests[message.id].xhr.abort()}break;case"getObject":this._handleGetObject(message.key,message.id);break;case"releaseObject":this._handleReleaseObject(message.key);break;case"newAccessToken":this._receiveAccessToken(message.accessToken);break;case"authenticationDenied":this._setAuthenticated(false);break;case"audioPrime":this._audioPrime();break;case"navigate":R.router.navigate(message.fragment,true);break;default:console.error("[ApiProxy] Unknown message from api-impl",message);break}},_handleGetObject:function(key,id){var self=this;var sendResult=function(index){self.sendMessage({type:"getObjectResult",id:id,index:index})};var getIndex=function(){var index=-1;R._apiProxyObjects.some(function(v,i){if(v.get("key")===key){index=i;return true}});return index};var index=getIndex();if(index!==-1){sendResult(index)}else if(/^s\d/i.test(key)){var user=new R.Models.User({key:key});user.fetch({success:function(model,response){if(!_.isEmpty(response)){R._apiProxyObjects.add(user);index=getIndex()}sendResult(index)},error:function(){sendResult(-1)}})}else{console.error("[ApiProxy] Can't load "+key+"; this object type is not supported.");sendResult(-1)}},_handleReleaseObject:function(key){R._apiProxyObjects.remove(key)},_setAuthenticated:function(value,permissions){var became=value&&!this.authenticated;this.authenticated=value;if(became&&this.root){this.root.becameAuthenticated()}this._permissions=permissions||[];this.sendMessage({type:"authenticated",authenticated:value,permissions:this._permissions});this.trigger("authenticated",this.authenticated)},_receiveAccessToken:function(value){var self=this;this.request({method:"getAccessTokenScope",access_token:value,success:function(data){self._setAuthenticated(true,data.result)},error:function(data){self._setAuthenticated(false)}})},_cookiesEnabled:function(){var name="__rdio_cookie_verify";$.cookie(name,true,{expires:7});if(!$.cookie(name)){return false}$.removeCookie(name);return true},toJSON:function(){return this.root.toJSON()}},Backbone.Events)}();!function(){function flattenUrlMap(map){var urls=[];_.each(map,function(destination,url){if(_.isString(destination)||_.isFunction(destination)){urls.push([url,destination])}else{urls=urls.concat(_.map(flattenUrlMap(destination),function(entry){return[url+entry[0],entry[1]]}))}});return urls}R.Router=Backbone.Router.extend({route:function(){if(!Backbone.history){Backbone.history=new R.History}Backbone.Router.prototype.route.apply(this,arguments)},buildRouteMap:function(flattenedUrls){var self=this;_.each(flattenedUrls,function(route){var url=route[0];if(!_.isRegExp(url)){url=new RegExp("^"+url+"(?:\\?.+)?$")}var handler=route[1];var wrappedHandler=_.isFunction(handler)?handler:R.Utils.reportErrors(function(){self.trigger("contentChanged",handler,arguments)},"RouteHandler");var routeCallback=function(){var e=$.Event();self.trigger("beforeroute",e);if(e.isDefaultPrevented()){return}var next=self.window.location.pathname;if(self._shouldRedirectToSignin(route[0])){var redirect="/account/signin/";if(next){redirect+="?next="+next}self.window.location.href=redirect}else{return wrappedHandler.apply(this,arguments)}};if(_.isFunction(handler)){self.route.call(self,url,url,routeCallback)}else{self.route.call(self,url,handler,routeCallback)}})},initialize:function(){_.bindAll(this,"onAnchorClicked");this.window=window;var isMac=R.Utils.getUserEnvironment(navigator).operatingSystem=="Mac";this.openWindowModifier=isMac?"metaKey":"ctrlKey";$("body").on("click","a",this.onAnchorClicked);var flattenedUrls=flattenUrlMap(R.Router.routeMap);this.buildRouteMap(flattenedUrls);var self=this;Backbone.history.handlers.push({route:/^(.*)$/,callback:function(fragment){if(fragment.length&&fragment[fragment.length-1]!=="/"&&fragment.indexOf("?")===-1){self.navigate(fragment+"/",{trigger:true,replace:true})}else{var rule=R.muxer.find(location);if(rule&&rule.target!==Env.loadedTarget){R.router.redirectExternal()}else{self.routeNotFound()}}}})},stop:function(){this.unbind();$("body").off("click","a",this.onAnchorClicked)},_shouldRedirectToSignin:function(matchedUrl){if(R.currentUser.isAnonymous()){if(R.Router.loginRequired.length){return _.any(R.Router.loginRequired,function(urlPrefix){return matchedUrl.indexOf(urlPrefix)===0})}else if(R.Router.anonymousAllowed.length){return _.all(R.Router.anonymousAllowed,function(urlPrefix){return matchedUrl.indexOf(urlPrefix)!==0})}}return false},navigate:function(fragment,triggerRoute){if(fragment.charAt(0)==="/"){fragment=fragment.slice(1)}var options=_.isObject(triggerRoute)?triggerRoute:{trigger:triggerRoute};Backbone.Router.prototype.navigate.call(this,fragment,options)},routeNotFound:function(notFoundComponent){var self=this;var comp=notFoundComponent||"NotFound";var args=_.toArray(arguments).slice(1);R.Utils.reportErrors(function(){self.trigger("contentChanged",comp,args)})();if(R.isPhantom){alert("routeNotFound")}},redirectExternal:function(to){var url=to;if(to){url=to}else{url=R.router.window.location.href;if(url.indexOf("#")!==-1){url=url.replace("#","")}}R.router.window.location.href=url},onAnchorClicked:function(e){if(e.isDefaultPrevented()){return}var a=$(e.currentTarget);if(!a.length||a.prop("nodeName")!=="A"){console.error("[Router] Clicked anchor detection failed",a);R.Utils.stopEvent(e);return}var modifier=this.openWindowModifier;if(!R.isDesktop&&modifier&&e[modifier]){return}var matchScheme=a.attr("href").match(/^([^\/:]+):/);if(matchScheme&&matchScheme[1]=="mailto"){return}if(a.hasClass("link_external")){return}var linkHost=a.prop("hostname");var isNewHost=window.location.hostname!==linkHost&&linkHost!=="";var isNewPage=isNewHost||a.attr("target")==="_blank";var isHashLink=!isNewHost&&/^#.+$/.test(a.attr("href"));if(!isNewPage&&!isHashLink){if(/\.(dmg|gz|zip|md|application)$/i.test(a.attr("href"))){return}this.trigger("navigatingFromClickedLink",a);R.router.navigate(a.prop("pathname")+a.prop("search"),true);R.Utils.stopEvent(e);return}if(isHashLink){this.trigger("hashLinkClicked",a.prop("hash"));R.Utils.stopEvent(e);return}if(isNewPage){a.attr("target","_blank");if(R.isIpadPlayer){a.attr("href",a.attr("href")+"?openInMobileSafari=true")}if(e.fromHammer){R.router.window.open(a.attr("href"))}return}}},{routeMap:{},loginRequired:[],anonymousAllowed:[],redirect:function(to){return function(){R.router.navigate(to,{replace:true,trigger:true})}},redirectExternal:function(to){R.router.redirectExternal(to)},routeIfHasFeature:function(componentName,featureName){return function(){var features=R.Utils.array(featureName);var allowed=_.find(features,function(featureName){return R.currentUser.get("features")[featureName]});if(allowed){R.router.trigger("contentChanged",componentName,arguments)}else{R.router.routeNotFound()}}}})}();!function(){var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;R.History=Backbone.History.extend({_pushStateIsBroken:function(){return!!navigator.userAgent.match(/Android 2.[23]/)},start:function(options){if(Backbone.History.started)throw new Error("Backbone.history has already been started");Backbone.History.started=true;this.options=_.extend({root:"/"},this.options,options);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState&&!this._pushStateIsBroken());var fragment=this.getFragment();var docMode=document.documentMode;var oldIE=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7);this.root=("/"+this.root+"/").replace(rootStripper,"/");if(oldIE&&this._wantsHashChange){this.iframe=Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(fragment)}if(this._hasPushState){Backbone.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!oldIE){Backbone.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=fragment;var loc=this.location;var atRoot=loc.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!atRoot){this.fragment=this.getFragment(null,true);this.location.replace(this.root+"#"+this.fragment+this.location.search);return true}else if(this._hasPushState&&atRoot&&loc.hash){this.fragment=this.getHash().replace(routeStripper,"");this.history.replaceState({},document.title,this.root+this.fragment+loc.search)}}if(!this.options.silent)return this.loadUrl()},navigate:function(fragment,options){if(!Backbone.History.started)return false;if(!options||options===true)options={trigger:!!options};var url=this.root+(fragment=this.getFragment(fragment||""));if(this.fragment===fragment)return;this.fragment=fragment;if(fragment===""&&url!=="/")url=url.slice(0,-1);if(this._hasPushState){this.history[options.replace?"replaceState":"pushState"]({},document.title,url)}else if(this._wantsHashChange){this._updateHash(this.location,fragment,options.replace);if(this.iframe&&fragment!==this.getFragment(this.getHash(this.iframe))){if(!options.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,fragment,options.replace)}}else{return this.location.assign(url)}if(options.trigger)return this.loadUrl(fragment)}});Backbone.history=new R.History}();!function(){_.extend(R.Router,{routeIfPaymentResolved:function(componentName){return function(){if(R.currentUser.mustResolvePayment()){R.router.navigate("settings/payment/resolve/",true)}else{R.router.trigger("contentChanged",componentName)}}},routeProtected:function(routeHandler,protectedHandler,successHandler){return function(){var urlMatches=arguments;var userModel=new R.Models.User({url:"people/"+urlMatches[0]+"/"});userModel.addFieldRefs(R.Models.User.profileFields);userModel.fetch({success:function(){successHandler(userModel.canView()?routeHandler:protectedHandler,urlMatches,userModel)},error:function(model,response){if(response&&response.code===404){R.router.routeNotFound("NotFound")}else{R.router.routeNotFound("NotFound.Error")}}})}},routeProtectedProfile:function(routeHandler,protectedHandler){return R.Router.routeProtected(routeHandler,protectedHandler,function(routeHandler,urlMatches,userModel){R.router.trigger("contentChanged",routeHandler,urlMatches,{model:userModel})})}});_.extend(R.Router.routeMap,{"signout/":function(){R.storage.clear();R.router.window.location.href="/logout/"+R.Utils.getWindowLocation().search},"settings/":{"":"Settings.YourInfo"}})}();!function(){R.Init={setupGlobals:function(config){config||(config={});config.serviceOptions=_.defaults(config.serviceOptions||{},{Loader:{pathBuilder:R.Utils.getComponentResourcePath}});if(!R.currentUser){R.currentUser=new R.Models.CurrentUser(Env.currentUser)}Bujagali.setBaseUrl(R.serverInfo.get("media_address"));R.Api.setJsonReviver(R.Utils.modelReviver);this.setupBrowserFlags();if(!config.headless){R.Utils.ensureBodyClasses();if(!window.HTMLElement){window.HTMLElement=window.Element}R.router=new R.Router;R.router.on("contentChanged",function(componentName,urlMatches){R.recordEvent("app:route",{componentName:componentName,urlMatches:_.toArray(urlMatches)})})}R.settings=new Backbone.Model(Env.target.settings);R.settings.set("autoPager",R.isPhantom?"Bot":"Auto");if(!config.headless){$(window).bind("beforeunload",function(e){R.recordEvent("app:beforeunload");R.Services.stop()});return R.Services.start(config.serviceNames||null,config.serviceOptions)}},setupBrowserFlags:function(){var userEnv=R.Utils.getUserEnvironment(navigator);if(userEnv.browser==="Phantom"||userEnv.browser==="Facebook"){R.isPhantom=true}R.isMobile=userEnv.isMobile;R.isIpadPlayer=userEnv.isIpadPlayer;R.isAndroid=userEnv.isAndroid;R.isIpad=userEnv.isIpad;R.isIos5=userEnv.isIos5;R.isMobileBrowser=R.isMobile&&!R.isIpadPlayer;R.isTv=userEnv.isTv;R.isIos=userEnv.operatingSystem==="iOS";R.isMac=userEnv.operatingSystem==="Mac";R.isWindows=userEnv.operatingSystem==="Windows";R.isIosSDK=userEnv.isIosSDK;R.isLittleEndian=Modernizr.typedarrays?R.Utils.isLittleEndian():false;R.isChromecastLaunchedByMobile=false;R.isIE=userEnv.browser==="Internet Explorer";R.isIE8=R.isIE&&userEnv.browserVersion<9;R.isIE10=R.isIE&&userEnv.browserVersion==10;R.isIE11=R.isIE&&userEnv.browserVersion==11},ensureDecentBrowser:function(){var userEnv=R.Utils.getUserEnvironment(navigator);if(userEnv.browser=="Internet Explorer"&&userEnv.browserVersion<8||userEnv.browser=="Safari"&&userEnv.browserVersion<4||userEnv.browser=="Firefox"&&userEnv.browserVersion<3.6){R.Services.start("Loader",{Loader:{pathBuilder:R.Utils.getComponentResourcePath}}).done(function(){R.Services.start("Updater");R.loader.load(["UnsupportedBrowser"],function(){var ub=new R.Components.UnsupportedBrowser;ub.render(function(){$("body").append(ub.el)})})});return false}return true},_showLoadingSpinner:function(){var color="#4b5c66";var opts={lines:12,length:4,width:2,radius:5,color:color,speed:1,trail:60,shadow:false,top:"auto",left:"auto"};this.loadingSpinner=document.createElement("div");this.loadingSpinner.id="loading";this.loadingSpinner.style.position="fixed";this.loadingSpinner.style.top="50%";this.loadingSpinner.style.left="50%";var spinner=new Spinner(opts);document.body.appendChild(this.loadingSpinner);spinner.spin(this.loadingSpinner)},_hideLoadingSpinner:function(){if(this.loadingSpinner){document.body.removeChild(this.loadingSpinner)}},startApp:function(componentName,startOptions){startOptions=_.defaults(startOptions||{},{startHistory:true});R.recordEvent("app:init",{state:"starting",componentName:componentName});var self=this;var appLoadTimer=R.stats.createTimer("appLoad."+componentName);this._showLoadingSpinner();$.when(R.Services.ready("Loader"),R.Services.ready("Updater")).done(function(){R.loader.load([componentName],function(){R.recordEvent("app:init",{state:"started",componentName:componentName});var options={queryStringParams:R.Utils.getQueryStringParams(window.location)};R.app=new(R.Component.getObject(componentName))(options);R.app.once("contentReady",function(){R.getEventProxy("R.app",function(eventProxy){R.recordEvent("app:init",{state:"contentReady",componentName:componentName});eventProxy.trigger("contentReady")})});R.Services.trigger("appCreated",R.app);R.app.render(function(){if(window.location.hash[1]=="/"){window.location.hash="#"+window.location.hash.substr(2)}if(startOptions.startHistory&&!Backbone.history.start({pushState:true})){R.router.routeNotFound(Backbone.history.fragment)}appLoadTimer.addExperimentResult("shard_cdn_domains");appLoadTimer.addExperimentResult("preload_deps");appLoadTimer.addString("bundle_preloads",Env.__bundled_app?"yes":"no");appLoadTimer.stop();console.timeEnd("initialize the app");self._hideLoadingSpinner();$("body").append(R.app.el)})}).fail(function(){console.error("Failed to load",componentName)})})},installHeaderTags:function(tagName,tags){_.each(tags,function(tag){var $tag=$("<"+tagName+"/>");$tag.attr(tag);$("head").append($tag)})},ensureStaCookie:function(){var hasPushState=Modernizr.history;if(R.currentUser.isAnonymous()&&!hasPushState&&window.location.pathname!=="/"){$.cookie("sta",true,{path:"/"})}else{$.removeCookie("sta",{path:"/"})}},rdioFaviconLinkTags:function(){var iconBase=R.serverInfo.get("media_address")+"images/2/app_icons/";var linkTags=[{rel:"icon shortcut",href:R.serverInfo.get("media_address")+R.settings.get("favicon"),type:"image/x-icon",sizes:"16x16 24x24 32x32 48x48 64x64 128x128 256x256"},{rel:"icon",href:iconBase+"rdio_48.png",sizes:"48x48"},{rel:"icon",href:iconBase+"rdio_64.png",sizes:"64x64"},{rel:"icon",href:iconBase+"rdio_128.png",sizes:"128x128"},{rel:"icon",href:iconBase+"rdio_256.png",sizes:"256x256"}];return linkTags}};R.burnItDown=function(){R.app.destroy();R.app=null;_.defer(function(){R.Services.stop();R.currentUser=null;R.serverInfo=null})}}();!function(){"use strict";R.StateMachine=function(options){options=options||{};if(!options.initialState){throw new Error("[StateMachine] initialState required")}if(!options.states){throw new Error("[StateMachine] states required")}if(!_.contains(options.states,options.initialState)){throw new Error("[StateMachine] Invalid initialState - not one of specified states")}if(options.initialState==="transitioning"||_.some(options.states,function(s){return s==="transitioning"})){throw new Error('[StateMachine] "transitioning" is a reserved state name.')}this.currentState=options.initialState;this._states=options.states};_.extend(R.StateMachine.prototype,Backbone.Events,{transitionAsync:function(newState){if(!_.contains(this._states,newState)||newState==="transitioning"){throw new Error("[StateMachine] Can't transition to invalid state: "+newState)}if(this.currentState==="transitioning"){throw new Error("[StateMachine] Can't transition, asynchronous transition in progress")}var finishTransition=$.Deferred();var oldState=this.currentState;this._triggerPreChangeEvents(oldState,newState);this.currentState="transitioning";finishTransition.done(_.bind(function(){this.currentState=newState;this._triggerPostChangeEvents(oldState,newState)},this));return finishTransition},_triggerPreChangeEvents:function(fromState,toState){this._triggerPrefixedEvents("before",fromState,toState)},_triggerPostChangeEvents:function(fromState,toState){this._triggerPrefixedEvents("after",fromState,toState);this.trigger("change",fromState,toState)},_triggerPrefixedEvents:function(prefix,fromState,toState){this.trigger(prefix+":"+fromState+"->",toState);this.trigger(prefix+":->"+toState,fromState);this.trigger(prefix+":"+fromState+"->"+toState)}})}();!function($){"use strict";var MAX_DYNAMIC_ROWS=20;var PagingStrategyBase=function(options){this._pageable=options.pageable;this._container=options.container;this._collection=options.collection;this._pagingOptions=options.pagingOptions;this._windowScale=options.windowScale;this.initialize.apply(this,arguments);if(this.eventTarget()){this.eventTarget().on(R.Utils.value(this.eventName),this.fetch)}};_.extend(PagingStrategyBase,{extend:Backbone.View.extend});
_.extend(PagingStrategyBase.prototype,Backbone.Events,{destroy:function(){this.eventTarget().off(R.Utils.value(this.eventName),this.fetch);this._destroyed=true},eventTarget:function(){throw new Error("[PagingStrategyBase] Must implement")},eventName:function(){throw new Error("[PagingStrategyBase] Must implement")},fetch:function(){throw new Error("[PagingStrategyBase] Must implement")},numPerRow:function(){if(_.isFunction(this._pageable.numPerRow)){return this._pageable.numPerRow.call(this._pageable)}else{return R.Utils.value(this._pageable.numPerRow)}},currentRange:function(){return null}});var PagingStrategyAuto=PagingStrategyBase.extend({initialize:function(){this.fetch=_.debounce(_.bind(this.fetch,this),30);this._checkStartIndex();this.fetch()},eventTarget:function(){return this._container},eventName:"scroll",fetch:function(){if(this._destroyed||this._pageable.isDestroyed()||!this._pageable.isInserted()){return}if(this._disabled){return}var visibleWindow=this._convertPixelInfoToIndexRange();if(!visibleWindow){return}this._range=visibleWindow;var windowSize=visibleWindow.end-visibleWindow.start+1;var windowStart=visibleWindow.start;if(_.isNumber(this._windowScale)){var offset=this._pageable.$el.offset().top;if(_.isNumber(this._previousOffset)){var delta=this._previousOffset-offset;var dimensions=this._pageable.elementDimension();if(!dimensions){return}var rowHeight=dimensions.outerHeight||dimensions.height;delta/=rowHeight;var numPerRow=this.numPerRow();var dynamicWindowSize=Math.min(MAX_DYNAMIC_ROWS*this.numPerRow(),Math.abs(Math.round(delta*this._windowScale)*numPerRow));windowSize+=dynamicWindowSize;if(delta<0){windowStart-=dynamicWindowSize}}this._previousOffset=offset}this._collection.get({start:windowStart,count:windowSize,chunk:windowSize})},disable:function(){this._disabled=true},enable:function(){this._disabled=false;this.fetch()},currentRange:function(){return this._convertPixelInfoToIndexRange()},_convertPixelInfoToIndexRange:function(){var pageableTop=this._pageable.$el.offset().top;var containerScrollTop=this._container.scrollTop();var numPerRow=this.numPerRow();var dimensions=this._pageable.elementDimension();if(!dimensions){return null}var heightOfStuffAbovePageable=pageableTop-this._container.offset().top+containerScrollTop;var pageableTopPixelsHidden=Math.max(containerScrollTop-heightOfStuffAbovePageable,0);var rowHeight=dimensions.outerHeight||dimensions.height;var firstVisibleRow=Math.floor(pageableTopPixelsHidden/rowHeight);var firstVisibleItem=firstVisibleRow*numPerRow;var lastVisibleRow=Math.ceil((pageableTopPixelsHidden+this._container.height())/rowHeight);var lastVisibleItem=lastVisibleRow*numPerRow;return{start:firstVisibleItem,end:lastVisibleItem}},_checkStartIndex:function(){var qs=R.Utils.getQueryStringParams();if(qs&&qs.start){var self=this;_.defer(function(){self._scrollTo(parseInt(qs.start))})}},_scrollTo:function(index){var dimensions=this._pageable.elementDimension();if(!dimensions){return null}var pageableTop=this._pageable.$el.offset().top;var containerScrollTop=this._container.scrollTop();var numPerRow=this.numPerRow();var rows=Math.floor(index/numPerRow);var rowHeight=dimensions.outerHeight||dimensions.height;var heightOfStuffAbovePageable=pageableTop-this._container.offset().top+containerScrollTop;var distance=rows*rowHeight+heightOfStuffAbovePageable;if(R.app&&R.app.header){distance-=R.app.header.$el.height()}this._pageable.$el.height(distance);this._container.scrollTop(distance)}});var PagingStrategyManual=PagingStrategyBase.extend({initialize:function(){this._currentPage=0;this._rows=this._pagingOptions.rows||10;this._pageSize=this._rows*this.numPerRow();this.fetch()},eventTarget:function(){return null},eventName:function(){return null},fetch:function(){if(this._destroyed){return}this._pageSize=this._rows*this.numPerRow();this._collection.get(this.currentRange())},currentRange:function(){return{start:this._currentPage*this._pageSize,count:this._pageSize}},next:function(){this._currentPage+=1;this.fetch()},previous:function(){this._currentPage=Math.max(0,this._currentPage-1);this.fetch()}});var PagingStrategyBot=PagingStrategyBase.extend({initialize:function(){this._startIndex=0;this._pageSize=this._collection.loadedSize()||20;var qs=R.Utils.getQueryStringParams();if(qs&&qs.start){alert("waitForExtraContent");this._collection.on("loaded",this._onCollectionLoaded,this);this._startIndex=parseInt(qs.start);this.fetch()}this._createPagingElements()},eventTarget:function(){return null},eventName:function(){return null},fetch:function(){this._collection.reset([]);this._collection.get({start:this._startIndex,count:this._pageSize})},destroy:function(){this._container.$el.find(".botlinks").remove();this._collection.off("loaded")},_createPagingElements:function(){var nextIndex=this._startIndex+this._pageSize;var $nav=$('<nav class="botlinks" />').append('<a class="next" href="?start='+nextIndex+'">'+t("Next")+"</a>");if(this._startIndex>0){var prevIndex=Math.max(0,this._startIndex-this._pageSize);$nav.append('<a class="previous" href="?start='+prevIndex+'">'+t("Prev")+"</a>")}this._container.$el.append($nav)},_onCollectionLoaded:function(){alert("extraContentDone")}});R.PagingStrategy={Auto:PagingStrategyAuto,Bot:PagingStrategyBot,Manual:PagingStrategyManual}}(R.$);!function(){R.Mixins.snappy={onMixin:function(options){_.bindAll(this,"onUserScrolled","onScrolled","onResized","onSwiped");_.chain(this.options).extend(options).defaults({snappyDuration:1800});this.onResized=_.debounce(this.onResized,250);this.onScrollDone=_.debounce(this.onScrollDone,50);this.listen(R.shortcutManager,"pressed:left pressed:up pressed:pageup",this.onPreviousPressed);this.listen(R.shortcutManager,"pressed:right pressed:down pressed:pagedown",this.onNextPressed);this.listen(R.shortcutManager,"pressed:space",this.onSpacePressed)},onSpacePressed:function(e){if(!this._enabled){return}if(e.shiftKey){this.onPreviousPressed(e)}else{this.onNextPressed(e)}},_targetScrollTop:0,onScrollDone:function(){this._scrollStart=undefined},snappyEnabled:function(isEnabled){if(_.isUndefined(isEnabled)){return this._enabled}this._enabled=isEnabled},onScrolled:function(e){if(!this._enabled){return}if(!_.isUndefined(this._animationId)||!_.isUndefined(this._scrollStart)){return}var scrollTop=$(window).scrollTop();var deltaY=_.isUndefined(this._prevScrollTop)?0:this._prevScrollTop-scrollTop;this._prevScrollTop=scrollTop;if(Math.abs(deltaY)<=1){return}if(this.getProgress()<.5){return}this.updateClosest(deltaY)},getProgress:function(){var scrollTop=$(window).scrollTop();var height=$(this._targetEl).outerHeight(true);var distance=scrollTop>this._targetScrollTop?scrollTop-this._targetScrollTop:this._targetScrollTop-scrollTop;return distance/height},onSwiped:function(e){if(this._enabled){this.onUserScrolled(e,e.distance,e.distanceX,e.distanceY)}},onUserScrolled:function(e,delta,deltaX,deltaY){if(!this._enabled){return}e.preventDefault();if(_.isUndefined(this._scrollStart)){this._scrollStart=Date.now()}var deltaTime=Date.now()-this._scrollStart;var velPrev=this._velocity||0;this._velocity=R.Utils.exponentialMovingAverage(this._velocity||0,deltaY,deltaTime,50);if(R.Utils.sign(velPrev)!==R.Utils.sign(this._velocity)){this._scrollStart=0;this.cancelScroll()}var accel=this._velocity>0?this._velocity-velPrev:velPrev-this._velocity;if(_.isUndefined(this._animationId)){if(accel>=.1||accel===0){this.scrollToClosest(deltaY)}}this.onScrollDone()},scrollToClosest:function(deltaY){this.updateClosest(deltaY);this.scrollToTarget(Date.now())},scrollToTarget:function(startTime){this.cancelScroll();var self=this;this._animationId=requestAnimationFrame(function(){var runtime=Date.now()-startTime;var currScrollTop=$(window).scrollTop();var distance=Math.abs(self._targetScrollTop-currScrollTop);if(distance>1&&runtime<self.options.snappyDuration){var percent=R.Utils.easeInOutSine(runtime/self.options.snappyDuration);var nextScrollTop=R.Utils.lerp(currScrollTop,self._targetScrollTop,percent);$(window).scrollTop(nextScrollTop);self.scrollToTarget(startTime)}else{self._animationId=undefined;self.trigger("snappy:done",$(self._targetEl))}})},updateClosest:function(deltaY){var direction=R.Utils.sign(deltaY);var magnitude=Math.abs(deltaY);if(magnitude<2){deltaY=direction*2}var scrollTop=$(window).scrollTop()-deltaY;var self=this;var absoluteClosest;var absoluteClosestEl;var nextClosest;var nextClosestEl;this.$targets.each(function(){var offsetTop=$(this).offset().top;var absDiff=Math.abs(offsetTop-scrollTop);if(_.isUndefined(absoluteClosest)||absDiff<Math.abs(absoluteClosest-scrollTop)){absoluteClosest=offsetTop;absoluteClosestEl=this}if(direction>0&&offsetTop>scrollTop){return}else if(direction<0&&offsetTop<scrollTop){return}if(_.isUndefined(nextClosest)||absDiff<Math.abs(nextClosest-scrollTop)){nextClosest=offsetTop;nextClosestEl=this}});var prevTargetEl=this._targetEl;this._targetScrollTop=_.isUndefined(nextClosest)?absoluteClosest:nextClosest;this._targetEl=_.isUndefined(nextClosestEl)?absoluteClosestEl:nextClosestEl;if(prevTargetEl==this._targetEl){return}this.$targets.removeClass("prev backwards forwards").filter(".active").toggleClass("backwards",direction<0).toggleClass("forwards",direction>0).addClass("prev").removeClass("active");var $target=$(this._targetEl).addClass("active").toggleClass("backwards",direction>0).toggleClass("forwards",direction<0);this.trigger("snappy:active",$target)},cancelScroll:function(){this._animationId=cancelAnimationFrame(this._animationId)},onPreviousPressed:function(e){if(!this._enabled){return}e.preventDefault();this.scrollToClosest(2)},onNextPressed:function(e){if(!this._enabled){return}e.preventDefault();this.scrollToClosest(-2)},_cancelTouch:function(e){if(this._enabled){R.Utils.stopEvent(e)}},onInserted:function(){if(R.isMobile){$("body").on("touchstart touchmove",this._cancelTouch);$("body").on("swipe",this.onSwiped)}else{$(window).on("mousewheel",this.onUserScrolled)}$(window).on("scroll",this.onScrolled);$(window).on("resize",this.onResized)},onDetached:function(){if(R.isMobile){$("body").off("touchstart touchmove",this._cancelTouch);$("body").off("swipe",this.onSwiped)}else{$(window).off("mousewheel",this.onUserScrolled)}$(window).off("scroll",this.onScrolled);$(window).off("resize",this.onResized)},scrollTo:function(el,animated,offset){offset=offset||0;this.cancelScroll();var $target=$(el);if($target.length===0){$target=this.$targets.filter(":first")}this.$targets.removeClass("active prev next forwards backwards");$target.addClass("active");var offsetTop=Math.max(0,Math.ceil($target.offset().top-offset));this._targetEl=$target.get(0);this._targetScrollTop=$target.length===0?0:offsetTop;this.trigger("snappy:active",$target);if(animated){this.scrollToTarget(Date.now())}else{$(window).scrollTop(this._targetScrollTop-1).scrollTop(this._targetScrollTop)}},onResized:function(){if(!this._enabled){return}if(this._targetEl){this.scrollTo(this._targetEl)}},onRendered:function(){this.$targets=this.$(this.options.snappySelector);$(window).scrollTop(0)}}}();!function(){R.Mixins.sortable={className:"sortable",onMixin:function(){var self=this;_.defaults(this.options,{scrollableEl:null,minSortable:-1,maxSortable:999999});this._separator=$('<div class="sortable_separator"></div>');this.listen(R.dragManager,"dragstart",function(component){var index=self.model.indexOf(component.model);if(index>-1&&index>=self.options.minSortable&&index<=self.options.maxSortable){self._startReorderMode(component)}});this.listen(R.dragManager,"dragend",this._disableReorderMode);_.bindAll(this,"_onScroll","_disableReorderMode","_onDrag")},_getDragListenerNamespace:function(){return"sortable_"+this.cid},onInserted:function(){var self=this;this._setScrollListener();this._oldCSSPosition=$(this.el).css("position");$(this.el).css({position:"relative"});R.dragManager.setupDropTarget(this.el,{onDrop:function(e){self._onDrop(e)},ignoreEnterLeave:true});R.dragManager.setupDragListener(document.body,{onOver:function(e){self._onDrag(e)},namespace:self._getDragListenerNamespace()})},_setScrollListener:function(){var appContainer;if(this._$scrollableEl){this._$scrollableEl.unbind("scroll",this._onScroll)}if(this.options.scrollableEl){this._$scrollableEl=$(this.options.scrollableEl)}else{appContainer=R.app.getContainer();if(appContainer.$el){this._$scrollableEl=appContainer.$el}else{this._$scrollableEl=appContainer}}if(!this._$scrollableEl||this._$scrollableEl.length!==1){throw new Error("sortable: invalid scrollableEl "+this._$scrollableEl)}this._$scrollableEl.bind("scroll",this._onScroll)},onDetached:function(){this._disableReorderMode();if(this._$scrollableEl){this._$scrollableEl.unbind("scroll",this._onScroll)}R.dragManager.cleanupDropTarget(this.el);R.dragManager.cleanupDragListener(document.body,this._getDragListenerNamespace());$(this.el).css({position:this._oldCSSPosition})},setScrollableEl:function(newScrollableEl){this.options.scrollableEl=newScrollableEl;this._setScrollListener()},onDestroyed:function(){this._items=null;this._itemMids=null},_startReorderMode:function(component){var self=this;var sortableElements;if(this._reorderMode){return}if(!$(this.el).children().length){return}this._reorderMode=true;this._oldIndex=this.model.indexOf(component.model);this._draggedComponent=component;this._length=this.model.length;this._separator.width($(this.el).width());this._updateBoundingBox();this._componentHeight=$(component.el).outerHeight();this._separator.appendTo(this.el).hide();this._updateItems();this._itemMids=[];this._updateItemMids();this.listen(this.model,"loaded",this.onLoadedWhileReordering)},onLoadedWhileReordering:function(){this._updateItems();this._updateItemMids()},_disableReorderMode:function(){if(this._reorderMode){this._draggedComponent=null;this._reorderMode=false;this._separator.remove();this._targetOffset=-1;this.stopListening(this.model,"loaded",this.onLoadedWhileReordering)}},_updateItemMids:function(){_.each(this._items,function(item,i){var $item=$(item);this._itemMids[i]=$item.offset().top+Math.floor($item.outerHeight()/2)},this)},_updateItems:function(){var childLookup={};var self=this;this._items=[];_.each(self.children,function(child){if(child.model){childLookup[child.model.cid]=child}});this.model.each(function(m,index){if(childLookup[m.cid]){self._items[index]=childLookup[m.cid].el}else{throw new Error("Mismatch between sortable models and elements.")}})},_onDrag:function(e){if(!this._reorderMode){return}var point={x:e.originalEvent.clientX,y:e.originalEvent.clientY};var myMid,separatorTop;if(!this._pointIsInBox(point,this._boundingBox)){this._separator.hide();this._targetOffset=-1}else{for(myMid=0;myMid<this._itemMids.length;myMid++){if(this._itemMids[myMid]>point.y){break}}if(myMid===this._targetOffset){return}if(myMid>=this.options.minSortable&&myMid<=this.options.maxSortable+1){this._separator.show();this._targetOffset=myMid;if(myMid>Math.min(this._items.length-1,this.options.maxSortable)){if(this.options.maxSortable<=this._items.length){separatorTop=$(this._items[this.options.maxSortable]).offset().top+$(this._items[this.options.maxSortable]).outerHeight()-this._boundingBox.top}else{separatorTop=this._boundingBox.bottom-this._boundingBox.top}}else{separatorTop=$(this._items[myMid]).offset().top-this._boundingBox.top}this._separator.css({top:separatorTop,left:0})}}},_onDrop:function(){var self=this;var newIndex;if(this._draggedComponent&&this._targetOffset>-1){R.dragManager.logSnorkelEvent({src:this._draggedComponent,eventName:"reorder",index:this._targetOffset});newIndex=this._targetOffset;if(newIndex<this._oldIndex||newIndex>this._oldIndex+1){if(newIndex>this._oldIndex+1){newIndex-=1}_.defer(function(){self.model.trigger("move",self._oldIndex,newIndex)})}}this._disableReorderMode()},_onScroll:function(){if(this._reorderMode){this._updateBoundingBox();this._updateItemMids()}},_pointIsInBox:function(point,box){return point.x>=box.left&&point.x<=box.right&&point.y>=box.top&&point.y<=box.bottom},_updateBoundingBox:function(){var el=$(this.el);var offset=el.offset();this._boundingBox={top:offset.top,left:offset.left,bottom:offset.top+el.outerHeight(),right:offset.left+el.outerWidth()}}}}();!function(){R.Mixins.socialheat={onMixin:function(options){_.bindAll(this,"openSocialHeat");_.extend(this.options,_.defaults(options,{socialheatDialogTitle:t("Listeners"),socialheatDialogTooltipType:"UserInfo",socialheatLeftAligned:false,socialheatTooltipType:"listened",socialheatSpotsAvailable:5,socialheatMoreFloatRight:false}))},_ensureHovers:function(){var heat=this.model.get("networkConsumers");if(heat&&heat.limit()){if(R.isMobile){this.$(".social_heat").on("click",this.openSocialHeat)}else{this.$(".social_heat").hoverIntent({over:this.openSocialHeat,out:R.doNothing})}}},onInserted:function(){this._ensureHovers()},onDetached:function(){if(this.socialHeatPopup){this.socialHeatPopup.close()}},openSocialHeat:function(){var self=this;var $metadataRows=this.$(".metadata .truncated_line, .metadata .more");if(!this.socialHeatPopup&&!R.currentUser.isAnonymous()){R.loader.load(["PeopleRow"],function(){self.socialHeatPopup=self.addChild(new R.Components.PeopleRow({model:self.model.get("networkConsumers"),title:self.options.socialheatDialogTitle,leftAligned:self.options.socialheatLeftAligned,tooltipType:self.options.socialheatTooltipType,dialogTooltipType:self.options.socialheatDialogTooltipType,spotsAvailable:self.options.socialheatSpotsAvailable,usePlaceholders:self.options.socialheadUsePlaceholders,moreFloatRight:self.options.socialheatMoreFloatRight}));self.listen(self.socialHeatPopup,"open",function(){$metadataRows.fadeOut(125)});self.listen(self.socialHeatPopup,"close",function(){$metadataRows.fadeIn(75)});self.socialHeatPopup.render(function(){self.$(".metadata").before(self.socialHeatPopup.el)});self.socialHeatPopup.open()})}else{this.socialHeatPopup.open()}},socialheatSpotsAvailable:function(value){if(_.isUndefined(value)){return this.options.socialheatSpotsAvailable}if(value!==this.options.socialheatSpotsAvailable){this.options.socialheatSpotsAvailable=value;if(this.socialHeatPopup){this.socialHeatPopup.options.spotsAvailable=value;this.socialHeatPopup.render()}}}}}();!function(){R.Mixins.draggable={className:"draggable",onMixin:function(){if(this.dragProxy){R.loader.load([this.dragProxy])}this._proxy=null;_.bindAll(this,"_createDragProxy","onDragStart","onDragStop")},onRendered:function(){var container=R.app.getAppEl();this._dragTarget=this._getDragTarget();this._dragTarget.draggable({appendTo:container,containment:container,cursorAt:{left:20,top:-10},helper:this._createDragProxy,start:this.onDragStart,stop:this.onDragStop,refreshPositions:true})},_getDragTarget:function(){return this.dragTarget?R.Utils.value(this.dragTarget):this.$el},_getDragImageEl:function(){return this.getDragImageEl?this.getDragImageEl():null},_getDragProxyModel:function(){return this.dragProxyModel?R.Utils.value(this.dragProxyModel):this.model},_getDragComponent:function(){return this.dragComponent?R.Utils.value(this.dragComponent):this},_createDragProxy:function(){var dp=$("<div/>").append('<span class="icon"/>');dp.append('<span class="drag_icon"/>').css({height:1,width:1});if(this.dragProxy){var proxyClass=R.Component.getObject(this.dragProxy);var proxy=new proxyClass({model:this._getDragProxyModel(),imageEl:this._getDragImageEl()});if(proxy){this._proxy=proxy;this._proxy.render(function(){if(!R.isIE8){proxy.$el.css("opacity","0.95")}dp.append(proxy.$el)})}}else{if(!this._dragComponent){this._dragComponent=this._getDragComponent()}var $clone=this._dragComponent.$el.clone();$clone.width(this._dragComponent.$el.width());if(!R.isIE8){$clone.css("opacity","0.95")}dp.append($clone)}this._activeDragProxy=dp;return dp},onDragStart:function(e){this._dragComponent=this._getDragComponent();R.dragManager.dragStart(this._dragComponent)},onDragStop:function(e){R.dragManager.dragEnd(this._dragComponent);delete this._activeDragProxy},removeDragProxy:function(){if(this._activeDragProxy){$(this._activeDragProxy).remove()}}}}();!function(){R.Mixins.formErrors={className:"form_errors",onMixin:function(){this.activeErrors=[]},displayFieldErrors:function(errors){var self=this;this.clearFieldErrors();_.each(errors,function(fieldErrors,fieldName){var $errorInput;var $errorDiv;var content;if(fieldName==="__all__"){return}$errorInput=self.$("[name="+fieldName+"]");if(!$errorInput.length){return}var $errorTextInput=$errorInput.parent(".TextInput");if($errorTextInput.length){$errorInput=$errorTextInput}content=_.map(fieldErrors,function(error){return error.replace(/^(.*?)\s*\.?\s*$/,"$1")}).join(". ");$errorInput.addClass("error");$errorDiv=$("<div class='error_text'>"+content+"</div>");$errorDiv.insertAfter($errorInput);self.activeErrors.push($errorDiv)})},clearFieldErrors:function(){this.$("input.error").removeClass("error");this._removeErrors()},onDestroyed:function(){this._removeErrors();this.activeErrors=null},_removeErrors:function(){while(this.activeErrors.length>0){this.activeErrors.pop().remove()}}}}();!function(){R.Mixins.deeplink={onMixin:function(options){_.bindAll(this,"scrollToDeeplink","_handleRouteChange");this.options.deeplink=_.extend(this.options.deeplink||{},options);_.defaults(this.options.deeplink,{autoload:true});this.deeplink={current:"",started:false,baseUrl:this._getDeeplinkBase()}},onInserted:function(){if(this.options.deeplink.autoload){this.deeplinkInit()}},onDetached:function(){this.invalidate();this._unregisterRouteListener()},onDestroyed:function(){this._unregisterRouteListener()},deeplinkInit:function(){if(this.deeplink.started){return}this.deeplink.started=true;this.listen(R.router,"hashLinkClicked",this.scrollToDeeplink);this.scrollToDeeplink(this._getDeeplinkIdFromUrl(),false)},deeplinkUpdate:function(){this.deeplink.baseUrl=this._getDeeplinkBase()},scrollToDeeplink:function(id,navigate){id=_.isUndefined(id)?this.deeplink.current:id;id=id.replace(/^[#\/\s]*(.*?)[\/\s+]*$/,"$1");navigate=_.isUndefined(navigate)?true:!!navigate;if(id===""&&this.deeplink.current===""){return}if(id!==""&&id===this.deeplink.current){this._scrollToPosition(id);return}this.url=id?this.deeplink.baseUrl+id+"/":this.deeplink.baseUrl;this.deeplink.current=id;if(navigate){R.router.navigate(this.url)}this._scrollToPosition(id);this._registerRouteListener()},_scrollToPosition:function(id){var pos=0;if(id){if(this.options.deeplink.domIdFilter){id=this.options.deeplink.domIdFilter(id)}var el=$("#"+id+",a[name="+id+"]");pos=el.length?el.offset().top-20:0}$(R.router.window).scrollTop(pos);var self=this;setTimeout(function(){if(self.isInserted()&&R.router){$(R.router.window).scrollTop(pos)}},0)},_getDeeplinkIdFromUrl:function(){var fragment=Backbone.history.getFragment();if(fragment.indexOf(this.deeplink.baseUrl)!==0){return""}return fragment.replace(this.deeplink.baseUrl,"")},_getDeeplinkBase:function(){var url=Backbone.history.getFragment().replace(/\/$/,"");var isDeeplinkInUrl=!!_.last(this.options.urlMatches);if(isDeeplinkInUrl){url=_.initial(url.split("/")).join("/")}return url==""?url:url+"/"},_registerRouteListener:function(){this._unregisterRouteListener();this.listen(R.router,"beforeroute",this._handleRouteChange)},_unregisterRouteListener:function(){this.stopListening(R.router,"beforeroute",this._handleRouteChange)},_handleRouteChange:function(e){this._unregisterRouteListener();if(Backbone.history.getFragment().indexOf(this.deeplink.baseUrl)!==0){return}R.Utils.stopEvent(e);this.scrollToDeeplink(this._getDeeplinkIdFromUrl(),false)}}}();!function(){R.Mixins.watchDialogState={className:"watch_dialog_state",PURCHASING:"purchasing",LOADING:"loading",NEW_PURCHASE:"newPurchase",NEW_PAYMENT_PROFILE:"newPaymentProfile",INVALID_PAYMENT_PROFILE:"invalidPaymentProfile",REQUIRE_PURCHASE:"requirePurchase",PURCHASED:"purchased",ERROR:"error",ERROR_INSUFFICIENT_FUNDS:394,ERROR_BAD_ADDRESS:393,onMixin:function(options){_.bindAll(this,"isErrorState","isLoadingState","isNewPurchaseState","isPurchasedState","isPurchasingState","isErrorInsufficientFunds","isErrorBadAddress","isPurchaseRequired")},isErrorState:function(){return this.state()===this.ERROR},isLoadingState:function(){return this.state()===this.LOADING},isNewPurchaseState:function(){return this.state()===this.NEW_PURCHASE},isNewPaymentProfileState:function(){return this.state()===this.NEW_PAYMENT_PROFILE},isPurchasedState:function(){return this.state()===this.PURCHASED},isPurchasingState:function(){return this.state()===this.PURCHASING},isInvalidPaymentProfileState:function(){return this.state()===this.INVALID_PAYMENT_PROFILE},isErrorInsufficientFunds:function(){return this.errorType()===this.ERROR_INSUFFICIENT_FUNDS},isErrorBadAddress:function(){return this.errorType()===this.ERROR_BAD_ADDRESS},isPurchaseRequired:function(){return this.state()==this.REQUIRE_PURCHASE}}}();!function(){R.Mixins.keyart={onRendered:function(){if(this.model.get("keyArtUrl")){if(R.isIpad){this.$(".key_art").addClass("is_ipad")}this.listen(R.app,"resize",this._repositionContent);if(this.isInserted()){this._repositionContent()}}},onInserted:function(){if(this.model.get("keyArtUrl")){this._repositionContent()}},_repositionContent:function(){var keyArt=this.$(".key_art");var width=keyArt.width();var height=width/3.7-20;this.$(".catalog_content").css("margin-top",height+"px");var minWidth=768;var widthUnit=40;var topIncrement=-3.5;var top=-87;if(R.currentUser.isAnonymous()){top+=20}if(width>minWidth){top+=(width-minWidth)/widthUnit*topIncrement}keyArt.css("top",top+"px");var contentGradientHeight=300;var maxHeight=-top+height+contentGradientHeight;keyArt.css("max-height",maxHeight+"px")}}}();!function(){R.Mixins.stickit={onRendered:function(){this.stickit()},onDestroyed:function(){this.unstickit()}}}();!function(){var searchActionEvent="searchResultAction";R.Mixins.searchPageTracking={bubbleSearchResultAction:function(fields){var evt=$.Event();evt.fields=fields;this.bubbleEvent(searchActionEvent,evt)}};R.Mixins.searchResult=_.extend({},R.Mixins.searchPageTracking,{onMixin:function(){this.listen(this,searchActionEvent,this.onSearchResultAction);_.bindAll(this,"onNavigating")},onInserted:function(){this.$("a").data("searchResult",true).on("click",this.onNavigating)},onDetached:function(){this.$("a").removeData("searchResult").off("click",this.onNavigating)},onNavigating:function(evt){this.bubbleSearchResultAction({action:"navigate",navigatingTo:$(evt.currentTarget).prop("pathname")})},onSearchResultAction:function(evt){evt.fields.resultKey=this.model.get("key");if(this.model.collection){evt.fields.resultPosition=this.model.collection.indexOf(this.model)}}})}.call(this);!function(){"use strict";R.Mixins.IconOverrides={icon:function(){var icon=this.attributes.icon;if(window.devicePixelRatio>1&&this.attributes.icon400){icon=this.attributes.icon400}if(icon){icon=R.Utils.secureFixup(icon)}return icon},bigIcon:function(){var icon=this.attributes.bigIcon;if(window.devicePixelRatio>1&&this.attributes.bigIcon1200){icon=this.attributes.bigIcon1200}if(icon){icon=R.Utils.secureFixup(icon)}return icon}}}.call(this);!function(){var MemoryStorage=Backbone.Model.extend({getItem:function(key){return this.get(key)},setItem:function(key,value){this.set(key,value)},removeItem:function(key){this.unset(key)}});R.Services.register("Storage",{isGlobal:true,onInitialized:function(){try{this.localStorage=window.localStorage}catch(e){}this._whitelistedKeys={}},isUsable:function(){return!R.currentUser.isAnonymous()&&this.localStorage},preserveIfNoSpace:function(key){this._whitelistedKeys[key]=true},_handleQuotaExceeded:function(key,value){var memoryStorage=new MemoryStorage;memoryStorage.setItem(key,JSON.stringify(value));for(key in this.localStorage){if(!this._whitelistedKeys[key]){continue}value=this.localStorage.getItem(key);memoryStorage.setItem(key,value)}this.localStorage.clear();this.localStorage=memoryStorage},getItem:function(key){return JSON.parse(this.localStorage.getItem(key)||"null",R.Utils.modelReviver)},setItem:function(key,value){if(_.isUndefined(value)){this.removeItem(key);return}try{this.localStorage.setItem(key,JSON.stringify(value))}catch(err){if(err.name==="QUOTA_EXCEEDED_ERR"){this._handleQuotaExceeded(key,value)}}},removeItem:function(key){this.localStorage.removeItem(key)},clear:function(){try{this.localStorage.clear()}catch(e){}}});R.Services.register("Storage",{isGlobal:true,needsFallback:true,preserveIfNoSpace:R.doNothing,onStarted:function(k){R.Services.ready("FallbackWrapper",function(){k()})},getItem:function(key){return JSON.parse(R.Services.FallbackWrapper.getItem(key)||"null")},setItem:function(key,value){R.Services.FallbackWrapper.setItem(key,JSON.stringify(value))},removeItem:function(key){R.Services.FallbackWrapper.removeItem(key)},clear:function(){R.Services.FallbackWrapper.clear()},isUsable:function(){return!R.currentUser.isAnonymous()}});R.Services.register("Storage",{isGlobal:true,isDummy:true,preserveIfNoSpace:R.doNothing,getItem:function(key){return null},setItem:function(key,value){},removeItem:function(key){},clear:function(){}})}();!function(){var keycodes={8:"backspace",9:"tab",13:"enter",27:"esc",32:"space",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",188:",",191:"slash",219:"leftBracket",221:"rightBracket",179:"playPause",178:"stop",177:"skipBack",176:"skipForward",227:"rewind",228:"fastForward"};var editableTags=["INPUT","TEXTAREA","OBJECT","SELECT","OPTION","OPTGROUP"];function targetIsEditable(el){return _.indexOf(editableTags,el.tagName.toUpperCase())>=0}function modifiersAreDown(e){return e.ctrlKey||e.metaKey||e.altKey}function getEventModifiers(e){var modifiers=[];if(e.shiftKey){modifiers.push("shift")}if(e.altKey){modifiers.push("alt")}if(e.ctrlKey){modifiers.push("ctrl")}if(e.metaKey){modifiers.push("meta")}return modifiers.join("+")}R.Services.register("ShortcutManager",{isGlobal:true,onInitialized:function(){_.bindAll(this,"onKeydown","onKeyup","unbindKeys");$(document).keydown(this.onKeydown);$(document).keyup(this.onKeyup)},lookupKey:function(keycode){return keycodes[keycode]},onKeydown:function(e){var key=this.lookupKey(e.which);if(R.serverInfo.get("prod")&&key==="esc"){e.preventDefault()}if(!key||targetIsEditable(e.target)){return}if(R.isWinDesktop&&[176,177,179].indexOf(e.which)>-1){return}if(modifiersAreDown(e)){this.trigger("pressed:"+getEventModifiers(e)+"+"+key,e)}else{this.trigger("pressed:"+key,e)}if(e.isDefaultPrevented()){this.lastPreventedCode=e.which}},onKeyup:function(e){if(this.lastPreventedCode==e.which){this.lastPreventedCode=null;e.preventDefault()}},unbindKeys:function(){$(document).unbind("keydown",this.onKeydown);$(document).unbind("keyup",this.onKeyup)},isUsable:function(){return!R.currentUser.isAnonymous()}})}();!function(){R.Services.register("WebSocketFactory",{_failureCount:0,_workingSockets:false,_socketErrorListeners:{},_getSocketInfoString:function(socket){var infoProperties=["readyState","bufferedAmount","extensions","protocol"];return _.reduce(infoProperties,function(str,propName,i){var value=socket[propName];if(!_.isUndefined(value)){str+=propName+": "+value;if(i<infoProperties.length-1){str+=", "}}return str},"")},_getErrorListenerForSocket:function(socket){if(!_.isString(socket._id)){throw new Error("Can't get error listener for websocket: no _id property")}var self=this;var listener=this._socketErrorListeners[socket._id];if(!listener){listener=function(e){console.error("[WebSocketFactory] Native websocket error. Socket state: "+self._getSocketInfoString(socket));self._addErrorSample(socket);self.cleanup(socket)};this._socketErrorListeners[socket._id]=listener}return listener},isUsable:function(){if(R.Services.WEBSOCKET_TESTING){return true}if(R.currentUser.isAnonymous()){return false}return window.WebSocket||window.MozWebSocket},onInitialized:function(){_.bindAll(this,"_onOpened","_onClosed","cleanup")
},_onOpened:function(){console.log("[WebSocketFactory] Native websocket opened.");this._workingSockets=true;this._failureCount=0},_onClosed:function(e){var eventInfo="";if(e){eventInfo=JSON.stringify(_.pick(e,"wasClean","code","reason"));console.log("[WebSocketFactory] Native websocket closed with event: ",eventInfo);if(e.target){this.cleanup(e.target)}}else{console.log("[WebSocketFactory] Native websocket closed.")}if(!this._workingSockets&&this._failureCount++>=4){this.trigger("remove");this._connector.stop()}},_addErrorSample:function(socket){if(Math.random()>.01){return}var sample=R.stats.createSample("racoon","websocket_errors");sample.setSamplingRule("websocket_errors");sample.addString("type","native");sample.addString("user",R.currentUser.get("key"));if(_.isNumber(socket.readyState)){sample.addInteger("readyState",socket.readyState)}if(_.isNumber(socket.bufferedAmount)){sample.addInteger("bufferedAmount",socket.bufferedAmount)}if(_.isString(socket.extensions)&&socket.extensions.length>0){sample.addString("extensions",socket.extensions)}if(_.isString(socket.protocol)&&socket.protocol.length>0){sample.addString("protocol",socket.protocol)}if(_.isString(socket.url)&&socket.url.length>0){sample.addString("url",socket.url)}sample.addEnvironmentInfo();sample.flush()},cleanup:function(socket){socket.removeEventListener("open",this._onOpened);socket.removeEventListener("close",this._onClosed);socket.removeEventListener("error",this._getErrorListenerForSocket(socket))},connect:function(urls,secureUrls,timeout,callback){this._secure=(R.currentUser.get("features").secure_websockets||R.settings.get("isApiIframe"))&&secureUrls.length;var servers=this._secure?secureUrls:urls;this._connector=new Connector;this._connector.connect(servers,timeout,this,callback)},create:function(url){var socketConstructor=null;if(window.MozWebSocket){socketConstructor=window.MozWebSocket}else{socketConstructor=window.WebSocket}console.log("[WebSocketFactory] Natively trying to connect to: ",url);var sock=new socketConstructor((this._secure?"wss://":"ws://")+url);sock._id=_.uniqueId();sock.addEventListener("open",this._onOpened);sock.addEventListener("close",this._onClosed);sock.addEventListener("error",this._getErrorListenerForSocket(sock));return sock}});R.Services.register("WebSocketFactory",{needsFallback:true,onStarted:function(k){R.Services.FallbackWrapper.needsFallback();R.Services.ready("FallbackWrapper",function(){k()})},cleanup:R.doNothing,connect:function(urls,secureUrls,timeout,callback){(new Connector).connect(urls,timeout,this,callback)},create:function(url){console.log("[WebSocketFactory] Flash fallback trying to connect to: ",url);return R.Services.FallbackWrapper.createWebSocket(url)},isUsable:function(){return!R.currentUser.isAnonymous()&&swfobject.hasFlashPlayerVersion("9.0")}});R.Services.register("WebSocketFactory",{isDummy:true,cleanup:R.doNothing,connect:function(urls,secureUrls,timeout,callback){callback(this.create(urls[0]))},create:function(url){return{addEventListener:R.doNothing,send:R.doNothing,close:R.doNothing}}});var Connector=function(){this._socket=null;this._serverIndex=-1;this._active=true};_.extend(Connector.prototype,{connect:function(urls,timeout,factory,callback){R.Utils.bindAll(this);_.extend(this,{_urls:urls,_timeout:timeout,_factory:factory,_callback:callback});this._createSocket()},stop:function(){this._active=false},_createSocket:function(){this._serverIndex++;if(this._serverIndex>=this._urls.length){this._callback(null);return}var timeout=this._timeout+Math.floor(Math.random()*(this._timeout/2));var self=this;_.delay(function(){if(!self._active){self._callback(null);return}self._socket=self._factory.create(self._urls[self._serverIndex]);self._socket.addEventListener("open",self._onOpened);self._socket.addEventListener("error",self._onError);self._socket.addEventListener("close",self._onClosed)},timeout)},_onError:function(){this._cleanUp();this._createSocket()},_onClosed:function(){this._cleanUp();this._createSocket()},_onOpened:function(){this._cleanUp();this._callback(this._socket)},_cleanUp:function(){this._socket.removeEventListener("open",this._onOpened);this._socket.removeEventListener("error",this._onError);this._socket.removeEventListener("close",this._onClosed)}})}();!function(){R.Services.register("PubSub",{isGlobal:true,onInitialized:function(){_.bindAll(this,"_opened","_onClosed","_onMessage","_onSocketMessage","_onError","_onOnlineStatusChanged","_connectedWebSocket");this._reconnectIntervals=[1e3,2e3,5e3,1e4,1e4,3e4,6e4,48e4,96e4,96e4,192e4];this._reconnectIndex=0;this._serverList=[];this._secureServerList=[];this._connected=false;this._reconnectTimer=null;this.subscriptions={}},onStarted:function(k){if(R.Services.TESTING&&!R.Services.PUBSUB_TESTING){return}this.readyCallback=k;var self=this;R.Services.ready("WebSocketFactory",function(){self._connect()});R.Services.ready("OfflineMonitor",function(){R.offlineMonitor.bind("change",self._onOnlineStatusChanged)})},_onOnlineStatusChanged:function(isOnline){if(isOnline){if(this._connected==false){if(this._reconnectTimer){clearTimeout(this._reconnectTimer);this._reconnectTimer=null}this._connect()}}else{if(this._connected==true){console.log("[PubSub] closing websocket because status changed to offline.");this._close()}}},_close:function(){this._connected=false;R.Services.WebSocketFactory.cleanup(this._socket);this._socket.removeEventListener("close",this._onClosed);this._socket.removeEventListener("message",this._onSocketMessage);this._socket.removeEventListener("error",this._onError);this._socket.close();this._socket=null;console.log("[PubSub] websocket is closed.")},subscribe:function(topic,listener,context){if(this.subscriptions[topic]){this.subscriptions[topic]++}else{this.subscriptions[topic]=1;if(this._connected){this._sendSubscribe(topic)}}if(listener){this.bind(topic,listener,context)}},unsubscribe:function(topic,listener,context){if(this.subscriptions[topic]){this.subscriptions[topic]--;if(this.subscriptions[topic]===0){delete this.subscriptions[topic];if(this._connected){this._sendUnsubscribe(topic)}}}if(listener){this.unbind(topic,listener,context)}},_bufferedMessages:[],_bufferSize:10,publish:function(topic,message){try{var event="PUB "+topic+"|"+JSON.stringify(message);var discarded;if(this._connected){console.log("[PubSub] Publishing message: "+event);this._socket.send(event)}else{console.log("[PubSub] Buffering message: "+event);this._bufferedMessages.push(event);while(this._bufferedMessages.length>this._bufferSize){discarded=this._bufferedMessages.shift();console.warn("[PubSub] Buffer full, discarding old message: "+discarded)}}}catch(exc){R.Utils.logException("Unable to publish to websocket: ",exc)}},onStopped:function(){this.unbind();this.subscriptions=null;if(this._socket){console.log("[PubSub] closing websocket because PubSub service was stopped.");this._close()}clearInterval(this._reconnectTimeoutDecayId)},userTopic:function(){if(this._connectionInfo==null){console.log("[PubSub] userTopic called too early. Not connected yet.");return null}return this._connectionInfo.topic},_onMessage:function(topic,data){var logData=R.serverInfo.get("prod")?JSON.stringify(data):data;console.log("[PubSub] Received message: ",topic,logData,new Date);this.trigger(topic,topic,data)},_connect:R.Utils.reportErrors(function(){if(this._connected){throw new Error("PubSub was already connected")}var self=this;R.Api.request({method:"pubsubInfo",success:function(data){self._serverList=data.result.servers;self._secureServerList=data.result.secure_servers;self._connectionInfo=data.result;console.log("[PubSub] connecting...");self._connectWebSocket()},error:function(){self._reconnect()}})},"PubSubConnect"),_reconnect:function(){if(this._reconnectTimer){return}if(this._socket){console.log("[PubSub] closing websocket before reconnect attempt.");this._close()}console.log("[PubSub] Disabling reconnect interval decay");clearInterval(this._reconnectTimeoutDecayId);if(this._reconnectIndex<this._reconnectIntervals.length-1){this._reconnectIndex++}var timeout=this._reconnectIntervals[this._reconnectIndex];timeout+=Math.floor(Math.random()*timeout*3);console.log("[PubSub] reconnecting in ",timeout);var self=this;self._reconnectTimer=_.delay(function(){self._reconnectTimer=null;self._connect()},timeout)},_connectionComplete:function(){var caps=R.Services.getCaps();this._socket.send("CONNECT "+this._connectionInfo.token+"|"+JSON.stringify(caps));this._connected=true;this._sendSubscribe(_.keys(this.subscriptions));this.trigger("reconnect");if(this._bufferedMessages.length>0){console.log("[PubSub] Sending buffered messages",this._bufferedMessages.length);while(this._bufferedMessages.length>0){this._socket.send(this._bufferedMessages.shift())}}if(this.readyCallback){this.readyCallback();this.readyCallback=null}},_sendSubscribe:function(topic){if(topic.length==0){return}if(_.isArray(topic)){topic=topic.join(" ")}console.log("[PubSub] Subscribing to: "+topic);this._socket.send("SUB "+topic)},_sendUnsubscribe:function(topic){console.log("[PubSub] Unsubscribing from: "+topic);this._socket.send("UNSUB "+topic)},_opened:function(){if(this._reconnectIndex>0){this._enableReconnectIndexDecay()}this._connectionComplete()},_reconnectTimeoutDecayInterval:function(){return R.Services.PUBSUB_TESTING?100:15e3},_enableReconnectIndexDecay:function(){clearInterval(this._reconnectTimeoutDecayId);var self=this;console.log("[PubSub] Enabling reconnect interval decay");this._reconnectTimeoutDecayId=setInterval(function(){if(self._reconnectIndex>0){self._reconnectIndex--}console.log("[PubSub] Reconnect index has decayed to: "+self._reconnectIndex+", interval is now "+self._reconnectIntervals[self._reconnectIndex]+" ms");if(self._reconnectIndex===0){console.log("[PubSub] Disabling reconnect interval decay");clearInterval(self._reconnectTimeoutDecayId)}},this._reconnectTimeoutDecayInterval())},_onClosed:function(){this._reconnect()},_onSocketMessage:function(e){if(e.data.match(/^PUB/)){var split,j;try{split=e.data.substr(4).split("|");j=JSON.parse(_.rest(split).join("|"),R.Utils.modelReviver)}catch(exc){R.Utils.logException("Unable to parse PUB message: "+e.data,exc);return}try{this._onMessage(split[0],j)}catch(exc){R.Utils.logException("Error in handling PUB message: "+e.data,exc)}}},_onError:function(e){this._reconnect()},_connectWebSocket:function(){var timeout=this._reconnectIntervals[this._reconnectIndex];R.Services.WebSocketFactory.connect(this._serverList,this._secureServerList,timeout,this._connectedWebSocket)},_connectedWebSocket:function(socket){if(socket){socket.addEventListener("close",this._onClosed);socket.addEventListener("message",this._onSocketMessage);socket.addEventListener("error",this._onError);this._socket=socket;this._opened()}else{this._reconnect()}},isUsable:function(){return!R.currentUser.isAnonymous()}});R.Services.register("PubSub",{isGlobal:true,isDummy:true,subscribe:function(topic,listener,context){},unsubscribe:function(topic,listener,context){},publish:function(topic,message){},userTopic:function(){return null}})}();!function($){R.Services.register("DragManager",{isGlobal:true,_dropStack:[],_currentGreedyDrop:null,_dragHappening:false,_mouseDown:false,_dragCounter:0,onInitialized:function(){_.bindAll(this,"_onMouseDown","_onMouseUp")},onStarted:function(){$(document).on("mousedown",this._onMouseDown);$(document).on("mouseup",this._onMouseUp)},onStopped:function(){$(document).off("mousedown",this._onMouseDown);$(document).off("mouseup",this._onMouseUp)},_onMouseDown:function(){this._mouseDown=true},_onMouseUp:function(){this._mouseDown=false},setupDropTarget:function(el,options){var $el=$(el);var self=this;var onEnter,onLeave,onDrop;options=options||{};_.defaults(options,{ignoreEnterLeave:false,greedy:false,onEnter:R.doNothing,onLeave:R.doNothing,onDrop:R.doNothing,canAcceptDrop:true,applyStyling:true});var canAcceptDrop=function(draggedComponent,dropPayload){var opt=options.canAcceptDrop;return _.isFunction(opt)?opt(draggedComponent,dropPayload):opt};if(!options.ignoreEnterLeave){onEnter=function(e,ui){if(self._checkGreedy(el)){return}self._setCurrentTarget(el);ui.helper.removeClass("allowed not_allowed");if(options.applyStyling){if(canAcceptDrop(self._draggedComponent,self.getDropPayload(self._draggedComponent))){$el.addClass("drop_over");ui.helper.addClass("allowed")}else{ui.helper.addClass("not_allowed")}}options.onEnter(e,self._draggedComponent)};onLeave=function(e,ui){$el.removeClass("drop_over");if(self._getCurrentTarget()==el){ui.helper.removeClass("allowed not_allowed")}self._clearDropTarget(el);options.onLeave(e,self._draggedComponent)}}onDrop=function(e){if(self._checkGreedy(el)||!canAcceptDrop(self._draggedComponent,self.getDropPayload(self._draggedComponent))){return}$el.removeClass("drop_over");self.trigger("drop",self._draggedComponent);options.onDrop(e,self.getDropPayload(self._draggedComponent));if(!options.ignoreEnterLeave){self.logSnorkelEvent({src:self._draggedComponent,eventName:"drop",jqueryEvent:e})}};if(options.greedy){$el.data("greedyDrop",true)}try{$el.droppable({tolerance:"pointer",over:onEnter,out:onLeave,drop:onDrop})}catch(e){e.message+=" ("+"jquery object: "+($el instanceof jQuery)+", "+"jquery-ui: "+!!$.ui+", "+"droppable: "+!!$.fn["droppable"]+")";throw e}},cleanupDropTarget:function(el){$(el).droppable("destroy");$(el).data("greedyDrop",null)},setupDragListener:function(el,options){var $el=$(el);var self=this;_.defaults(options,{namespace:"dl",onEnter:R.doNothing,onLeave:R.doNothing,onOver:R.doNothing});if(!$el.hasClass("ui-droppable")){$el.droppable({tolerance:"pointer"})}$el.bind("dropover.dragover_"+options.namespace,function(e){if(el!=e.target){return}$("body").bind("mousemove.dragover_"+options.namespace,function(event){e.originalEvent.pageX=event.originalEvent.pageX;e.originalEvent.clientX=event.originalEvent.clientX;e.originalEvent.pageY=event.originalEvent.pageY;e.originalEvent.clientY=event.originalEvent.clientY});$el.data("dragover",true);setTimeout(function dragover(){options.onOver(e,self._draggedComponent);if($el.data("dragover")){if(!self._mouseDown){console.warn("[DragManager] Dragging got stuck, cancelling");if(self._draggedComponent&&self._draggedComponent.removeDragProxy){self._draggedComponent.removeDragProxy()}self.dragEnd(self._draggedComponent);return}setTimeout(dragover,150)}},150);options.onEnter(e,self._draggedComponent)});$el.bind("dropout.dragover_"+options.namespace,function(e){if(el!=e.target){return}$el.data("dragover",null);$("body").unbind("mousemove.dragover_"+options.namespace);options.onLeave(e,self._draggedComponent)});$el.bind("drop.dragover_"+options.namespace,function(e){$("body").unbind("mousemove.dragover_"+options.namespace)})},cleanupDragListener:function(el,namespace){$(el).unbind(".dragover_"+namespace);$(el).data("dragover",null)},dragStart:function(comp){this._dragHappening=true;$("<div/>").addClass("drag_shield").appendTo("body");this.trigger("dragstart",comp);this._draggedComponent=comp;this.logSnorkelEvent({src:comp,eventName:"start"})},dragEnd:function(comp){this._dragHappening=false;$("body > .drag_shield").remove();this.trigger("dragend",comp);this._clearAllDragoverIntervals();this._clearAllDropTargets();this._draggedComponent=null},isDragHappening:function(){return this._dragHappening},getDropPayload:function(component){if(_.isFunction(component.dropPayload)){return component.dropPayload()}else{return component.model}},_getCurrentTarget:function(){return _.last(this._dropStack)},_setCurrentTarget:function(el){if($(el).data("greedyDrop")){this._currentGreedyDrop=el}this._dropStack.push(el)},_clearDropTarget:function(el){this._dropStack=_.without(this._dropStack,el);if(el==this._currentGreedyDrop){this._currentGreedyDrop=null}},_clearAllDropTargets:function(){this._dropStack=[];this._currentGreedyDrop=null},_clearAllDragoverIntervals:function(){var self=this;$(":data(dragover)").data("dragover",null)},_checkGreedy:function(el){var current=this._getCurrentTarget();if(!current||el==current||el==this._currentGreedyDrop){return false}if(this._currentGreedyDrop){var $el=$(el);var $parents=$el.parents(":data(greedyDrop)");if(!$parents.length){return true}if($parents.get(0)!==current){return true}}return false},logSnorkelEvent:function(params){var src=params.src;var eventName=params.eventName;var sample=R.stats.createSample("racoon","dragndrop");sample.setSamplingRule("racoon_dragndrop");sample.addString("user",R.currentUser.get("key"));if(src&&src.model){if(R.Utils.isInstanceOf(src.model,R.Models.ObjectModel)){sample.addString("src_key",src.model.get("key"));sample.addString("src_type",src.model.get("type"));sample.addString("src_name",src.model.get("name"))}else if(R.Utils.isInstanceOf(src,R.Components.ListItem)&&src.model.get("source")&&R.Utils.isInstanceOf(src.model.get("source"),R.Models.ObjectModel)){sample.addString("src_key",src.model.get("source").get("key"));sample.addString("src_type",src.model.get("source").get("type"));sample.addString("src_name",src.model.get("source").get("name"))}}if(Backbone.history.getFragment()){sample.addString("page",Backbone.history.getFragment())}else{sample.addString("page","Landing Page")}sample.addString("site",Backbone.history.location.hostname);if(params.jqueryEvent){sample.addString("dest_text",$(params.jqueryEvent.target).text().trim());sample.addString("dest_class",$(params.jqueryEvent.target).attr("class").split(" ")[0])}if(_.isNumber(params.index)){sample.addInteger("new_index",params.index)}sample.addString("event",eventName);sample.addInteger("session_drag_count",++this._dragCounter);sample.flush()}})}(R.$);!function(){R.Services.register("Notifications",{isGlobal:true,NOTIFICATION_TYPES:["alert","growl","badge"],PRIORITY:{LOW:1,MEDIUM:2,HIGH:3},onInitialized:function(){this.notifications={};this._appReady=false;this._pendingNotifyEvents=[]},notify:function(type,options){options=_.defaults(options||{},{notificationId:_.uniqueId("notification"),priority:this.PRIORITY.MEDIUM});if(_.indexOf(this.NOTIFICATION_TYPES,type)==-1){return}if(this._higherPriorityExists(type,options.priority)){return}this._addNotification(type,options.notificationId,options.priority,options.namespace);this._notify(type,options);return options.notificationId},_notify:function(type,options){if(this._appReady){this.trigger("notify",options);this.trigger("notify:"+type,options)}else{this._pendingNotifyEvents.push({type:type,options:options})}},setAppReady:function(){var self=this;this._appReady=true;_.each(this._pendingNotifyEvents,function(notifyEvent){self._notify(notifyEvent.type,notifyEvent.options)})},notificationCount:function(type){return _.filter(this.notifications,function(n){return n.type==type}).length},hasNotification:function(id){if(this.notifications.id){return true}return false},clear:function(options){var self=this;var ids;if(options.namespace){ids=this._getNotificationsByNamespace(options.namespace)}else{ids=[this.notifications[options.notificationId]]}_.each(ids,function(n){if(n){self._removeNotification(n.id);self._clear(n)}})},_clear:function(notification){if(this._appReady){this.trigger("clear",notification);this.trigger("clear:"+notification.id,notification);this.trigger("clear:"+notification.type,notification)}else{this._pendingNotifyEvents=_.reject(this._pendingNotifyEvents,function(evt){return evt.options.id===notification.id})}},_higherPriorityExists:function(type,priority){if(type=="badge"){return false}return _.any(_.values(this.notifications),function(n){return n.type===type&&n.priority>priority})},_getNotificationsByNamespace:function(namespace){return _.filter(_.values(this.notifications),function(n){return n.namespace===namespace})},_removeNotification:function(id){if(_.has(this.notifications,id)){delete this.notifications[id]}},_addNotification:function(type,id,priority,namespace){if(_.has(this.notifications,id)&&type!="badge"){this.clear({notificationId:id})}this.notifications[id]={id:id,namespace:namespace,type:type,priority:priority}}})}();!function(){R.Services.register("OfflineMonitor",{isGlobal:true,onInitialized:function(){var self=this;this._currentState=navigator.onLine;this._timer=setInterval(function(){self._onTick()},2e3)},isOnline:function(){return this._currentState},setIsOnline:function(online){if(this._timer){clearInterval(this._timer);this._timer=null}this._changeState(online)},_onTick:function(){this._changeState(navigator.onLine)},_changeState:function(online){if(this._currentState===online){return}console.log("[OfflineMonitor] Online state changed from: "+this._currentState+" to: "+navigator.onLine);var oldState=this._currentState;this._currentState=online;R.recordEvent("service:"+this._name,online?"online":"offline");this.trigger("change",this._currentState,oldState)}})}();!function(){var completedTimers=[];var counters=[];var flushedSamples=[];var snorkelMixin={initSnorkelFields:function(){this._sets={};this._integers={};this._strings={};this._dataset=null;this._subset=null;this._wantsRequestInfo=false;this._samplingRule=null},addSnorkelFields:function(repr){repr=repr||{};var metadata={};if(_.keys(this._strings).length){metadata.string=this._strings}if(_.keys(this._integers).length){metadata.integer=this._integers}if(_.keys(this._sets).length){metadata.set=this._sets}if(this._dataset){metadata.dataset=this._dataset}if(this._subset){metadata.subset=this._subset}if(this._wantsRequestInfo){metadata.wantsRequestInfo=true}if(this._samplingRule){metadata.samplingRule=this._samplingRule}repr.metadata=metadata;return repr},addString:function(key,value){this._strings[key]=value},addInteger:function(key,value){this._integers[key]=value},addSet:function(key,values){this._sets[key]=values},setDataset:function(dataset,subset){this._dataset=dataset;if(_.isString(subset)){this._subset=subset}},setSubset:function(subset){this._subset=subset},setSamplingRule:function(rule){this._samplingRule=rule},addExperimentResult:function(rule){if(!this._added_zuuls){this._zuuls_on=[];this._zuuls_off=[];this.addSet("zuuls_on",this._zuuls_on);this.addSet("zuuls_off",this._zuuls_off);this._added_zuuls=true}var features=R.currentUser.get("features");var result=features&&features[rule];if(result){this._zuuls_on.push(rule)}else{this._zuuls_off.push(rule)}},addFlashInfo:function(){var flashInfo=swfobject.getFlashPlayerVersion();var flashVersionString=[flashInfo.major,flashInfo.minor,flashInfo.release].join(".");this.addString("flashVersion",flashVersionString);this.addInteger("flashVersionMajor",flashInfo.major);this.addInteger("flashVersionMinor",flashInfo.minor);this.addInteger("flashVersionRelease",flashInfo.release)},addEnvironmentInfo:function(){var env=R.Utils.getUserEnvironment(navigator);this.addInteger("browserVersion",env.browserVersion);this._wantsRequestInfo=true},addLocalPlayerInfo:function(){var playingSource=R.player.playingSource();if(playingSource){this.addString("playingSource",playingSource.get("key"))}var playingTrack=R.player.playingTrack();if(playingTrack){this.addString("playingTrack",playingTrack.get("key"))}var sourcePosition=R.player.sourcePosition();if(_.isNumber(sourcePosition)){this.addInteger("sourcePosition",sourcePosition)}this.addInteger("playState",R.player.playState());var position=R.player.position();if(_.isNumber(position)){this.addInteger("position",position)}this.addInteger("repeat",R.player.repeat());this.addString("shuffle",R.player.shuffle());var station=R.player.station();if(station){this.addString("station",station.get("key"))}}};function Sample(dataset,subset){this.initSnorkelFields();if(_.isString(dataset)){this._dataset=dataset}if(_.isString(subset)){this._subset=subset}this._time=Math.round((new Date).getTime())}_.extend(Sample.prototype,snorkelMixin,{toJSON:function(){return _.extend({clientTimestamp:this._time,samplingRule:this._samplingRule},this.addSnorkelFields().metadata)},flush:function(){flushedSamples.push(this)}});function Timer(name,browser,startTime){this.name=name;this._browser=browser;this.initSnorkelFields();if(!startTime){this.startTime=new Date;if(console.time){console.time(name)}}else{this.startTime=startTime}}_.extend(Timer.prototype,snorkelMixin,{stop:function(){var endTime=new Date;this.time=endTime-this.startTime;if(console.timeEnd){console.timeEnd(this.name)}else{console.log("[Timer]",this.name+":",this.time)}completedTimers.push(this);return this.time},stopAndOverrideTime:function(time){this.time=time;console.log("[Timer]",this.name+":",this.time);completedTimers.push(this)},attachTo:function(timer){if(!timer){return}this.timer=timer},toJSON:function(){if(this.timer){this.addString("page_name",this.timer.name);this.addInteger("page_start",this.startTime-this.timer.startTime);this.addInteger("page_end",this.startTime-this.timer.startTime+this.time)}var json_repr=this.addSnorkelFields({bucket:this.name+"."+this._browser,stat:this.time+"|ms",timestamp:this.startTime});return json_repr}});function Counter(name,browser){this.name=name;this._browser=browser;this._count=0;this._serverCount=0;this.initSnorkelFields();this.setDataset("rdio","client_counters");counters.push(this)}_.extend(Counter.prototype,snorkelMixin,{increment:function(){this._count+=1},getCount:function(){return this._count},_needsToBeSaved:function(){return this._count!==this._serverCount&&!this._isSaving},_beginSaving:function(){this._isSaving=true;this._countBeingSaved=this._count},_completeSave:function(){this._isSaving=false;this._serverCount=this._countBeingSaved},_failSave:function(){this._isSaving=false},toJSON:function(){var delta=this._count-this._serverCount;return this.addSnorkelFields({bucket:this.name+"."+this._browser,stat:delta+"|c"})}});R.Services.register("Stats",{isGlobal:true,onInitialized:function(){_.bindAll(this,"reportToServer")},onStarted:function(k){this._interval=setInterval(this.reportToServer,2e4);var env=R.Utils.getUserEnvironment(navigator);this._browser=env.browser.replace(/ /g,"-");if(env.browser==="Internet Explorer"){this._browser="IE"+env.browserVersion}if(Env.timers){var self=this;_.each(Env.timers,function(time,name){var timer=new Timer(name,self._browser);timer.stopAndOverrideTime(time)});Env.timers=null}k()},onStopping:function(){clearInterval(this._interval);this.reportToServer()},_reDots:/\./g,createSample:function(dataset,subset){return new Sample(dataset,subset)},createTimer:function(name,startTime){var timer=new Timer(this._getBucketName(name),this._browser,startTime);this.trigger("createTimer",timer);return timer},createCounter:function(name){return new Counter(this._getBucketName(name),this._browser)},_getBucketName:function(names){var self=this;if(_.isString(names)){names=[names]}return _.reduce(_.tail(names),function(name,arg){return name+"."+arg.replace(self._reDots,"_")},names[0].replace(self._reDots,"_"))},_clearQueuedSamples:function(){flushedSamples=[]},reportToServer:function(){var self=this;var updatedCounters=_.filter(counters,function(c){return c._needsToBeSaved()});var statObjects=completedTimers.concat(updatedCounters);completedTimers=[];var sampleObjects=_.clone(flushedSamples);this._clearQueuedSamples();if(!statObjects.length&&!sampleObjects.length){return}_.each(updatedCounters,function(c){c._beginSaving()});R.Api.request({method:"recordClientStats",content:{graphiteStats:JSON.stringify(statObjects),snorkelSamples:JSON.stringify(sampleObjects),revision:R.VERSION.version},success:function(){_.each(updatedCounters,function(c){c._completeSave()})},error:function(resp){console.error("could not record stats",resp);if(self.isReady()){_.each(updatedCounters,function(c){c._failSave()})}}})}})}();!function($){var PERFORMANCE_SAMPLE_INTERVAL=33;var PERFORMANCE_SAMPLE_QUEUE_SIZE=1e3;var PERFORMANCE_CANVAS_GRAPH_PADDING=15;var PERFORMANCE_LAG_THRESHOLD=2;var IMAGE_CDNS={EDGECAST:/img[0-9]{2}\.cdn2-rdio\.com/,AKAMAI:/rdio[0-9]img-a\.akamaihd\.net/};R.Services.register("Instrumentation",{isGlobal:true,onInitialized:function(){var appLoadTimer=R.stats.createTimer("perfService");this.setPageTimer(appLoadTimer);var self=this;R.stats.on("createTimer",function(timer){if(self._page_timer){timer.attachTo(self._page_timer)}});var features=R.currentUser.get("features");if(!features){return}if(features.snorkel_app_delivery){this._collectNavigationTimings();this._subscribeToLoader()}if(features.snorkel_hive){this._subscribeToHive()}if(features.snorkel_images){this._subscribeToImageLoader()}if(features.performance_sampling){this._startPerformanceAnalysis()}},_subscribeToHive:function(){R.Services.ready("Hive",function(svc){R.Services.Hive.on("work",function(work){var operation=work.get("data").operation;var timer=R.stats.createTimer("hive."+operation);timer.setDataset("rdio","hive");timer.addString("timeout","no");timer.addString("error","no");var deferred=work.get("deferred");if(deferred){deferred.promise().done(function(results){if(operation==="blur"){timer.addInteger("blur_ms",results.time);timer.addInteger("width",results.w);timer.addInteger("height",results.h);timer.addInteger("pixels",results.w*results.h)}if(work.get("for_web_worker")){timer.addString("worker","yes")}else{timer.addString("worker","no")}timer.stop()}).fail(function(err){if(err.isTimeout){timer.addString("timeout","yes")}else{timer.addString("error","yes")}})}})})},_subscribeToImageLoader:function(){var self=this;var _creations=[];this.on("image:create",function(item){item.__created=+Date.now()});this.on("image:load",function(item,src){var duration=Date.now()-item.__created;_creations.push({duration:duration,src:src})});this.recordImageStats=function(){if(!_creations.length){return}_.each(IMAGE_CDNS,function(matcher,cdn){var samples=_.filter(_creations,function(c){return matcher.test(c.src)});if(!samples.length){return}var total_time=_.reduce(samples,function(total,c){return total+c.duration},0);var sample=R.stats.createSample("image_loads");sample.setDataset("rdio","client_images");sample.addInteger("count",samples.length);sample.addInteger("total time",total_time);sample.addInteger("avg time",total_time/samples.length);sample.addString("cdn",cdn);sample.flush()})};if(R.router){R.router.on("contentChanged",function(){self.recordImageStats();_creations=[]})}},_subscribeToLoader:function(){var self=this;var load_timers=this._subscribeToLoader.load_timers||{};this._subscribeToLoader.load_timers=load_timers;R.Services.ready("Loader",function(svc){R.loader.on("requested",function(resource,component){if(!load_timers[resource]){var timer=R.stats.createTimer("download."+component,self._browser);load_timers[resource]=timer;timer.setDataset("rdio","resource_download_times")}});R.loader.on("downloaded",function(resource){if(load_timers[resource]){load_timers[resource].stop();delete load_timers[resource]}})})},_collectNavigationTimings:function(){var timings=this._getPerformanceTimings();if(!timings){return}var env=R.Utils.getUserEnvironment(navigator);var browser=env.browser.replace(/ /g,"-");var start=timings.navigationStart;_.each(timings,function(abs_time,name){if(!abs_time){return}var timer=R.stats.createTimer(name);timer.setDataset("rdio","w3c_timings");timer.stopAndOverrideTime(abs_time-start)})},_getPerformanceTimings:function(){return window.performance&&window.performance.timing},_startPerformanceAnalysis:function(){if(this.hasOwnProperty("_fpsInterval")){return}var self=this;var i;var performanceSamples=this._performanceSamples=[];for(i=0;i<PERFORMANCE_SAMPLE_QUEUE_SIZE;i++){performanceSamples.push(0)}self._performanceHead=0;var previousTime=Date.now();self._fpsInterval=setInterval(function(){var currentTime=Date.now();performanceSamples[self._performanceHead]=Math.max(currentTime-previousTime-PERFORMANCE_SAMPLE_INTERVAL,0);previousTime=currentTime;self._performanceHead++;if(self._performanceHead===PERFORMANCE_SAMPLE_QUEUE_SIZE){self._performanceHead=0}},PERFORMANCE_SAMPLE_INTERVAL);var networkSamples=this._networkSamples=[];for(i=0;i<PERFORMANCE_SAMPLE_QUEUE_SIZE;i++){networkSamples.push(undefined)}this._benchmarks={};self._networkHead=0;this._nativeAjax=$.ajax;$.ajax=_.bind(function(){var start=Date.now();
var jxhr=this._nativeAjax.apply(this,arguments);jxhr.always(function(){networkSamples[self._networkHead]={start:start,end:Date.now()};self._networkHead++;if(self._networkHead===PERFORMANCE_SAMPLE_QUEUE_SIZE){self._networkHead=0}});return jxhr},this)},_stopPerformanceAnalysis:function(){if(!this.hasOwnProperty("_fpsInterval")){return}this.hidePerformanceVisualization();clearInterval(this._fpsInterval);delete this._fpsInterval;$.ajax=this._nativeAjax},showPerformanceVisualization:function(options){if(!R.currentUser.get("features").performance_sampling){console.warn("[Benchmarking] Current user does not have permission to use performance sampling");return}if(!this.hasOwnProperty("_fpsInterval")){console.warn("[Benchmarking] Performance analysis is not running. You can start it with R.instrumentation._startPerformanceAnalysis()");return}options=options||{};_.defaults(options,{location:"topright",width:400,height:150,updateInterval:1e3});var width=options.width;var height=options.height;var self=this;if(self._showingVisualization){self.hidePerformanceVisualization()}self._showingVisualization=true;self._fpsCanvas=$('<canvas width="'+width+'" height="'+height+'">');self._fpsCanvas.css({border:"1px solid #aaa","background-color":"#fff",position:"absolute","z-index":1e3});switch(options.location){case"topleft":self._fpsCanvas.css({top:0,left:0});break;case"topright":self._fpsCanvas.css({top:0,right:0});break;case"bottomright":self._fpsCanvas.css({bottom:0,right:0});break;case"bottomleft":self._fpsCanvas.css({bottom:0,left:0});break}self._fpsContext=self._fpsCanvas[0].getContext("2d");$("body").append(self._fpsCanvas);self._fpsAnalysisInterval=setInterval(function(){if(self._fpsContext){var context=self._fpsContext;var samples=self._performanceSamples;context.fillStyle="#fff";context.fillRect(0,0,width,height);var sampleWindow;if(self._performanceHead<width){sampleWindow=samples.slice(PERFORMANCE_SAMPLE_QUEUE_SIZE-width+PERFORMANCE_CANVAS_GRAPH_PADDING+self._performanceHead).concat(samples.slice(0,self._performanceHead))}else{sampleWindow=samples.slice(self._performanceHead-width+PERFORMANCE_CANVAS_GRAPH_PADDING,self._performanceHead)}context.strokeStyle="#333";context.beginPath();context.moveTo(0,height-PERFORMANCE_CANVAS_GRAPH_PADDING);context.lineTo(width,height-PERFORMANCE_CANVAS_GRAPH_PADDING);context.stroke();context.beginPath();context.moveTo(width-PERFORMANCE_CANVAS_GRAPH_PADDING,0);context.lineTo(width-PERFORMANCE_CANVAS_GRAPH_PADDING,height);context.stroke();context.fillStyle="#333";context.fillText("0",width-10,height-PERFORMANCE_CANVAS_GRAPH_PADDING+10);context.fillText("Time (ms)",width/2-25,height-PERFORMANCE_CANVAS_GRAPH_PADDING+10);context.save();context.rotate(Math.PI/2);context.fillText("Lag (ms)",height/2-25,-width+10);context.restore();context.strokeStyle="#f00";context.beginPath();context.moveTo(0,height-sampleWindow[0]-PERFORMANCE_CANVAS_GRAPH_PADDING);for(var i=0;i<width;i++){context.lineTo(i,height-sampleWindow[i]-PERFORMANCE_CANVAS_GRAPH_PADDING)}context.stroke()}},options.updateInterval)},hidePerformanceVisualization:function(){if(!R.currentUser.get("features").performance_sampling){console.warn("Current user does not have permission to use performance sampling");return}if(!this.hasOwnProperty("_fpsInterval")){console.warn("Performance analysis is not running. You can start it with R.instrumentation._startPerformanceAnalysis()");return}if(this._fpsCanvas){this._fpsCanvas.remove();this._fpsCanvas=null;clearInterval(this._fpsAnalysisInterval)}},startBenchmark:function(name){if(!R.currentUser.get("features").performance_sampling){console.warn("[Benchmarking] Current user does not have permission to use performance sampling");return}if(!this.hasOwnProperty("_fpsInterval")){console.warn("[Benchmarking] Performance analysis is not running. You can start it with R.instrumentation._startPerformanceAnalysis()");return}if(this._benchmarks[name]){console.warn('[Benchmarking] Benchmark "'+name+'" already exists. Previous results will be discarded')}else{console.log('[Benchmarking] Starting benchmark "'+name+'"')}this._benchmarks[name]={head:this._performanceHead,networkhead:this._networkHead,start:Date.now()}},isBenchmarkRunning:function(name){return this._benchmarks.hasOwnProperty(name)},endBenchmark:function(name){var endTime=Date.now();if(!R.currentUser.get("features").performance_sampling){console.warn("[Benchmarking] Current user does not have permission to use performance sampling");return}if(!this.hasOwnProperty("_fpsInterval")){console.warn("[Benchmarking] Performance analysis is not running. You can start it with R.instrumentation._startPerformanceAnalysis()");return}console.log('[Benchmarking] Ending benchmark "'+name+'"');var samples=this._performanceSamples;var benchmark=this._benchmarks[name];if(!benchmark){console.error('[Benchmarking] Benchmark "'+name+'" does not exist');return}var performanceSampleWindow;if((endTime-benchmark.start)/PERFORMANCE_SAMPLE_INTERVAL>PERFORMANCE_SAMPLE_QUEUE_SIZE-10){console.warn("[Benchmarking] Analysis of "+name+" overran the sample queue. Performance Analysis will only include the last "+PERFORMANCE_SAMPLE_QUEUE_SIZE*PERFORMANCE_SAMPLE_INTERVAL/1e3+" seconds of data");performanceSampleWindow=samples.slice(this._performanceHead).concat(samples.slice(0,this._performanceHead))}else{if(this._performanceHead<benchmark.head){performanceSampleWindow=samples.slice(benchmark.head).concat(samples.slice(0,this._performanceHead))}else{performanceSampleWindow=samples.slice(benchmark.head,this._performanceHead)}}var laggedSamples=[];var lagSum=0;_.each(performanceSampleWindow,function(sample){if(sample>PERFORMANCE_LAG_THRESHOLD){laggedSamples.push(sample);lagSum+=sample}});var networkSampleWindow;if(this._networkHead<benchmark.networkhead){networkSampleWindow=this._networkSamples.slice(benchmark.networkhead).concat(samples.slice(0,this._networkHead))}else{networkSampleWindow=this._networkSamples.slice(benchmark.networkhead,this._networkHead)}var numNetworkSamples=0;var networkTime=0;var netMin,netMax;_.each(networkSampleWindow,function(networkSample){if(networkSample&&networkSample.start>=benchmark.start&&networkSample.end<=endTime){numNetworkSamples++;var netTime=networkSample.end-networkSample.start;networkTime+=netTime;if(isNaN(netMin)||netTime<netMin){netMin=netTime}if(isNaN(netMax)||netTime>netMax){netMax=netTime}}});delete this._benchmarks[name];var results={performance:{frames:performanceSampleWindow.length,laggedFrames:laggedSamples.length,total:lagSum},xhr:{requests:numNetworkSamples,avg:Math.round(networkTime/numNetworkSamples),max:netMax||0,min:netMin||0},elapsedTime:endTime-benchmark.start};return results},onAppStarted:function(){var self=this;R.app.on("pageTimer",function(timer){self.setPageTimer(timer)})},setPageTimer:function(timer){this._page_timer=timer}})}(R.$);!function(){R.Services.register("ErrorReporter",{onStarted:function(k){_.bindAll(this,"reportError","_resetCounter");this._errorCounter=0;this._timer=setInterval(this._resetCounter,6e4);this._initializeRollbar();window.onerror=this.reportError;k()},onStopping:function(){window.onerror=R.doNothing;clearInterval(this._timer)},_initializeRollbar:function(){var _rollbarParams={"server.environment":R.serverInfo.get("prod")?"prod":"dev",person:{id:R.currentUser.get("key"),username:R.currentUser.get("vanity_name"),email:R.currentUser.get("email")},level:"error","client.javascript.source_map_enabled":true,"client.javascript.code_version":R.VERSION.version};_rollbarParams["notifier.snippet_version"]="2";window._rollbar=["86bf5889367b4112918ba3606c52938b",_rollbarParams];!function(w,d){var s=d.createElement("script");var f=d.getElementsByTagName("script")[0];s.src="//d37gvrvc0wt4s1.cloudfront.net/js/1/rollbar.min.js";s.async=!0;f.parentNode.insertBefore(s,f)}(window,document)},_resetCounter:function(){this._errorCounter=0},_hostRe:new RegExp(window.location.host.replace("www.","")),reportError:function(msg,url,lineNo,colNo,exc){try{this._errorCounter++;if(this._errorCounter>=30){R.Services.stop("ErrorReporter");return}if(!url||!this._hostRe.test(url)){return}if(exc&&exc.stack&&exc.stack.indexOf("tv-classic")!==-1){return}if(R.Services.TESTING){return}console.log("[Rdio 2 Error] msg:"+msg+" url:"+url+" line:"+lineNo);try{_rollbar.extraParams.client.log=R.logger.logQueue.join("\n");_rollbar.extraParams.client.recordedStates=R.serializeRecordedEvents();_rollbar.handleUncaughtError.apply(_rollbar,arguments)}catch(e1){console.warn("Couldn't report error to rollbar")}R.Api.request({method:"jsError",content:{version:R.VERSION.version,msg:msg.toString(),url:url,line:lineNo,location:window.location.toString(),log:R.logger.logQueue.join("::"),stack:exc&&exc.stack},success:function(){console.log("reported error to server")},error:function(){console.error("could not report error",arguments)}})}catch(e2){console.exception("Exception occurred while reporting error: ",e2)}},reportVdioPlaybackError:function(code,message,detail,url,token,flashVersion){R.Api.request({method:"vdioPlaybackError",content:{code:code,message:message,detail:detail,url:url,token:token,flashVersion:flashVersion||"",location:window.location.toString(),log:R.logger.logQueue.join(":::")},success:function(){console.log("reported playback error to server")},error:function(){console.error("could not report playback error",arguments)}})}})}();!function(){var THROTTLE_TIME=200;R.Services.register("EventReporter",{onStarted:function(k){_.bindAll(this,"_getTxid","_getAndClearTxid","progress","started","finished","paused","resumed","qos");this._queue=new R.ApiRequestQueue({callAllSuccessCallbacks:true});var self=this;_.each(["started","finished","paused","resumed","progress","qos"],function(method){self[method]=_.throttle(self[method],THROTTLE_TIME)});k()},started:function(model,content,k){var self=this;content=content||{};content.key=model.get("key");return this._queue.push({method:"addStartEvent",content:content,success:function(response){var result=response.result;self._txid=result.txid;console.log("[EventReporter] Playback started, txid: "+self._txid);if(_.isFunction(k)){k(result)}},error:function(){console.error("Error calling addStartEvent API")}})},setTransaction:function(txid){this._txid=txid},_getTxid:function(){if(!this._txid){throw new Error("Recorded event that needed a txid before starting or resuming a transaction")}return this._txid},_getAndClearTxid:function(){var txid=this._getTxid();this._txid=null;return txid},finished:function(){var self=this;this._queue.push({method:"addFinishEvent",content:{txid:this._getTxid},complete:function(){self._txid=null}})},paused:function(time){this._queue.push({method:"addPauseEvent",content:{txid:this._getTxid,time:Math.round(time)}})},resumed:function(time){this._queue.push({method:"addResumeEvent",content:{txid:this._getTxid,time:Math.round(time)}})},seek:function(from,to){this.paused(from);this.resumed(to)},progress:function(time,stats,k){var content={txid:this._getTxid,time:Math.round(time)};if(_.isObject(stats)){content.qosStats=JSON.stringify(stats)}var self=this;this._queue.push({method:"addTimedPlayInformation",content:content,success:function(response){if(_.isFunction(k)){k(response.result)}},error:function(){console.error("Error calling addTimedPlayInformation API for txid: "+self._getTxid())}})},qos:function(stats){this._queue.push({method:"recordVdioQosStats",content:{txid:this._getTxid,stats:JSON.stringify(stats)}})},skipped:function(time,k){this._queue.push({method:"addSongSkippedTime",content:{txid:this._getAndClearTxid,time:Math.round(time)},success:function(response){if(_.isFunction(k)){k(response.result)}},error:function(){console.error("Error calling addSongSkippedTime API")}})}})}();!function($){R.Services.register("Facebook",{onInitialized:function(){R.Utils.bindAll(this)},onStarted:function(k){var self=this;this._fbInited=false;this.initFB(k)},initFB:function(k){var self=this;if($("#fb-root").length===0){$("body").prepend('<div id="fb-root" />')}var useFBMusic=R.settings.get("enableFbMusicBridge");R.fbInit(useFBMusic,function(){self._facebookReady(k)})},_facebookReady:function(k){var self=this;var $fbFlash=$("#fb-root object");$fbFlash.attr({wmode:"transparent",height:"1px",width:"1px"});$fbFlash.css({position:"absolute",top:"-1px"});window.FB.Event.subscribe("fb.music.PLAY",this.onFBMusicBridgePlay);window.FB.Event.subscribe("fb.music.RESUME",this.onFBMusicResume);window.FB.Event.subscribe("fb.music.PAUSE",this.onFBMusicPause);window.FB.Event.subscribe("fb.music.STATUS",this.onFBMusicStatus);R.Services.ready("Player",function(){self._oldState={playing:R.player.isPlaying()};var playingSource=R.player.playingSource();if(playingSource&&playingSource.get("url")){self._oldState.song=R.Utils.fullUrl(playingSource.get("url"))}R.player.bind("change:playState",self.onPlayEvent);R.player.bind("change:playingTrack",self.onPlayEvent);R.player.bind("change:position",self.onPositionChanged)});this._fbInited=true;k()},onStopping:function(){if(this._fbInited){this.destroyFB()}},onPositionChanged:function(){var curPosition=R.player.position();var sinceLastReport;var report;if(!this._lastSavedPosition||!this._lastSavedPositionTime){report=true}else{sinceLastReport=(new Date-this._lastSavedPositionTime)/1e3;if(Math.abs(sinceLastReport-(curPosition-this._lastSavedPosition))>1){report=true}}if(report){this._lastSavedPosition=curPosition;this._lastSavedPositionTime=new Date;this.sendFBStatus(false)}},destroyFB:function(){var self=this;this._oldState={};if(window.FB&&window.FB.Event){window.FB.Event.unsubscribe("fb.music.PLAY",this.onFBMusicBridgePlay);window.FB.Event.unsubscribe("fb.music.RESUME",this.onFBMusicResume);window.FB.Event.unsubscribe("fb.music.PAUSE",this.onFBMusicPause);window.FB.Event.unsubscribe("fb.music.STATUS",this.onFBMusicStatus)}R.Services.ready("Player",function(){R.player.unbind("change:playState change:playingTrack change:position",self.onPlayEvent)});$("#fb-root").remove();this._fbInited=false},playSource:function(options){R.Services.ready("Player",function(){var shouldEnqueue=!options.waitToAutoPlay&&R.player.playingSource()&&R.player.playingSource().get("key")!==options.source.get("key");if(shouldEnqueue){R.player.queue.addPlayingSource()}R.player.play(options)})},onFBMusicBridgePlay:function(params,callback){var sample=R.stats.createSample("rdio","facebookMusicBridge");sample.addString("event","play");sample.addString("user",R.currentUser.get("key"));sample.addEnvironmentInfo();sample.flush();params.fromBridge=true;this.onFBMusicPlay(params,callback)},onFBMusicPlay:function(params,callback){var self=this;var url="";var extras=["tasteProfileKey","collectionKey"];var options={};var prepareObj=function(model){var type=model.get("type");var key;if(type==="s"){if(model.get("tasteProfileKey")){key=model.get("tasteProfileKey")}else if(model.get("collectionKey")){key=model.get("collectionKey")}}else if(type==="r"){key=model.get("topSongsKey")}else{key=model.get("key")}return new Backbone.Model({key:key})};var parseUrl=function(url){var urlParts=R.Utils.parseUrl(url);var params=R.Utils.getQueryStringParams(urlParts.search);if(params.ap_url){return{url:params.ap_url,affiliateUrl:urlParts.protocol+"//"+urlParts.host+urlParts.pathname}}else{return{url:decodeURIComponent(url)}}};var findSongInSource=function(song){song=parseUrl(song).url;return function(model){var tracks=model.get("tracks");var newModel=new Backbone.Model({key:model.get("key")});if(!song||!tracks||!tracks.length){return newModel}var offset=0;tracks.find(function(track,i){if(song.indexOf(track.get("url"))===-1){return false}offset=i;return true});options.index=offset;return newModel}};if(params.song){url=params.song;var source=params.album||params.playlist;if(source){url=source;extras=["tracks"];prepareObj=findSongInSource(params.song)}}else if(params.playlist){url=params.playlist}else if(params.album){url=params.album}else if(params.musician){url=params.musician}else{url=R.Utils.getWindowLocation().pathname}if(!url||url.length===0){return}var parsedUrl=parseUrl(url);var obj=new R.Models.ObjectModel({url:parsedUrl.url},{extras:extras});obj.fetch({success:function(source,reply){source=prepareObj(source);options.source=source;if(params.listen_with_friends){options.waitToAutoPlay=10}if(params.offset){options.initialPosition=params.offset}if(callback){callback(options)}self.playSource(options)}});if(params.fromBridge&&parsedUrl.affiliateUrl){R.Api.request({method:"recordAffiliateLinkFollowed",content:{url:parsedUrl.affiliateUrl},success:function(response){var result=response.result;self._setCookie(result.key,result.value,result.expires)},error:function(e){console.error('Error recording affiliate link follow for "'+parsedUrl.affiliateUrl+'".');console.error(e.message)}})}},_setCookie:function(key,value,expires){document.cookie=[key,"=",value,"; expires=",expires,"; path=/"].join("")},onFBMusicResume:function(params){R.Services.ready("Player",function(){R.player._play()})},onFBMusicPause:function(params){R.Services.ready("Player",function(){R.player._pause()})},onFBMusicStatus:function(params){this.sendFBStatus(true)},onPlayEvent:function(e){this.sendFBStatus(false)},sendFBStatus:function(force){var self=this;R.Services.ready("Player",function(){var currentUser=R.currentUser;if(!currentUser.get("has_facebook")){return}var isPlaying=R.player.isPlaying();var openGraphDisabled=!currentUser.get("prefs").get("fbScrobble");var data={playing:isPlaying,user_id:currentUser.get("facebookId"),post_open_graph:{open_graph_disabled:openGraphDisabled,private_session:false}};var playingTrack=R.player.playingTrack();if(playingTrack){data.song=R.Utils.fullUrl(playingTrack.get("url"));if(isPlaying){data.expires_in=Math.max(0,Math.floor(playingTrack.get("duration")-R.player.position()))}}if(!force&&_.isEqual(data,self._oldState)){return}self._oldState=data;try{window.FB.Music.send("STATUS",data)}catch(e){console.error("Error sending status to Facebook music bridge")}})}})}(R.$);!function(){R.Services.register("Defer",{onInitialized:function(options){this.queue=new R.Models.PriorityQueue},_ensuredBrowserTime:30,_ensuredWindow:100,_accumulatedRuntime:0,_delay:0,_doWork:function(){if(!this.queue.length){return}var work=this.queue.pop();var start=Date.now();this._delayId=_.delay(function(self){var fn=work.get("fn");var res=fn();if(res&&res.err){console.error("[Defer]",res.err);work.get("deferred").reject(new Error(res.err))}else{work.get("deferred").resolve(res)}self._accumulatedRuntime+=Date.now()-start;if(self._accumulatedRuntime>self._ensuredWindow){self._delay=self._ensuredBrowserTime;self._accumulatedRuntime=0}else{self._delay=0}self._doWork()},this._delay||1,this)},defer:function(work){if(!work.has("id")){throw new Error("Tried to defer work without an id")}var existing=this.queue.get(work.get("id"));if(existing){existing.set(work.attributes);return existing.get("deferred").promise()}work.set("deferred",$.Deferred());this.queue.add(work);this._doWork();return work.get("deferred").promise()},cancel:function(id){var work=this.queue.get(id);if(work){this.queue.remove(work);work.reject(new Error("Deferred work cancelled"))}},onStopped:function(){clearTimeout(this._delayId);this.queue.reset()},onStarted:function(k){k()}})}.call(this);!function(){R.Services.register("Hive",{poolSize:4,workTimeout:5e3,idleTimeout:1e4,onInitialized:function(){R.Utils.bindAll(this);this.workers=new Backbone.Collection;this.queue=new R.Models.PriorityQueue;this.workerUrl=R.Utils.getWorkerUrl();this.dependencies=_.chain(Env.target.workerDependencies).map(function(group){return _.map(group[1],function(name){return group[0]+name})}).flatten().uniq().value()},onWorkAdded:function(){var worker=this.workers.find(function(worker){return!worker.has("work")});if(worker){this._findWork(worker)}else if(this.workers.length<this.poolSize){console.log("[Hive] Creating new worker in response to work");this.workers.add({worker:new Worker(this.workerUrl)})}},isUsable:function(){if(R.Services.HIVE_TESTING){return Modernizr.webworkers}else if(R.Services.TESTING){return false}return Modernizr.webworkers&&Modernizr.transferableobjects},_resetWorkTimeout:function(worker){if(worker.has("workTimeout")){clearTimeout(worker.get("workTimeout"));worker.unset("workTimeout")}},_workerMessageFactory:function(worker){return _.bind(function(e){this._resetWorkTimeout(worker);if(e.data&&e.data.err){worker.get("work").get("deferred").reject(new Error(e.data.err))}else{worker.get("work").get("deferred").resolve(e.data)}this._findWork(worker)},this)},_workerErrorFactory:function(worker){return _.bind(function(err){this._resetWorkTimeout(worker);if(worker.has("work")){worker.get("work").get("deferred").reject(err)}this._findWork(worker)},this)},_idleTimeoutFactory:function(worker){return _.bind(function(){console.log("[Hive] Worker timed out from idle");this.workers.remove(worker)},this)},_workTimeoutFactory:function(worker){return _.bind(function(){if(worker.has("work")){var timeoutError=new Error("Worker timed out on work");timeoutError.isTimeout=true;worker.get("work").get("deferred").reject(timeoutError)}this.workers.remove(worker)},this)},_doWork:function(worker,work){console.log("[Hive] Worker available: beginning work");if(worker.has("idleTimeout")){clearTimeout(worker.get("idleTimeout"));worker.unset("idleTimeout")}worker.set("work",work);work.set("for_web_worker",true);this.trigger("work",work);var data=work.get("data");var transferables;if(Modernizr.transferableobjects){transferables=_.filter(data,function(val){return Modernizr.typedarrays&&val instanceof ArrayBuffer});if(!transferables.length){transferables=undefined}}_.extend(data,{dependencies:this.dependencies});worker.get("worker").postMessage(data,transferables);worker.set("workTimeout",_.delay(this._workTimeoutFactory(worker),this.workTimeout))},_findWork:function(worker){worker.unset("work");if(this.queue.length>0){this._doWork(worker,this.queue.shift())}else{console.log("[Hive] Worker free: idling");worker.set("idleTimeout",_.delay(this._idleTimeoutFactory(worker),this.idleTimeout))}},request:function(work){if(!work.has("id")){throw new Error("Tried to request work from the Hive without a id")}var existing=this.queue.get(work.get("id"));if(existing){console.log("[Hive] Requester already had work in the queue: updating work");existing.set(work.attributes);return existing.get("deferred").promise()}work.set("deferred",$.Deferred());this.queue.add(work);return work.get("deferred").promise()},onWorkerAdded:function(worker){var onmessage=this._workerMessageFactory(worker);var onerror=this._workerErrorFactory(worker);worker.set({onmessage:onmessage,onerror:onerror});worker.get("worker").addEventListener("message",onmessage,false);worker.get("worker").addEventListener("error",onerror,false);this._findWork(worker)},onWorkerRemoved:function(worker){worker.get("worker").removeEventListener("message",worker.get("onmessage"),false);worker.get("worker").removeEventListener("error",worker.get("onerror"),false);worker.get("worker").terminate()},onWorkersReset:function(workers,options){_.each(options.previousModels,this.onWorkerRemoved)},onStopped:function(){this.workers.reset();this.workers.off();this.queue.reset();this.queue.off()},onStarted:function(k){this.workers.on("add",this.onWorkerAdded);this.workers.on("reset",this.onWorkersReset);this.queue.on("add",this.onWorkAdded);k()}});R.Services.register("Hive",{request:function(work){work.set("for_web_worker",false);work.set("fn",function(){var start=Date.now();var data=work.get("data");var res=R.Work[data.operation](data);var time=Date.now()-start;if(res){res[0].time=time;return res[0]}});var deferred=R.Services.Defer.defer(work);R.Services.Hive.trigger("work",work);return deferred}})}.call(this);!function(){R.Services.register("ABTest",{_optimizelyTests:{},_optimizelyLoaded:function(){var self=this;if(window.optimizely){this._optimizelyTests={};_.each(window.optimizely.data.experiments,function(experiment,id){if(experiment.name){self._optimizelyTests[experiment.name]=id}})}else{throw new Error("Optimizely loaded but doesn't exist on window!")}},onStarted:function(k){var self=this;window.optimizely=window.optimizely||[];window.optimizely.push(["activateSiteCatalyst"]);R.injectScript(R.serverInfo.get("optimizelyUrl"),null,function(){self._optimizelyLoaded();k()})},_getOptimizelyGroup:function(campaign){var self=this;var val=0;try{var testId=self._optimizelyTests[campaign];window.optimizely.push(["activate",testId]);val=window.optimizely.data.state.variationMap[testId]}catch(e){val=0}return val},getGroup:function(campaign){return this._getOptimizelyGroup(campaign)},recordSuccess:function(event){window.optimizely.push(["trackEvent",event])}})}();!function(){var NO_PROGRESS_MAX_COUNT=5;var MIN_PROGRESS_SECONDS=.75;var AudioWrapper=function(){};_.extend(AudioWrapper.prototype,Backbone.Events,{_failedToProgress:function(newPosition){return _.isNumber(this._lastPosition)&&newPosition<this._lastPosition+MIN_PROGRESS_SECONDS},onTimerTick:function(){if(!_.isNumber(this._noProgressCounter)){this._noProgressCounter=0}if(R.player.PLAYSTATE_PLAYING){var position=this.position();if(this._failedToProgress(position)&&!this._reportedNoProgress){this._noProgressCounter++;if(this._noProgressCounter>=NO_PROGRESS_MAX_COUNT){console.error("[AudioWrapper] Stream not making progress");this.trigger("profiling:noProgress");this.trigger("error","noProgress");this._reportedNoProgress=true}}this._lastPosition=position}}});AudioWrapper.extend=Backbone.View.extend;if(!R.Services._player_klasses){R.Services._player_klasses={}}R.Services._player_klasses.AudioWrapper=AudioWrapper}.call(this);!function($){var flashElementId="fallback";var AudioWrapper;R.Services.register("FallbackWrapper",{onInitialized:function(){},onStarted:function(k){this.readyCallback=k;this.needsStorage=R.storage.needsFallback;this.needsWebSockets=R.Services.WebSocketFactory.needsFallback;this.needsAudio=R.Services.AudioFactory&&(R.Services.AudioFactory.needsFallback||R.Services.AudioFactory.isDummy);if(this.needsStorage||this.needsWebSockets||this.needsAudio){this.embedSWF()}},onStopped:function(){$("#"+flashElementId).remove()},getItem:function(key){if(this.isReady()){return this._getSWF()._storage_getItem(key)}},setItem:function(key,value){if(this.isReady()){this._getSWF()._storage_setItem(key,value)}},removeItem:function(key){if(this.isReady()){this._getSWF()._storage_removeItem(key)}},clear:function(){if(this.isReady()){this._getSWF()._storage_clear()}},createWebSocket:function(url){var self=this;var fakeSocket={callbacks:{},url:url,addEventListener:function(event,k){this.callbacks[event]=k},removeEventListener:function(event){delete this.callbacks[event]},send:function(msg){self._getSWF()._websocket_send(msg)},close:function(){self._getSWF()._websocket_close()}};R.Services.ready("FallbackWrapper",function(){_.defer(function(){console.log("[FallbackWrapper] Flash websocket trying to connect to: ",url);self._getSWF()._websocket_connect(url)})});this._fakeSocket=fakeSocket;return fakeSocket},createAudio:function(options){return new AudioWrapper(this._getSWF,options)},needsFallback:function(){if(this.isReady()||this._embedding){return}this.embedSWF()},possiblyStillEmbeddingSWF:false,embedSWF:function(){if(this._embedding){return}console.log("[FallbackWrapper] Embedding fallback swf");this._embedding=true;var fallbackSetting=R.settings.get("flashObjects").fallbackSwf;if(!fallbackSetting){throw new Error("Missing fallback swf setting.")}var fallbackSWFUrl=R.Utils.getVersionedFlashUrl(fallbackSetting);var expressInstallUrl=R.serverInfo.get("media_address")+"flash/2/expressInstall.swf";var $parent=$("body");if($.browser.mozilla){$parent=$("html")}$parent.prepend('<div id="'+flashElementId+'" />');var self=this;this._websocket_internal={onMessage:function(data){if(self._fakeSocket&&self._fakeSocket.callbacks.message){var event={data:data};self._fakeSocket.callbacks.message(event)}},onOpen:function(){console.log("[FallbackWrapper] Flash websocket opened.");if(self._fakeSocket&&self._fakeSocket.callbacks.open){self._fakeSocket.callbacks.open()}},onClose:function(){console.log("[FallbackWrapper] Flash websocket connection closed by server.");if(self._fakeSocket&&self._fakeSocket.callbacks.close){self._fakeSocket.callbacks.close()}},onError:function(errorType){console.error("[FallbackWrapper] Flash websocket error of type: "+errorType);if(self._fakeSocket&&self._fakeSocket.callbacks.error){self._fakeSocket.callbacks.error()}self._addErrorSample(self._fakeSocket.url,errorType)}};this._audio_internal={onReady:function(id){clearTimeout(AudioWrapper.audioConnectTimeoutId);AudioWrapper.connectedAudio=true;if(AudioWrappers[id]){AudioWrappers[id]._ready=true;AudioWrappers[id].trigger("ready");AudioWrappers[id].trigger("profiling:loadeddata")}},onFailure:function(id,errorType){if(AudioWrappers[id]){AudioWrappers[id].trigger("profiling:flashError",errorType);AudioWrappers[id].trigger("error","FLASH")}},onBufferEmpty:function(id,errorType){if(AudioWrappers[id]){AudioWrappers[id].trigger("profiling:flashError",errorType)}},onEnd:function(id){if(AudioWrappers[id]){AudioWrappers[id].trigger("end")}}};var leftOffset=R.isDesktop?-1:0;if(R.Services.TESTING){return}_.defer(function(){if(window!=window.top){console.warn("[Rdio API] NOTE: The following permission error is an unavoidable yet harmless result of loading the Rdio audio playback Flash component inside the Rdio API iframe.")}swfobject.embedSWF(fallbackSWFUrl,flashElementId,"1","1","9",!R.isDesktop&&expressInstallUrl,{baseUrl:R.Utils.fullUrl("/"),scope:R.serverInfo.get("prod")?"prod":"dev",authorizationKey:R.currentUser.get("authorizationKey"),needsStorage:self.needsStorage?"true":"false",needsPubSub:self.needsWebSockets?"true":"false",needsAudio:self.needsAudio?"true":"false"},{wmode:"transparent",quality:"high",allowscriptaccess:"always"},{style:"visibility: visible; position: absolute; top: 0px; left: "+leftOffset+"px;"})});this._embedTimer=R.stats.createTimer("swf_embed");this._embedTimer.addFlashInfo();this._embedTimer.addEnvironmentInfo();this._embedTimer.addInteger("success",0);this._embedTimeoutId=setTimeout(function(){var succeeded=self.isReady();if(!succeeded){self._timeoutFiredTime=new Date;self.possiblyStillEmbeddingSWF=true;self.trigger("flashInitializationError")}if(self._embedTimer){if(succeeded){self._embedTimer.addInteger("success",1)}self._embedTimer.stop();self._embedTimer=null}},this._flashEmbedTimeout)},_flashEmbedTimeout:1e3*10,ready:function(){this.possiblyStillEmbeddingSWF=false;clearTimeout(this._embedTimeoutId);delete this._embedTimeoutId;if(this._embedTimer){this._embedTimer.addInteger("success",1);this._embedTimer.stop();this._embedTimer=null}this.readyCallback()},_getSWF:function(){if($.browser.msie){return window[flashElementId]}else{return document[flashElementId]}},_addErrorSample:function(url,errorType){if(Math.random()>.01){return}var sample=R.stats.createSample("racoon","websocket_errors");sample.setSamplingRule("websocket_errors");sample.addString("type","flash");sample.addString("flash_error",errorType);sample.addString("user",R.currentUser.get("key"));sample.addString("url",url);sample.addFlashInfo();sample.addEnvironmentInfo();sample.flush()},addFlashLagSample:function(){if(!this._timeoutFiredTime){return}var timeDrift=(new Date).getTime()-this._timeoutFiredTime.getTime();var sample=R.stats.createSample("racoon","flash_lag");sample.addString("delay",timeDrift);sample.addString("user",R.currentUser.get("key"));sample.addString("was_playing",R.player.playState()==R.player.PLAYSTATE_PLAYING);sample.addEnvironmentInfo();sample.flush()}});var AudioWrappers={};AudioWrapper=R.Services._player_klasses.AudioWrapper.extend({constructor:function(swf,options){this._getSWF=swf;this._preload=options.preload;var self=this;R.Services.ready("FallbackWrapper",function(){_.defer(function(){var optionsString="streamUrl: "+options.streamUrl;optionsString+=", streamHost: "+options.streamHost;optionsString+=", streamApp: "+options.streamApp;
console.log("[FallbackWrapper] Calling _audio_create with options: "+optionsString);self.id=self._getSWF()._audio_create(options);AudioWrappers[self.id]=self;AudioWrapper.audioConnectTimeoutId=setTimeout(function(){if(!AudioWrapper.connectedAudio){R.Services.FallbackWrapper.trigger("audioConnectionTimeout");self.trigger("error","FLASH")}},AudioWrapper.audioConnectTimeout);self.trigger("profiling:loadstart")})})},type:"flash",play:function(position){if(position===undefined){position=-1}else if(this._preload){delete this._preload;position=-1}console.log("[FallbackWrapper] Calling _audio_play");this._getSWF()._audio_play(this.id,position)},pause:function(){console.log("[FallbackWrapper] Calling _audio_pause");this._getSWF()._audio_pause(this.id)},position:function(){var pos=this._getSWF()._audio_position(this.id);return pos===-1?0:pos},seek:function(position){console.log("[FallbackWrapper] Calling _audio_seek with position: "+position);this._getSWF()._audio_seek(this.id,position)},volume:function(volume){console.log("[FallbackWrapper] Calling _audio_volume with volume: "+volume);this._getSWF()._audio_volume(this.id,volume)},destroy:function(){console.log("[FallbackWrapper] Calling _audio_destroy");this._getSWF()._audio_destroy(this.id);delete AudioWrappers[this.id];this.trigger("destroy")},isReady:function(){return this._ready}},{audioConnectTimeoutId:null,audioConnectTimeout:15*1e3,connectedAudio:false})}(R.$);!function(){_.extend(R.Router.routeMap,{"developers/":"Developer.Welcome","developers/create/":R.Router.routeIfHasFeature("Developer.Create","devsite"),"developers/your-apps/":R.Router.routeIfHasFeature("Developer.Apps","devsite"),"developers/app/(.{22})/":R.Router.routeIfHasFeature("Developer.App","devsite"),"developers/edit/(.{22})/":R.Router.routeIfHasFeature("Developer.Edit","devsite"),"developers/gallery/":"Developer.FeaturedGallery","developers/gallery/(.+)":R.Router.routeIfHasFeature("Developer.Gallery","devsite"),"developers/api-terms-of-use/":"Developer.TermsPage","developers/docs/(.*?)(/ref-.*)?":"Developer.Document"})}();!function(){R.rdioDevInit=function(){if(!R.Init.ensureDecentBrowser()){return}R.currentUser=new R.Models.CurrentUser(Env.currentUser);R.Init.setupGlobals();R.Init.installHeaderTags("link",R.Init.rdioFaviconLinkTags());R.Init.startApp("App.RdioDev")}}();!function(){R.Developer={allowBetaContent:function(){return!!R.currentUser.get("features").devsite&&!/nodevsite/i.test(location.hash)}}}();!function(){function getItems(data){if(!data){return[]}if(_.isArray(data)){return data}else if(data.models){return data.models}else if(data.apps){return data.apps}else{return data.items}}R.Models.SimpleCollection=Backbone.Collection.extend({parse:function(data){return getItems(data)},fetch:function(options){var args=_.toArray(arguments);if(!options||!options.reset){console.warn('Backbone.Collection#set is now the default updating mechanism after a fetch.\nIf you would like to use "reset", pass `{ reset: true }`.')}args[0]=options=_.defaults(options||{},{reset:true});this.deferred=Backbone.Collection.prototype.fetch.apply(this,args);return this.deferred},findByKey:function(key){return this.find(function(model){return model.get("key")===key})}},{factory:function(c){c=c||this;return function(data,options){var items=getItems(data);return new c(items,options)}}})}();!function(){R.Models.PriorityQueue=Backbone.Collection.extend({comparator:function(item){return item.get("priority")}})}.call(this);!function(){var ListItem=R.Models.ListItem=R.Model.extend({getSource:function(){return this.get("source")},isNew:function(){return this.getSource()===null}},{unwrap:function(model){if(model instanceof ListItem){return model.getSource()}else{return model}}});var wrapSource=function(item){if(item instanceof ListItem){return item}else if(_.isObject(item)&&_.isObject(item.source)){return new ListItem({source:R.Utils.convertToModel(item.source)})}else{return new ListItem({source:R.Utils.convertToModel(item)})}};var addSource=function(models,options){return this.add(_.map(R.Utils.array(models),wrapSource),options)};var SourceCollection=R.Models.SourceCollection=Backbone.Collection.extend({reset:function(models,options){models=this._wrapItems(models);return Backbone.Collection.prototype.reset.call(this,models,options)},addSource:addSource,getSourceKeys:function(){return this.map(function(item){return item.getSource().get("key")})},indexOf:function(find){if(find instanceof ListItem){return Backbone.Collection.prototype.indexOf.call(this,find)}var wrapped=this.find(function(model){return find===model.get("source")});if(!wrapped){return-1}return Backbone.Collection.prototype.indexOf.call(this,wrapped)},getUnwrappedCollection:function(){return new Backbone.Collection(this.map(ListItem.unwrap))},_wrapItems:function(items){return _.map(items,wrapSource)}});R.Models.ModelFieldSourceCollection=R.Models.ModelFieldCollection.extend({model:wrapSource,addSource:addSource,reviver:function(prop,value){return value},parse:function(response){var sourcesData=response[this._parentModel.get("key")][this._parentProperty];if(_.isNumber(sourcesData.total)){this.limit(sourcesData.total)}return _.map(sourcesData.items,function(sourceData){return{source:R.Utils.convertToModel(sourceData)}})},reset:function(models,options){models=_.map(models,wrapSource);return R.Models.ModelFieldCollection.prototype.reset.call(this,models,options)},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})}})}();!function(){R.Models.Comment=R.Model.extend({overrides:{commenter:"commenter",dateLastEdited:"dateLastEdited",commentedItem:"commentedItem"},method:{create:"createComment",update:"editComment","delete":"deleteComment"},content:{create:function(){return{object:this.get("commentedItem").get("key"),text:this.get("comment")}},update:function(){return{comment:this.get("key"),text:this.get("comment")}},"delete":function(){return{comment:this.get("key")}}},commenter:function(){if(!this._commenter){if(this.attributes.commenter){this._commenter=new R.Models.User(this.attributes.commenter)}else if(this.attributes.owner){this._commenter=new R.Models.User(this.attributes.owner)}}return this._commenter},commentedItem:function(){if(!this._commentedItem){if(this.attributes.commentedItem){this._commentedItem=R.Utils.convertToModel(this.attributes.commentedItem)}else if(this.attributes.reviewed_item){this._commentedItem=R.Utils.convertToModel(this.attributes.reviewed_item)}}return this._commentedItem},dateLastEdited:function(){if(this.attributes.dateLastEdited){return this.attributes.dateLastEdited}if(this.attributes.date){return this.attributes.date}},isOwner:function(){var commenter=this.get("commenter");return commenter&&commenter.get("key")==R.currentUser.get("key")}})}();!function(){var followStates=["approved","pending","hidden"];R.Models.User=R.Models.ObjectModel.extend({idAttribute:"key",overrides:{lastSongPlayed:R.Utils.convertToModelOverride("lastSongPlayed"),lastVideoPlayed:R.Utils.convertToModelOverride("lastVideoPlayed"),lastSourcePlayed:R.Utils.convertToModelOverride("lastSourcePlayed"),lastVideoSourcePlayed:R.Utils.convertToModelOverride("lastVideoSourcePlayed"),bigIcon:"bigIcon",topArtists:R.Models.ModelFieldCollection.extend({model:R.Models.Artist}),comments:R.Models.ModelFieldCollection.extend({model:R.Models.Comment,extras:["commentedItem"]})},bigIcon:function(){if(window.devicePixelRatio>1&&this.attributes.icon500){return this.attributes.icon500}else if(this.attributes.icon250){return this.attributes.icon250}return this.attributes.icon},getFullName:function(shouldEscape){var fullName=this.get("firstName")||"";if(fullName!==""&&this.get("lastName")){fullName+=" "}if(this.get("lastName")){fullName+=this.get("lastName")}fullName=fullName.trim();if(shouldEscape){fullName=Bujagali.Utils.escape(fullName)}return fullName},getTwitterId:function(){var twitterId=this.has("twitterUrl")?this.get("twitterUrl").replace(/.+\//,"@"):null;return twitterId},getQueueUrl:function(){return this.get("url")+"playing/"},getHistoryUrl:function(){return this.get("url")+"history/"},getPlaylistsUrl:function(){return this.get("url")+"playlists/"},getReviewsUrl:function(){return this.get("url")+"reviews/"},getFollowingUrl:function(){return this.get("url")+"people/following/"},getFollowersUrl:function(){return this.get("url")+"people/followers/"},getFavoritesUrl:function(){return this.get("url")+"favorites/"},getPurchasesUrl:function(subPage){return this.get("url")+"purchases/"},getDefaultSetUrl:function(shortName){var setType=R.Models.Set.getTypeFromShortName(shortName);if(setType){return this.get("url")+shortName+"/"}},getSetsUrl:function(){return this.get("url")+"sets/"},getCollectionUrl:function(subview,filter,sort,artist){var url=this.get("url")+"collection/";if(artist){url+=artist.slice(1)}if(subview&&subview!=="null"){url+=subview+"/"}else if(sort=="album"){sort=null}if(filter){url+="search/"+filter+"/"}if(sort){url+="sort/"+sort+"/"}return url},getUserStation:function(type){if(!this.get("stations")){console.warn("User has no stations");return null}if(!this._stations){var stations=this._stations={};_.each(this.get("stations"),function(station){stations[station.type]=new R.Models.Station(station)})}return this._stations[type]},isSelf:function(){return this.get("key")==R.currentUser.get("key")},getLastItemPlayed:function(){return this.getLastSourcePlayed(true)},getLastSourcePlayed:function(returnItem){var songPlayTime;var videoPlayTime;if(this.has("lastSongPlayTime")){songPlayTime=Bujagali.Utils.date(this.get("lastSongPlayTime"))}if(this.has("lastVideoPlayTime")){videoPlayTime=Bujagali.Utils.date(this.get("lastVideoPlayTime"))}if(R.serverInfo.get("vdioLaunched")&&videoPlayTime&&(!songPlayTime||videoPlayTime>songPlayTime)){return this.get(returnItem?"lastVideoPlayed":"lastVideoSourcePlayed")}else if(songPlayTime){return this.get(returnItem?"lastSongPlayed":"lastSourcePlayed")}return null},sendInvites:function(emails,options){options=options||{};_.defaults(options,{message:null,success:R.doNothing,error:R.doNothing});R.Api.request({method:"sendInvites",content:{contacts:emails,message:options.message},success:options.success,error:options.error})},share:function(users,object,options){options=_.extend({services:"rdio",message:null},options);if(users&&!_.isArray(users)){users=[users]}if(!(object.canShare&&object.canShare())){console.warn("Tried to share an unsharable object:",object);return}var emails=[];if(users){users=_.pluck(_.filter(users,function(user){if(_.isString(user)){emails.push(user);return false}return true}),"id")}R.Api.request({method:"shareItem",content:{key:object.get("key"),services:options.services,users:users,emails:emails,message:options.message,artistKey:options.artistKey},success:options.success,error:options.error})},canShareWith:function(){if(this.has("followsYou")&&this.has("canUnfollow")){return this.get("followsYou")===true&&this.get("canUnfollow")===true}else{throw new Error("User does not have 'followsYou' and 'canUnfollow', these are needed to determine if you can share")}},canShare:function(){return true},follow:function(){var self=this;var priorFollowingState=this.get("followingState");this.set("followingState",this.isProtected()?"pending":"approved");R.Api.request({method:"addFriend",content:{user:this.get("key")},complete:function(response){if(response.result){self.set("canUnfollow",true)}else{console.error("User model: follow failed: "+self.get("key"));self.set("followingState",priorFollowingState)}}});R.Services.ready("Omniture",function(){R.Services.Omniture.saveDataForNextNavigation(null,[{name:R.Services.Omniture.VAR.HAS_FOLLOWED,value:true}])})},unfollow:function(){var self=this;var data;R.Api.request({method:"removeFriend",content:{user:this.get("key")},success:function(results){data=results.result},complete:function(){self.set({followingState:data?null:self.get("followingState"),canUnfollow:false})}})},approve:function(){var self=this;var followerState=this.get("followerState");R.Api.request({method:"approveFollower",content:{user:this.get("key")},success:function(results){self.set(results.result)},error:function(){self.set("followerState",followerState)}});this.set("followerState","approved")},unapprove:function(){var self=this;var followerState=this.get("followerState");R.Api.request({method:"unapproveFollower",content:{user:this.get("key")},success:function(results){self.set(results.result)},error:function(){self.set("followerState",followerState)}});this.set("followerState","pending")},hide:function(){var self=this;var followerState=this.get("followerState");R.Api.request({method:"hideFollower",content:{user:this.get("key")},success:function(results){self.set(results.result)},error:function(){self.set("followerState",followerState)}});this.set("followerState","hidden")},canView:function(){var isProtected=this.isProtected();return this.isSelf()||!isProtected||isProtected&&this.get("followingState")==="approved"},isProtected:function(){return this.get("isProtected")?true:false},trackPresence:function(){if(!this._trackingPresence){var self=this;var topic=this.get("key")+"/presence";R.Services.ready("PubSub",function(){R.pubSub.subscribe(topic,self.onPresenceUpdate,self)});R.Services.ready("OfflineMonitor",function(){R.offlineMonitor.bind("change",self._onOnlineStatusChanged,self)});this._trackingPresence=1}else{this._trackingPresence++}return this},untrackPresence:function(){this._trackingPresence--;if(!this._trackingPresence){var topic=this.get("key")+"/presence";R.pubSub.unsubscribe(topic,this.onPresenceUpdate,this);R.offlineMonitor.unbind("change",this._onOnlineStatusChanged,this)}return this},hasTasteProfile:function(){return this.has("tasteProfileKey")&&this.get("tasteProfileKey").length>0},onPresenceUpdate:function(topic,data){switch(data.event){case"join":this.set("online",true);break;case"part":this.set("online",false);break;case"connectionJoin":if(!this._clients){this._clients={}}this._clients[data.id]=data.caps;this.trigger("connectionsChanged");break;case"connectionPart":if(!this._clients){return}if(this._clients[data.id]){delete this._clients[data.id]}this.trigger("connectionsChanged");break}},getCapability:function(cap,options){options=options||{};var splitCaps=cap.split(".");for(var key in this._clients){var data=this._clients[key];if(_.isUndefined(data)){continue}if(options.filter&&!options.filter(data)){continue}var val=this._getCapabilityWithSplit(splitCaps.slice(0),data);if(!_.isUndefined(val)){return val}}},_getCapabilityWithSplit:function(caps,data){var cap=caps.shift();if(_.has(data,cap)){if(_.isObject(data[cap])&&caps.length>0){return this._getCapabilityWithSplit(caps,data[cap])}else{return data[cap]}}},_onOnlineStatusChanged:function(){if(!R.offlineMonitor.isOnline()){this.set("online",false);this._clients={}}}},{profileFields:["location","twitterUrl","facebookUrl","facebookId","lastfmUrl","followerCount","followingCount","playlistCount","reviewCount","favoriteCount","setCount","collaboratingSetCount","stations","followsYou","albumCount","username","artistAccountMemberArtists"]})}();R.Models.CollaborativeModel=R.Models.ObjectModel.extend({overrides:{subscribers:R.Models.ModelFieldCollection,owner:R.Models.User},extras:["isSubscribed","isCollaborating","canCollaborate"],initialize:function(){R.Models.ObjectModel.prototype.initialize.apply(this,arguments);_.bindAll(this,"onSubscribersChanged","onCollaboratorsChanged");this._requestQueue=new R.ApiRequestQueue},save:function(attributes,options){var attributes=attributes||{};var options=options||{};_.extend(options,{wait:true});return R.Models.ObjectModel.prototype.save.call(this,attributes,options)},isCollaborating:function(){if(!this.has("isCollaborating")){console.error("Model missing attribute 'isCollaborating'.");return false}return this.get("isCollaborating")},isSubscribed:function(){if(!this.has("isSubscribed")){throw new Error("Model missing attribute 'isSubscribed'.")}return this.get("isSubscribed")},isOwner:function(){if(!this.get("owner")){throw new Error("Model missing attribute 'owner'.")}else if(this.get("owner").get("key")===null){throw new Error("Model owner missing attribute 'key'.")}return this.get("owner").get("key")===R.currentUser.get("key")},canEdit:function(){return false},getFilterComparator:function(){if(this.isOwner()){return this.get("name")}else{return[this.get("name"),this.get("owner").getFullName(true)].join(" ")}},getByOwnerString:function(linkTarget){return t("by [[ [owner] ]](link)",{owner:this.get("owner").getFullName(),link:{href:this.get("owner").get("url"),target:linkTarget||"_self"}})},onSubscribersChanged:function(topic,data){if(data.key!==R.currentUser.get("key")){return}if(data.event=="added"){this.set({isSubscribed:true})}else if(data.event=="removed"){this.set({isSubscribed:false})}},onCollaboratorsChanged:function(topic,data){if(data.key!==R.currentUser.get("key")){return}if(data.event=="added"){this.set({isCollaborating:true})}else if(data.event=="removed"){this.set({isCollaborating:false})}}},{CollaborationMode:{OFF:0,ALL:1,FOLLOWING:2},PublishedState:{PUBLIC:0,PRIVATE:1}});!function(){R.Models.Playlist=R.Models.CollaborativeModel.extend({method:{create:"createPlaylist",update:"updatePlaylistMetadata","delete":"deletePlaylist"},content:{create:function(){return _.extend({description:""},this.attributes)},update:function(){var attributes=_.pick(this.attributes,"name","description","isPublished","collaborationMode");attributes.playlist=this.get("key");return attributes},"delete":function(){return{playlist:this.get("key")}}},parse:function(attributes){var collection;if(attributes&&attributes.tracks){collection=new R.Models.SourceCollection([]);collection.addSource(attributes.tracks.models);attributes.tracks=collection}return attributes},overrides:_.defaults({canDownload:"canDownload",canStream:"canStream",canTether:"canTether",icon:"icon",bigIcon:"bigIcon",tracks:R.Models.ModelFieldSourceCollection},R.Models.CollaborativeModel.prototype.overrides),fieldConverter:{tracks:"onTracksChanged"},initialize:function(){R.Models.CollaborativeModel.prototype.initialize.apply(this,arguments);this._requestsInFlight=0;_.bindAll(this,"onRequestComplete","_updateSourcePosition")},add:function(model){if(R.Utils.value(model.canAddToPlaylist)){var keys=null;var self=this;if(model.get("type")=="a"||model.get("type")=="al"){keys=model.get("trackKeys")}else{keys=[model.get("key")]}var length=this.get("length");var hasLengthField=_.isNumber(length);var tracks=this.get("tracks");if(tracks&&hasLengthField&&length===tracks.length()){tracks.addSource(model)}if(hasLengthField){self.set("length",length+1)}if(tracks&&hasLengthField){tracks.limit(self.get("length"))}var apiRequest={method:"addToPlaylist",content:{playlist:this.get("key"),tracks:keys,extras:["-*","duration","Playlist.PUBLISHED","version","trackKeys"]},success:function(response){if(response.result){self.set(response.result)}}};this._queueRequest(apiRequest)}},remove:function(model,index){var self=this;var tracks=self.get("tracks");if(tracks&&tracks.at(index)){tracks.remove(tracks.at(index))}if(self.has("length")){self.set("length",self.get("length")-1)}var apiRequest={method:"removeFromPlaylist",content:{playlist:self.get("key"),index:index,count:1,tracks:[model.get("key")],extras:["-*","duration","Playlist.PUBLISHED","version","trackKeys"]},success:function(response){if(response.result){self.set(response.result)}},error:function(){self.set({tracks:tracks})}};this._queueRequest(apiRequest)},setCollaborating:function(collaborating){var self=this;var prevCollaborating=self.get("isCollaborating");self.set({isCollaborating:collaborating});R.Api.request({method:"setPlaylistCollaborating",content:{playlist:this.get("key"),collaborating:collaborating},error:function(){self.set({isCollaborating:prevCollaborating})}})},setPlaylistOrder:function(newTrackKeys){var self=this;var requestInfo={method:"setPlaylistOrder",content:{playlist:this.get("key"),tracks:newTrackKeys,extras:["-*","Playlist.PUBLISHED","version"]},success:function(response){if(response.result){self.set(response.result);self.set("trackKeys",newTrackKeys)}else{console.error("New playlist order not set")}}};this._queueRequest(requestInfo)},canShare:function(){return true},canDownload:function(){if(!this.has("price")){this.addField("price");this.fetch();return false}return this.get("price")!=="None"},canStream:function(){return true},canTether:function(){return true},canEdit:function(){return this.isOwner()||this.isCollaborating()},hasCustomArtwork:function(){return this.get("icon").indexOf("aid=")==-1},getPurchaseMessage:function(){return t(["You're about to purchase a playlist with [num] song.","You're about to purchase a playlist with [num] songs."],{num:this.get("length")})},onTracksChanged:function(prop,keys,fields){if(!this._requestQueue.isEmpty()||this._requestsInFlight){return}var localVersion=Bujagali.Utils.date(this.get("version"));var messageVersion=Bujagali.Utils.date(fields.version);if(localVersion&&messageVersion&&localVersion>=messageVersion){return}this.get("tracks").limit(keys.length);this.set("trackKeys",keys);this.set("length",keys.length);var sameTracks=_.all(keys,function(key,i){var listItem=this.get("tracks").models[i];if(!listItem){return false}var track=listItem.getSource();return track&&track.get("key")===key},this);var sameLength=keys.length===this.get("tracks").length();if(sameTracks&&sameLength){this._updateSourcePosition();return}var fetchDeferred=this.fetch({config:{extras:[{field:"tracks",start:0,count:keys.length}]}});var playingSource=R.player.playingSource();if(playingSource&&playingSource.get("key")===this.get("key")){fetchDeferred.done(this._updateSourcePosition)}},_updateSourcePosition:function(){var playingSource=R.player.playingSource();var playingTrack=R.player.playingTrack();var playingTrackKey=playingTrack&&playingTrack.get("key");var sourcePosition=R.player.sourcePosition();if(!playingSource||playingSource.get("key")!==this.get("key")){return}var newKeys=this.get("tracks").map(function(listItem){var track=listItem.getSource();return track&&track.get("key")});var newSourcePosition=_.indexOf(newKeys,playingTrackKey);if(newSourcePosition===-1&&R.player.isMaster()){R.player.play({source:this,index:sourcePosition})}else if(newSourcePosition>=0&&newSourcePosition!==sourcePosition){R.player.playingTrackWasMovedTo(newSourcePosition);this.set({currentPosition:newSourcePosition})}},_queueRequest:function(reqOptions){reqOptions.complete=this.onRequestComplete;this._requestQueue.push(reqOptions);this._requestsInFlight++;if(this._requestsInFlight===1){this.trigger("saving")}},onRequestComplete:function(){this._requestsInFlight--;if(this._requestsInFlight===0){this.trigger("saved")}}},{LABELS:{NEW:t("New Playlist"),CREATE:t("Create Playlist"),EDIT:t("Edit Playlist"),DELETE:t("Delete Playlist")},MESSAGES:{WARNING:{DELETE:t("Are you sure you want to delete this playlist? Once deleted, it can't be recovered.")},ERROR:{DELETE:t("There was a problem deleting this playlist.")},PRIVACY:{PUBLIC_DESCRIPTION:t("Anyone on [product_name] can see this playlist.",{product_name:R.serverInfo.get("product_name")}),PRIVATE_DESCRIPTION:t("Only people with a link can see this playlist.")}},ReasonNotViewable:{VIEWABLE:0,USER_PREFERENCE:1,ORDERED_ALBUM:2,TOO_FEW_SONGS:3}});_.extend(R.Models.Playlist.prototype,R.Mixins.IconOverrides)}();!function(){R.Models.LibraryCollection=function(user){this._user=user;this._offline={};this._online={};_.bindAll(this,"_refreshCollection");var self=this;R.Services.ready("Storage",function(){self._load()});if(!self._user.isAnonymous()){R.Services.ready("PubSub",function(){self._user.trackField("libraryVersion");self._user.bind("change:libraryVersion",self._refreshCollection);R.pubSub.bind("reconnect",self._refreshCollection)})}};_.extend(R.Models.LibraryCollection.prototype,Backbone.Events,{getKeysFromModel:function(model){if(R.Utils.isInstanceOf(model,R.Models.Playlist,R.Models.Track)){return[model.get("key")]}else if(R.Utils.isInstanceOf(model,R.Models.Album)&&model.has("trackKeys")){return model.get("trackKeys")}return[]},_keysForCollection:function(toAdd,add,offline){var keys;var containsFunction=offline?this.offlineContains:this.contains;var self=this;if(toAdd instanceof R.Model){keys=this.getKeysFromModel(toAdd)}else{keys=toAdd}return _.filter(keys,function(key){if(add){return!containsFunction.call(self,key)}return containsFunction.call(self,key)})},contains:function(o){return this._searchForKeys(o,false)},offlineContains:function(o){return this._searchForKeys(o,true)},getSummary:function(o){var keys=o;if(o instanceof R.Model){keys=this.getKeysFromModel(o)}if(!(keys instanceof Array)){keys=[keys]}var self=this;var keysInCollection=_.filter(keys,function(key){return self.contains([key])});return{inCollection:keysInCollection,setOffline:_.filter(keysInCollection,function(key){return self.offlineContains([key])})}},add:function(toAdd){this._triggerLibraryChange(toAdd,true,false,"addToCollection")},remove:function(toRemove){this._triggerLibraryChange(toRemove,false,false,"removeFromCollection")},offlineAdd:function(toAdd){this._triggerLibraryChange(toAdd,true,true,"setAvailableOffline")},offlineRemove:function(toRemove){this._triggerLibraryChange(toRemove,false,true,"setAvailableOffline")},isOfflineEmpty:function(){return _.isEmpty(this._offline)},_triggerLibraryChange:function(toAdd,add,offline,requestMethod){var self=this;var contentObj;var keys=this._keysForCollection(toAdd,add,offline);if(!keys.length){return}_.each(keys,function(key){if(offline){if(add){delete self._online[key];self._offline[key]=true}else{delete self._offline[key];self._online[key]=true}}else{if(add){self._online[key]=true}else{delete self._offline[key];delete self._online[key]}}});this._saveLibrary();this.trigger("changed",keys);contentObj={keys:keys};if(offline){contentObj.offline=add}R.Api.request({method:requestMethod,content:contentObj})},_saveLibrary:function(){try{R.storage.preserveIfNoSpace("/library/version");R.storage.setItem("/library/version",this._version);R.storage.setItem("/library/offline",_.keys(this._offline));R.storage.setItem("/library/online",_.keys(this._online))}catch(e){R.Utils.logException("Unable to save library",e);R.storage.removeItem("/library/version")}},_load:function(){if(R.currentUser.isAnonymous()){this._version=-1;this._online={};this._offline={};this._loaded=true;return}this._version=R.storage.getItem("/library/version");if(!this._version){this._version=-1;this._refreshCollection()}else{this._offline=this._dict(R.storage.getItem("/library/offline"));this._online=this._dict(R.storage.getItem("/library/online"));this._loaded=true;this._refreshCollection()}},_refreshCollection:function(){var self=this;R.Api.request({method:"getKeysInCollection",content:{version:this._version},success:function(data){var result=data.result;if(result.version!=self._version){self._version=result.version;self._offline=self._dict(result.offline);self._online=self._dict(result.online);self._saveLibrary()}self._loaded=true;self.trigger("loaded")}})},_searchForKeys:function(keys,offline){if(_.isUndefined(keys)||!this._loaded){return false}if(keys instanceof R.Model){keys=this.getKeysFromModel(keys)}if(!(keys instanceof Array)){keys=[keys]}for(var i=0;i<keys.length;i++){var key=keys[i];if(offline){if(!this._offline[key]){return false}}else{if(!this._online[key]&&!this._offline[key]){return false}}}return true},_dict:function(l){var r={};_.each(l,function(i){r[i]=true});return r}})}();!function(){R.Models.PaymentProfile=R.Model.extend({idAttribute:"profileId",method:{"delete":function(){return this.isPending()?"deletePendingPaymentProfile":"deletePaymentProfile"}},content:{"delete":function(){return{profileId:this.get("profileId")}}},getDisplayName:function(){var lastFour=this.get("lastFour");var type=this.get("profileTypeName");var expirationDate=this.get("expirationDate")||new Date;var displayName="";if(lastFour){if(this.isOi()){displayName=t("[type] for number ending with [lastFour]",{type:type,lastFour:lastFour})}else if(this.isPaypal()){displayName=t("PayPal account for [email]",{email:this.get("paypalEmail")})}else if(this.isPending()){displayName=t("Unverified: [type] for number ending with [lastFour]",{type:type,lastFour:lastFour})}else{displayName=t("[type] ending in [lastFour]",{type:type,lastFour:lastFour});if(expirationDate<=new Date){displayName+=" "+t("expired [expiration]",{expiration:R.Date.formatCreditCardDate(expirationDate)})}else{displayName+=" "+t("expires [expiration]",{expiration:R.Date.formatCreditCardDate(expirationDate)})}}}else{displayName+=this.get("profileTypeName")}if(this.get("defaultProfile")){displayName+=" ("+t("default")+")"}return displayName},isNew:function(){Backbone.Model.prototype.isNew.call(this)},isWallet:function(){return _.contains(["rdiowallet","vdiowallet"],this.get("profileShortName"))},getExpirationDays:function(){var expiryDate=Bujagali.Utils.date(this.get("expirationDate"));return Math.ceil((expiryDate.getTime()-Date.now())/R.Date.duration("1d"))},isRdioWallet:function(){return this.get("profileShortName")==="rdiowallet"},isVdioWallet:function(){return this.get("profileShortName")==="vdiowallet"},isOi:function(){return this.get("profileShortName")==="oi"},isPaypal:function(){return this.get("profileShortName")==="paypal"},isAmazon:function(){return this.get("profileShortName")==="amazon"},isPending:function(){return this.get("profileShortName")==="oiPending"},isExpiring:function(){if(!this.has("expirationDate")){return false}var now=new Date;var expiryDate=Bujagali.Utils.date(this.get("expirationDate"));return now.getMonth()===expiryDate.getMonth()&&now.getFullYear()===expiryDate.getFullYear()},isExpired:function(){if(!this.has("expirationDate")){return false}var endOfExpirationMonth=Bujagali.Utils.date(this.get("expirationDate"));endOfExpirationMonth.setMonth(endOfExpirationMonth.getMonth()+1);endOfExpirationMonth.setMilliseconds(-1);var now=new Date;return endOfExpirationMonth<now}},{FREE_PROFILE_ID:"-1"});R.Models.PaymentProfiles=R.Models.SimpleCollection.extend({model:R.Models.PaymentProfile,method:"getPaymentProfiles",shouldFetch:false,initialize:function(){R.Models.SimpleCollection.prototype.initialize.apply(this,arguments);if(!R.currentUser.isAnonymous()){var self=this;this.fetch();R.Services.ready("PubSub",function(){R.pubSub.subscribe(R.pubSub.userTopic(),_.bind(self.onUserPubSubMessage,self))});this._credit=R.currentUser.get("walletAvailableBalance");_.bindAll(this,"onUserAvailableBalanceChanged");R.currentUser.bind("change:rdioWalletAvailableBalance change:vdioWalletAvailableBalance",this.onUserAvailableBalanceChanged)}},fetch:function(){var self=this;this.loading=true;return R.Models.SimpleCollection.prototype.fetch.apply(this,arguments).always(function(){self.loading=false})},onUserPubSubMessage:function(topic,data){if(data.event){if(data.event=="paymentProfileDeleted"){var profile=this.get(data.id);this.remove(profile)}else if(data.event=="paymentProfileCreated"){this.fetch()}}},onUserAvailableBalanceChanged:function(){var credit=R.currentUser.get("walletAvailableBalance");var oldAmount=this._credit?parseFloat(this._credit.amount):0;var newAmount=credit?parseFloat(credit.amount):0;if(oldAmount==0&&newAmount>0||oldAmount>0&&newAmount==0){this.fetch()}this._credit=credit},comparator:function(a,b){if(a.isVdioWallet()){return-1}else if(b.isVdioWallet()){return 1}else if(a.isRdioWallet()){return 1}else if(b.isRdioWallet()){return-1}else{return a.get("profileId")>b.get("profileId")?1:-1}},getWallet:function(){return this.find(function(profile){return profile.isWallet()})},getDefault:function(){return this.find(function(profile){return profile.get("defaultProfile")})}})}();!function(){var SUGGESTION_SEARCH_DELAY=300;R.Models.SearchSuggestionsModel=R.Models.SimpleCollection.extend({method:"searchSuggestions",initialize:function(model,options){this.options=options;this._debounceFetch=_.debounce(this._debounceFetch,SUGGESTION_SEARCH_DELAY)
},content:function(config){return _.extend({query:this.searchTerm,types:this.options.types,extras:["type","location","username","directors","squareIcon","squareIcon104","itemCount","seasonCount","episodeCount","startDate","endDate",{field:"EpisodeRelease.series",extras:["-*","name"]},{field:"CollectionSet.items",extras:["-*","icon","icon500"],start:0,count:4},{field:"Franchise.content",extras:["-*","icon"],start:0,count:4},{field:"playCount",exclude:true},{field:"networkConsumers",exclude:true}],countryCode:R.Utils.value(this.options.countryCode)},config)},shouldFetch:function(){return this.searchTerm&&this.searchTerm.length>2},cancelFetch:function(){if(this.pendingFetch){this.pendingFetch.abort();this.pendingFetch=null}},_debounceFetch:function(){this.cancelFetch();if(this.shouldFetch()){var self=this;this.pendingFetch=this.fetch({success:function(){self.pendingFetch=null},error:function(){self.pendingFetch=null}})}},isDoneFetching:function(){if(_.isUndefined(this.pendingFetch)){return false}if(_.isNull(this.pendingFetch)){return false}return this.pendingFetch.statusText=="OK"},setSearchTerm:function(searchTerm){if(this.searchTerm!=searchTerm){this.searchTerm=searchTerm;if(this.shouldFetch()){this._debounceFetch()}else{this.reset()}}},parse:function(data){data.items=R.Utils.convertToModels(data.items);return R.Models.SimpleCollection.prototype.parse.call(this,data)}});R.Models.StationsSearchSuggestionsModel=R.Models.SearchSuggestionsModel.extend({method:"stationsSearchSuggestions",content:function(){var superContent=R.Models.SearchSuggestionsModel.prototype.content.apply(this,arguments);superContent.extras=_.extend(superContent.extras,["stations"]);return superContent}});R.Models.SearchModel=R.Models.SearchSuggestionsModel.extend({method:"search"})}();!function(){R.Models.Subscription=Backbone.Model.extend({initialize:function(){var type=this.get("type");var prices=R.serverInfo.get("prices");var attributes={cost:prices[type]};if(this.isFamilyPlan()){attributes["subaccount"]=prices["familySubaccount"];attributes["numDiscounted"]=prices["numDiscountedSubaccounts"]}this.set(attributes,{silent:true})},getPurchaseMessage:function(){if(this.isFamilyPlan()&&this.has("familySlots")&&this.get("familySlots")>R.Models.Subscription.INITIAL_FAMILY_SLOTS){return t("You're about to add a subscription to your family plan.")}return t("You're about to purchase a subscription to [product_name].")},isFamilyPlan:function(){return this.get("type")=="family"},familySubaccountPercentDiscount:function(accountNumber){if(!this.isFamilyPlan()||!accountNumber){return"0%"}var unlimitedCost=R.serverInfo.get("prices").unlimited;var accountCost=unlimitedCost;if(accountNumber==2){accountCost=this.get("cost")-unlimitedCost}else if(accountNumber<=this.get("numDiscounted")+1){accountCost=this.get("subaccount")}return I18n.percent(1-accountCost/unlimitedCost)},isEligibleForTrial:function(){return R.serverInfo.get("isNegativeOptionTrialPermitted")===true&&this.get("negativeTrial")===true},dueNow:function(){if(this.isEligibleForTrial()){return 0}return this.get("cost")},purchase:function(paymentId,options){R.Api.request({method:"purchaseSubscription",content:{paymentId:paymentId,subscriptionObject:JSON.stringify(this.attributes),negativeTrial:this.get("negativeTrial")&&this.isEligibleForTrial()},success:function(response){R.Payment.purchaseSuccess(response,options);R.Utils.addPixelTracking(R.serverInfo.get("pixelTracking").subscribed.dart);R.Utils.addPixelTracking(R.serverInfo.get("pixelTracking").subscribed.ampush)},error:function(response){R.Payment.purchaseError(response,options)}})}},{INITIAL_FAMILY_SLOTS:1})}();!function(){R.Models.SearchPageModel=R.Models.SparseCollection.extend({extras:function(){return["location","username","stations","description","icon250x375","icon500x750","icon250x333","icon500x667",{field:"series",extras:["-*","url","name"]}]},method:"search",content:function(config){return _.extend({query:this.options.searchTerm,types:this.options.types,extras:this.extras()},config)}});R.Models.HeavyRotation=R.Models.SparseCollection.extend({method:function(){if(this._loadTopAlbums){return"getTopCharts"}if(this.options.tuningParams||this.options.timeframe){return"getExperimentalHeavyRotation"}return"getHeavyRotation"},initialize:function(){this._loadTopAlbums=false;this.bind("loaded",this.onLoaded);this.bind("reset",this.onReset)},onLoaded:function(){if(this.options.allowTopAlbums){if(!this.length()&&!this._loadTopAlbums){this._loadTopAlbums=true;this.fetch()}}},onReset:function(){this._loadTopAlbums=false},content:function(config){if(this._loadTopAlbums){return _.extend({type:"Album",count:15},config)}if(this.options.tuningParams){config=_.extend({tuning:JSON.stringify(this.options.tuningParams)},config)}if(this.options.timeframe){config=_.extend({timeframe:this.options.timeframe},config)}return _.extend({friends:this.options.friends,user:this.options.userKey,count:this.options.count,type:this.options.type,extras:this.options.extras||[]},config)}});R.Models.NewReleasesModel=R.Models.SparseCollection.extend({method:"getNewReleases",content:function(config){return _.extend({type:this.options.type},config)}})}();!function(){R.Models.TopCharts=R.Models.SparseCollection.extend({method:"getTopCharts",content:function(config){return _.extend({type:this.options.type,count:this.options.count},config)}});var RecentActivityStory=R.Model.extend({overrides:{owner:R.Models.User,playlist:R.Models.Playlist}});R.Models.RecentActivityPageModel=R.Models.SparseCollection.extend({appendOnly:true,model:RecentActivityStory,method:"getActivityStream",hasFetchedToEnd:function(){return this.lastId===0},prepModel:function(attributes){if(_.indexOf([6,7,8,9],attributes.update_type)!=-1){return new R.Models.Comment(attributes)}else{return R.Models.SparseCollection.prototype.prepModel.apply(this,arguments)}},content:function(config){return _.extend({user:this.options.user,scope:this.options.scope},config)},parse:function(resp,xhr){this.lastId=resp.last_id;if(resp.updates){return resp.updates}return[]},reset:function(){this.lastId=null;R.Models.SparseCollection.prototype.reset.apply(this,arguments)}})}();!function(){R.Models.Track=R.Models.ObjectModel.extend({overrides:{radio:"radio",icon:"icon",bigIcon:"bigIcon",isPlayable:"isPlayable"},radio:function(){if("radio"in this.attributes){return new R.Models.Station(this.attributes.radio)}},isPlayable:function(){return true},canShare:function(){return true},canAddToPlaylist:function(){return true},getPurchaseMessage:function(){return t("You're about to purchase a song.")},getDefaultGridDisplayType:function(){return R.Components.Grid.display_types.LARGE_SQUARE_CAROUSEL},isVariousArtists:function(){return this.get("artistKey")===R.serverInfo.get("various_artist_key")}});_.extend(R.Models.Track.prototype,R.Mixins.IconOverrides);R.Models.TrackCollection=R.Models.SparseCollection.extend({model:R.Models.Track})}();!function(){R.Models.SocialMediaService=R.Model.extend({componentClass:"Onboarding.SocialMediaService",getDescription:function(){var name=this.get("name");var description;if(name==="facebook"){description=t("Find your friends.")}else if(name==="twitter"){description=t("Find people you follow.")}return description},getConnectingDescription:function(){var name=this.get("name");var description;if(name==="facebook"){description=t("Finding your friends...")}else if(name==="twitter"){description=t("Finding people you follow...")}return description},isConnected:function(){return R.currentUser.hasService(this.get("name"))}})}.call(this);!function(){var TOTAL="total";var AUTO="auto";var StatTreeModel=R.Model.extend({isEmpty:function(){return this.statFor()===R.Models.AdminBaseStat.MISSING},statFor:function(filters){var TOTAL=R.Models.AdminBaseStat.TOTAL;var MISSING=R.Models.AdminBaseStat.MISSING;var schema=this.get("schema");_.each(schema,function(item){filters[item]=filters[item]||TOTAL});var tree=this.get("tree");for(var i=0;i<schema.length;i++){if(!tree){return MISSING}tree=tree[filters[schema[i]]]}return tree||MISSING}});var StatTreeCollection=Backbone.Collection.extend({model:StatTreeModel,comparator:function(statTree){return statTree.get("date")}});R.Models.AdminBaseStat=R.Model.extend({method:"adminGetStats",periodOption:AUTO,statType:"",defaults:{startDate:"",endDate:"",keys:{},schema:[],trees:[]},overrides:{trees:StatTreeCollection},primaryProperties:{},content:function(config){return _.extend({statType:this.statType,periodOption:this.periodOption,startDate:this.get("startDate"),endDate:this.get("endDate")},config)},rowKeys:function(rowType,propertyKey){var all=this.get("keys")[propertyKey]||[];var defaults={region:[TOTAL].concat(this.get("offerGroups"),this.get("geographicGroups"),this.get("tier1Countries"))};var primaryProperties=$.extend({},defaults,this.primaryProperties);var primary=primaryProperties[propertyKey]||[];if(rowType==="primary"){return primary}else if(rowType==="secondary"){return _.difference(all,primary).sort()}return all.sort()}},{TOTAL:TOTAL,MISSING:0,REGION:"region",AUTO:AUTO,DAY:"daily",WEEK:"weekly",MONTH:"monthly"});R.Models.AdminRestrictedBaseStat=R.Models.AdminBaseStat.extend({method:"adminGetRestrictedStats"})}();!function(){R.Models.ObjectSearchModel=R.Models.SimpleCollection.extend({method:function(){if(this._customObjectSearch){return this._customObjectSearch}if(this._allowContainerKeyOrUrl){return"adminGetObjectsWithContainer"}return"adminGetObjects"},initialize:function(models,options){this._objectKeyOrUrl=options.objectKeyOrUrl;this._acceptedTypes=options.acceptedTypes;this._extras=options.extras;this._allowContainerKeyOrUrl=options.allowContainerKeyOrUrl;this._customObjectSearch=options.customObjectSearch;this._countryCode=options.countryCode},shouldFetch:function(){return _.isString(this._objectKeyOrUrl)},content:function(config){return _.extend({objectKeyOrUrl:this._objectKeyOrUrl,acceptedTypes:this._acceptedTypes,extras:this._extras,countryCode:this._countryCode},config)},setObjectKeyOrUrl:function(objectKeyOrUrl){this._objectKeyOrUrl=objectKeyOrUrl}})}();!function(){R.Payment={waitForAsyncPaymentComplete:function(ref,options){var checkStatus=function(cb){R.Api.request({method:"getAmazonChargeStatus",content:{caller_ref:ref},success:function(response){cb(response)},error:function(){if(options.error){options.error()}}})};var handleResponse=function(response){var result=response.result;if(!result.success||result.error){if(options.error){options.error()}}else if(result.charged){if(options.success){options.success()}}else{setTimeout(function(){checkStatus(handleResponse)},3e3)}};checkStatus(handleResponse)},purchaseSuccess:function(response,options){var result;if(response.result){result=response.result;if(result.async){R.Payment.waitForAsyncPaymentComplete(result.ref.caller_ref,options)}else{if(options.success){options.success(result)}}}},purchaseError:function(response,options){if(options.error){options.error(response)}}};R.Models.UserPrefs=R.Model.extend({initialize:function(attrs,options){var self=this;this._changedFields=[];this._reverseNameConversionTable={};_.each(this._nameConversionTable,function(val,key){self._reverseNameConversionTable[val]=key});if(attrs){this._convertFieldNames(attrs);this.attributes=attrs}R.Model.prototype.initialize.apply(this,arguments);this.bind("change",this._onPropertyChanged,this)},method:{create:"savePref"},content:{create:function(config){var self=this;var result={};_.each(this._changedFields,function(field){result[self._convertLongName(field)]=self.get(field)});this._changedFields=[];return{prefs:JSON.stringify(result)}}},_nameConversionTable:{sawSyncDialog:"s_sd",v_collection_artists_sidebar:"v_cas",fbShareWatch:"fb_w",fbShareFavorite:"fb_f",fbShareSets:"fb_s",closedWebclipPrompt:"c_wp",captionsEnabled:"ce",n_vdio_subscriber_promo:"n_vsp",player_footer_tooltip:"pf_tt",people_sidebar_tooltip:"ps_tt",hasVisitedRdioWeb:"hv_r",hasVisitedVdioWeb:"hv_v",showRdioOnboarding:"ob_r",showVdioOnboarding:"ob_v",tasteProfileTooltip:"tp_tt",recommendationsTooltip:"re_tt",adSupportedNotificationClosed:"as_nc",showHeavyRotationBanner:"hr_b"},_convertLongName:function(attribute){if(_.has(this._nameConversionTable,attribute)){return this._nameConversionTable[attribute]}else{return attribute}},_onPropertyChanged:function(){if(this._dontSave){return}this._changedFields=_.uniq(this._changedFields.concat(_.keys(this.changedAttributes())))},fieldUpdates:function(fields){this._dontSave=true;this._convertFieldNames(fields);this.set(fields);this._dontSave=false},_convertFieldNames:function(fields){_.each(this._reverseNameConversionTable,function(val,key){if(_.has(fields,key)){fields[val]=fields[key];delete fields[key]}})}});R.Models.CurrentUser=R.Models.User.extend({overrides:_.extend({},R.Models.User.prototype.overrides,{accountType:"accountType",prefs:R.Models.UserPrefs,paymentProfiles:R.Models.PaymentProfiles,subscriptionInfo:R.Models.Subscription,availableSubscriptions:"availableSubscriptions",walletAvailableBalance:"walletAvailableBalance"}),initialize:function(){var self=this;R.Models.User.prototype.initialize.apply(this,arguments);R.Services.ready("PubSub",function(){R.pubSub.subscribe(R.pubSub.userTopic(),_.bind(self.onPrivatePubSubMessage,self))});if(R.Models.LibraryCollection){this.collection=new R.Models.LibraryCollection(this)}this.trackPresence()},onPrivatePubSubMessage:function(topic,data){if(data.event&&data.event=="changed"){if(data.fields){if(_.has(data.fields,"prefs")){this.get("prefs").fieldUpdates(data.fields.prefs)}else{this.onFieldsChanged(topic,data)}}}if(data.event=="reloadBrowser"){R.reload()}},onDestroyed:function(){R.pubSub.unsubscribe(R.pubSub.userTopic(),this.onPrivatePubSubMessage);this.untrackPresence()},isAnonymous:function(){return this.get("isAnonymous")},accountType:function(){if(this.isAnonymous()){return"anonymous"}if(this.isFree()){return"freeLimited"}if(this.isInTrial()){return"trial"}if(this.isInFamilyPlan()){return"familyMember"}if(this.get("isAdSupported")){return"adSupported"}var type=null;if(this.isInComp()){type=this.compedAccountType()}else if(this.isSubscribed()){type=this.subscribedAccountType()}if(type=="family"){type="familyMaster"}if(!type){return"expired"}return type},isFree:function(){return this.get("isFree")},isInTrial:function(){if(!this.get("isTrial")||this.isSubscribed()){return false}var endDate=this.getTrialEndDate();if(!endDate){return true}return endDate>new Date},getTrialEndDate:function(){return Bujagali.Utils.date(this.get("trialEndDate"))},isInFamilyPlan:function(){var si=this.get("subscriptionInfo");if(!si){return false}return si.get("isInFamilyPlan")},isSubscribed:function(){var si=this.get("subscriptionInfo");if(!si){return false}return si.has("subscriptionType")&&si.get("subscriptionType")>0},subscribedAccountType:function(){if(!this.has("subscriptionInfo")){return null}var sub=this.get("subscriptionInfo");var subType=sub.get("subscriptionType");var provider=sub.get("provider");if(subType){if(provider&&provider=="familyplan"){return"familyMember"}return R.Utils.subNameForSubType(subType)}},isInComp:function(){if(!this.get("compSubscriptionType")){return false}var end=this.get("compEndDate");if(!end){return true}var endDate=Bujagali.Utils.date(end);var curDate=new Date;return endDate>curDate},isInLimitedComp:function(){return this.isInComp()&&!!this.get("compEndDate")},compedAccountType:function(){if(!this.isInComp()){return null}return R.Utils.subNameForSubType(this.get("compSubscriptionType"))},canPayWithAccountCredit:function(price){var balance=this.get("walletAvailableBalance");return balance&&price>0&&price<=balance.amount},hasSyncedModel:function(){return false},hasModelInCollection:function(model){return false},_getModelCollectionKeys:function(){},availableSubscriptions:function(){if(!this._availableSubscriptions){var types=R.serverInfo.get("availableSubscriptionTypes");var models=_.map(types,function(attributes){return new R.Models.Subscription(attributes)});this._availableSubscriptions=new Backbone.Collection(models)}return this._availableSubscriptions},getSubscription:function(subType){return this.availableSubscriptions().find(function(sub){return sub.get("type")==subType})},walletAvailableBalance:function(){return _.clone(this.attributes.rdioWalletAvailableBalance)}})}();!function(){R.Models.CollectionsBaseModel=R.Models.SimpleCollection.extend({_requiredFields:[],content:function(){return{extras:this._requiredFields}},initialize:function(models,options){R.Models.SimpleCollection.prototype.initialize.apply(this,arguments);_.bindAll(this,"onPubSubUpdate");if(!options.parentModel.isAnonymous()){this.fetch()}},userInviteMessage:function(){return""},serviceInviteMessage:function(){return""},onPubSubUpdate:function(topic,data){var self=this;var existingModel=this.findByKey(data.key);var notFoundErrorMessage="Model for key "+data.key+" was not found.";if(data.event==="added"){if(existingModel){return}existingModel=new this.model({key:data.key},{isNew:true,extras:this._requiredFields||[]});existingModel.fetch({success:function(model){var existingModel=self.findByKey(data.key);if(existingModel){return}self.add(model,{at:0})},error:function(){console.error(notFoundErrorMessage)}})}else if(data.event==="removed"){if(!existingModel){return}self.remove(existingModel)}}});var FollowingModel=R.Models.SimpleCollection.extend({model:R.Models.User,method:"userFollowing",_requiredUserFields:["-*","key","firstName","lastName","icon","url","playlistCount","followingState","followerCount"],shouldFetch:false,initialize:function(models,options){R.Models.SimpleCollection.prototype.initialize.apply(this,arguments);_.bindAll(this,"onFollowingChanged");if(options.parentModel.get("followingCount")&&!options.parentModel.isAnonymous()){this.fetch()}if(!options.parentModel.isAnonymous()){var self=this;var func=_.debounce(this.fetch,1e3);options.parentModel.on("change:followingCount",function(){func.call(self,{reset:false})})}},comparator:function(user){if(!R.currentUser.hasFeature("people_page")){var name=Bujagali.Utils.escape(user.getFullName());return name?name.toLowerCase():""}if(!user.get("lastSongPlayTime")){return 0}return-1*new Date(user.get("lastSongPlayTime")).getTime()},content:function(){return{user:R.currentUser.get("key"),count:R.currentUser.get("followingCount"),extras:this._requiredUserFields}},onFollowingChanged:function(topic,data){var self=this;var event=data.event;var friend;if(event=="added"){friend=new R.Models.User({key:data.key},{isNew:true,extras:this._requiredUserFields});friend.fetch({success:function(friend){if(self.get(friend.id)){return}self.add(friend)},error:function(){console.error("User for key "+data.key+" was not found.")}})}else if(event=="removed"){friend=self.get(data.key);if(!friend){console.error("User for key "+data.key+" was not found.");return}self.remove(friend)}},online:function(){return this.filter(function(person){return person.get("online")})},offline:function(){return this.filter(function(person){return!person.get("online")})}});R.Models.CurrentUser.Racoon=R.Models.CurrentUser.extend({extras:function(){return[]},initialize:function(){this._trackFollowingCounter=0;R.Models.CurrentUser.prototype.initialize.apply(this,arguments)},overrides:_.extend({},R.Models.CurrentUser.prototype.overrides,{following:FollowingModel,paymentProfiles:R.Models.PaymentProfiles}),getFeedUrl:function(){var subview=this.get("prefs").get("v_feed");if(subview){return"/"+subview+"/"}else{return"/"}},getChartsUrl:function(){var subview=this.get("prefs").get("v_charts"),base="/browse/charts/";if(subview){return base+subview+"/"}else{return base}},getPopularUrl:function(){var typePart=this.get("prefs").get("v_popular_type");var filterPart=this.get("prefs").get("v_popular_filter");var url="/popular/";if(filterPart&&filterPart!=="everyone"){url+=filterPart+"/"}if(typePart&&typePart!=="albums"){url+=typePart+"/"}return url},getPendingFollowersUrl:function(){return this.getFollowersUrl()+"pending/"},addFriends:function(friendKeys,k){if(!_.isArray(friendKeys)||!friendKeys.length){return}R.Api.request({method:"addFriends",content:{users:friendKeys},success:function(){if(_.isFunction(k)){k()}}})},getNewReleasesUrl:function(){var subview=this.get("prefs").get("v_releases"),base="/browse/new/";if(subview){return base+subview+"/"}else{return base}},getCollectionUrl:function(subview,filter,sort,artist){var prefs=this.get("prefs");subview=subview||prefs.get("v_collection");var sortPref=prefs.get("v_collection_sort");if(subview=="songs"){sortPref=prefs.get("v_collection_sort_songs")}sort=sort||sortPref;return R.Models.User.prototype.getCollectionUrl.call(this,subview,filter,sort,artist)},setProtected:function(){return R.Api.request({method:"setAccountPrivacy",content:{privacy:"protected"}})},setPublic:function(){return R.Api.request({method:"setAccountPrivacy",content:{privacy:"public"}})},isProtected:function(){return this.get("prefs").get("pr")?true:false},hasAccountCredit:function(){var balance=this.get("walletAvailableBalance");return balance&&parseFloat(balance.amount)},hasPurchased:function(itemKey,k){return R.Api.request({method:"hasPurchased",content:{item:itemKey},success:function(result){if(result&&result.result&&result.result.purchased){k(true)}else{k(false)}},error:function(){k(false)}})},hasSyncedModel:function(model){if(this.collection){var collectionSummary=this.collection.getSummary(model);var keys=this._getModelCollectionKeys(model);return collectionSummary&&keys.length>0&&keys.length===collectionSummary.setOffline.length}},hasSubscribedToModel:function(model){if(this.collection){var collectionSummary=this.collection.getSummary(model);var keys=this._getModelCollectionKeys(model);return collectionSummary&&keys.length>0&&keys.length===collectionSummary.inCollection.length&&model.get("type")==="p"&&!model.isOwner()}},hasModelInCollection:function(model){if(this.collection){var collectionSummary=this.collection.getSummary(model);var keys=this._getModelCollectionKeys(model);return collectionSummary&&keys.length>0&&keys.length===collectionSummary.inCollection.length&&model.get("type")!=="p"}},_getModelCollectionKeys:function(model){if(model.has("itemTrackKeys")){return model.get("itemTrackKeys")}else if(this.collection){return this.collection.getKeysFromModel(model)}},mustResolvePayment:function(){return this.get("hasSubscriptionFailure")||this.get("hasOutstandingPurchase")},services:function(){return new Backbone.Collection([{id:"suggested",name:t("Suggested users")},{id:"facebook",name:"Facebook",hasKey:"has_facebook",canInvite:true,hasInviteMode:true,basePermissions:R.settings.get("fbBasePerms")?R.settings.get("fbBasePerms").split(","):[]},{id:"twitter",name:"Twitter",hasKey:"has_twitter",url:R.serverInfo.get("urls").oauthTwitter},{id:"artist_twitter",name:t("Artist Twitter"),url:R.serverInfo.get("urls").oauthArtistTwitter,hasFriends:false},{id:"lastfm",name:"last.fm",hasKey:"has_lastfm",url:R.serverInfo.get("urls").oauthLastfm,hasFriends:false},{id:"gmail",name:"Gmail",url:R.serverInfo.get("urls").oauthGmailStart,email:true,canInvite:true},{id:"yahoo",name:"Yahoo",url:R.serverInfo.get("urls").oauthYahooStart,email:true,canInvite:true},{id:"aol",name:"Aol",email:true,canInvite:true},{id:"live",name:"Outlook.com",url:R.serverInfo.get("urls").oauthLiveStart,email:true,canInvite:true},{id:"email",name:t("Invite by email"),canInvite:true}])},hasService:function(id){var hasService=false;var service=this.services().get(id);if(service){hasService=!!this.get(service.get("hasKey"))}return hasService},hasFeature:function(feature){var features=this.get("features");return features&&features[feature]},getConnectedServices:function(){return this.services().reduce(function(list,service){var id=service.get("id");if(this.hasService(id)){list.push(id)}return list},[],this)},usesBothApps:function(){if(!R.serverInfo.get("vdioLaunched")){return false}return this.get("isRdioUser")&&this.get("isVdioUser")},trackFollowing:function(k){var self=this;if(this.isAnonymous()){console.error("[CurrentUser] Cannot trackFollowing() with an anonymous user.");return}this._trackFollowingCounter++;if(this._trackFollowingCounter>1){_.defer(k);return}var following=this.get("following");var followingTopic=this.get("key")+"/following";var complete=function(){following.off("reset",complete);R.pubSub.subscribe(followingTopic,following.onFollowingChanged);if(k){k()}};this._followingUnsubscribe=function(){R.pubSub.unsubscribe(followingTopic,following.onFollowingChanged)};if(following.length||!this.get("followingCount")){_.defer(complete)}else{following.on("reset",complete)}},untrackFollowing:function(){if(this._trackFollowingCounter===0){console.error("[CurrentUser] Not tracking following, so cannot untrack.");return}this._trackFollowingCounter--;if(this._trackFollowingCounter===0&&this._followingUnsubscribe){this._followingUnsubscribe();this._followingUnsubscribe=null}}})}();!function(){R.Models.Developer={};var displayPlatforms=function(supported_platforms){if(!supported_platforms){return"Unknown"}var value=supported_platforms.join(", ")||"None";return value.replace(/inRdio/g,"In Rdio")};R.Models.Developer.AppInfo=R.Model.extend({method:"getApplicationInfo",overrides:{currentUserOwns:"currentUserOwns",displayPlatforms:"displayPlatforms"},content:function(config){return _.extend({client_id:this.get("client_id"),extras:["ADMIN","developers","galleryImage"]},config)},currentUserOwns:function(){var found=false;var userKey=R.currentUser.get("key");var developers=this.get("developers");if(developers){found=!!developers.find(function(v,i){return v.get("key")==userKey})}return found},displayPlatforms:function(){return displayPlatforms(this.get("supported_platforms"))}});R.Models.Developer.Gallery=R.Model.extend({method:"getAppGallery",content:function(config){var platforms=this.get("platforms");return _.extend({platforms:platforms?platforms.join(","):"",sort:"popularity",start:0,count:100},config)},displayPlatforms:function(index){var items=this.get("items");var item=items?items[index]:null;return displayPlatforms(item?item.supported_platforms:null)}})}();
//# sourceMappingURL=/media/client/core.rdio-dev.d5084d38cd077c724e127011b5be6af6.js.map